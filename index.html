<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Historias Cl√≠nicas ‚Äì HealthIA Web</title>
  <!-- Tailwind -->
  <script>
    window.__API__ = {
      base: "https://api-tkuxk5r6rq-uc.a.run.app/api",
      resolveApiBase(){ return this.base; }
    };
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/firebase-init.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- SQLite reader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <!-- Firebase -->
<script>
(function () {
  // ----- utilidades seguras -----
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }
  // Detecta http/https y hace <a>‚Ä¶</a>
  function linkify(s){
    const urlRe = /https?:\/\/[^\s<]+/g;
    let out = "", last = 0;
    for (const m of String(s).matchAll(urlRe)) {
      out += escapeHtml(s.slice(last, m.index));
      const url = m[0];
      out += `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
      last = m.index + url.length;
    }
    out += escapeHtml(s.slice(last));
    return out;
  }

  function paintAppConfig(d){
    const banner  = document.getElementById('global-banner');
    const overlay = document.getElementById('maintenance-overlay');
    const mtext   = document.getElementById('maintenance-text');

    const msg   = (d && d.banner_text) ? String(d.banner_text) : "";
    const maint = !!(d && d.maintenance);

    // üëá usar innerHTML + linkify para que las URLs sean pulsables
    if (banner)  { banner.innerHTML  = linkify(msg); banner.classList.toggle('hidden', !msg); }
    if (overlay) { if (mtext) mtext.innerHTML = linkify(msg); overlay.classList.toggle('hidden', !maint); }

    window.APP_CFG = d || {};

    console.log("[app-config] render =>", { maint, msg });
  }

  function start(){
    const { firestore, doc, onSnapshot } = window;
    if (!firestore || !doc || !onSnapshot) {
      console.warn("[app-config] Firestore no listo (reintentando en 300ms)");
      return setTimeout(start, 300);
    }
    const ref = doc(firestore, 'config', 'app');
    onSnapshot(ref,
      (snap)=>paintAppConfig(snap.exists()? snap.data(): {}),
      (err)=>console.error("[app-config] onSnapshot error", err)
    );
  }

  document.addEventListener('DOMContentLoaded', start);
})();
</script>




  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#e9fbf6',100:'#c9f4e8',200:'#9fe8d4',300:'#6fd7be',400:'#3fc3a8',
              500:'#10a37f',600:'#0d8568',700:'#0b6a56',800:'#0a5646',900:'#083e33'
            }
          },
          boxShadow: { soft:'0 10px 30px rgba(16,163,127,.08)'}
        }
      }
    }
  </script>
  <style>
  :root{
    --brand-50:#e9fbf6;--brand-100:#c9f4e8;--brand-200:#9fe8d4;--brand-300:#6fd7be;--brand-400:#3fc3a8;
    --brand-500:#10a37f;--brand-600:#0d8568;--brand-700:#0b6a56;--brand-800:#0a5646;--brand-900:#083e33;
    --gray-50:#f8fafc;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-700:#374151;
  }
  html, body { height: 100%; }
  body { margin:0; background: #f6f7fb; color:#0f3b2e; font-synthesis-weight: none; }
  .app { height: 100dvh; }
  *,
  *::before,
  *::after { box-sizing: border-box; }
  /* CONTENEDOR PRINCIPAL */
  .app-shell{width:100%;max-width:1600px;margin:0 auto;padding:16px 20px;}
  /* COMPONENTES */
  .card{background:#fff;border:1px solid #d9efe3;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.04);padding:16px;}
  .card>.card-title{font-weight:700;color:var(--brand-800);margin-bottom:.75rem}
  /* BOTONES UNIFORMES */
  .btn{display:inline-flex;align-items:center;justify-content:center;text-align:center;gap:.4rem;height:36px;padding:0 12px;border-radius:8px;border:1px solid var(--brand-500);background:transparent;color:var(--brand-700);font-weight:600;font-size:.8rem;cursor:pointer;transition:background .15s ease,transform .05s ease;}
  .btn:hover{background:var(--brand-50);}
  .btn:active{transform:translateY(1px);}
  .btn:disabled{opacity:.6;cursor:not-allowed;}
  .btn--danger{border-color:#ef4444;color:#b91c1c;}
  .btn--danger:hover{background:#fef2f2;}
  .btn .ic{font-size:1rem;line-height:1;}
  .btn-icon{width:24px;height:24px;padding:0;}
  td.actions{display:flex;gap:4px;justify-content:center;}
  /* INPUTS */
  .input,select,textarea{width:100%;height:44px;padding:10px 12px;border:1px solid #cfe9df;border-radius:10px;background:#f9fdfa;outline:none;}
  .outbox{width:100%;padding:10px 12px;border:1px solid #cfe9df;border-radius:10px;background:#f9fdfa;min-height:15rem;white-space:pre-wrap;}
  .input::placeholder{color:#9aa3b2}
  .input:focus,select:focus,textarea:focus{border-color:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,0.15);}
  .sv-wrap{position:relative;}
  .sv-light{position:absolute;top:50%;right:8px;width:10px;height:10px;border-radius:50%;transform:translateY(-50%);background:#d1d5db;}
  .sv-light.green{background:var(--brand-500);}
  .sv-light.yellow{background:#facc15;}
  .sv-light.red{background:#ef4444;}
  .label{display:block;font-size:.9rem;font-weight:700;color:#0b6a56;margin-bottom:.35rem}
  .section-title{font-size:1rem;font-weight:800;color:var(--brand-900)}
  table{width:100%;border-collapse:collapse}
  thead th{background:var(--gray-50);font-weight:700;color:#374151}
  th,td{padding:.6rem .5rem;border-bottom:1px solid #eee;text-align:left}
  #daily-print table{border-collapse:collapse;width:100%;}
  #daily-print th,#daily-print td{border:1px solid #000;padding:4px;font-size:.75rem;}
  #daily-print th{text-align:center;font-weight:700;}
  #daily-print .diag{white-space:pre-wrap;text-align:justify;}
  /* Layout helpers */
  .stack{display:grid;gap:.75rem}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  @media (max-width:640px){.grid-2{grid-template-columns:1fr}}
  /* GRID Y FORM */
  .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
  .form-grid .col-3{grid-column:span 3;min-width:220px;}
  .form-grid .col-4{grid-column:span 4;min-width:260px;}
  .form-grid .col-6{grid-column:span 6;min-width:320px;}
  .form-grid .col-12{grid-column:span 12;}
  @media (max-width:1200px){.form-grid{grid-template-columns:repeat(8,1fr);}}
  @media (max-width:860px){.form-grid{grid-template-columns:repeat(4,1fr);}}
  .block-title{font-weight:800;color:#064e3b;text-align:center;margin:6px 0 12px 0;border-bottom:1px solid #e2e8f0;padding-bottom:8px;}
  /* Gutters m√°s estrechos entre columnas */
  .grid-gutters{gap:12px;}
/* ====== Grillas ====== */
  .actions-grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  }
  @media (max-width:1024px){ .actions-grid{grid-template-columns:repeat(2,1fr);} }
  @media (max-width:640px){ .actions-grid{grid-template-columns:1fr;} }

/* botones superiores (Nuevo/Editar/Eliminar) en 3 columnas iguales */
.top-actions{
  display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;
}

  /* CHAT POPUP */
  .dialog-full{width:100vw;height:100vh;max-width:none;margin:0;padding:0;border:none;}
  .dialog-full[open]{top:0;left:0;}
  .dialog-full::backdrop{background:rgba(0,0,0,.3);}
  .chat-box{display:flex;flex-direction:column;gap:.5rem;}
  .chat-msg{display:flex;}
  .chat-msg--ai{justify-content:flex-start;}
  .chat-msg--user{justify-content:flex-end;}
  .chat-bubble{padding:8px 12px;border-radius:14px;max-width:80%;white-space:pre-wrap;}
  .chat-msg--ai .chat-bubble{background:#e5e7eb;color:#0f3b2e;}
  .chat-msg--user .chat-bubble{background:#c9f4e8;color:#064e3b;}
  .chat-copy{margin-left:4px;color:#0d8568;border:none;background:none;cursor:pointer;font-size:.8rem;}
  textarea.input{height:auto;min-height:44px;}

</style>
</head>
<body>

<!-- Banner global -->
<div id="global-banner" class="hidden w-full bg-yellow-50 text-yellow-800 text-center py-2 text-sm"></div>

<!-- Overlay de mantenimiento -->
<div id="maintenance-overlay" class="hidden fixed inset-0 z-[9999] bg-white/90 backdrop-blur-sm flex items-center justify-center">
  <div class="max-w-md w-[90%] p-6 bg-white border border-[#cfe9df] rounded-xl shadow-soft text-center">
    <div class="text-3xl mb-3">üõ†Ô∏è</div>
    <h2 class="text-xl font-bold text-[#0b6a56] mb-2">Estamos en mantenimiento</h2>
    <p id="maintenance-text" class="text-gray-700">Volvemos en breve‚Ä¶</p>
  </div>
</div>


<div class="hidden">
  <textarea id="antecedentes_personales"></textarea>
  <textarea id="antecedentes_familiares"></textarea>
  <input id="presion_arterial">
  <input id="frecuencia_cardiaca">
  <input id="frecuencia_respiratoria">
  <input id="temperatura">
  <input id="saturacion_oxigeno">
</div>
<section id="view-intro" class="fixed inset-0 flex items-center justify-center bg-white z-50">
  <div class="text-center space-y-4">
    <div id="intro-msg" class="text-xl font-semibold text-brand-800"></div>
    <div class="w-64 bg-gray-200 rounded-full h-3 mx-auto">
      <div id="intro-progress" class="bg-brand-500 h-3 rounded-full" style="width:0%"></div>
    </div>
  </div>
</section>
<div id="app" class="app flex flex-col">
  <!-- TOPBAR -->
  <header id="topbar" class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="app-shell h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand-500 text-white grid place-content-center text-xl shadow-soft"><i class="fa-solid fa-stethoscope"></i></div>
        <div>
          <h1 class="text-xl font-bold leading-5">Sistema de Historias Cl√≠nicas</h1>
          <p class="text-xs text-gray-500 -mt-0.5">HealthIA Web ‚Äì tu historia cl√≠nica en un clic</p>
        </div>
      </div>
      <div id="top-controls" class="flex items-center gap-2 hidden">
        <button id="btn-user" class="btn"><i class="ic fa-solid fa-user"></i><span id="top-username">Invitado</span></button>
        <button id="btn-config" class="btn"><i class="ic fa-solid fa-gear"></i> Config</button>
        <div class="flex items-center gap-3">
          <div class="text-sm text-gray-600">
            Plan: <span id="plan-state" class="font-medium">‚Äî</span>
          </div>
          <button id="btn-toggle-sub" type="button" class="btn">Comprar suscripci√≥n</button>
        </div>

        <button id="btn-logout" class="btn">Salir</button>
      </div>
    </div>
  </header>

  <!-- LOGIN VIEW -->
  <section id="view-auth" class="h-full grid place-items-center p-4 hidden">
    <div class="card w-full max-w-2xl p-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl bg-brand-500 text-white grid place-content-center text-xl"><i class="fa-solid fa-lock"></i></div>
        <div>
          <h2 class="text-2xl font-bold">Iniciar sesi√≥n</h2>
          <p class="text-sm text-gray-500">Primero login; luego podr√°s abrir configuraci√≥n.</p>
        </div>
      </div>
      <div id="tip-admin" class="hidden p-3 rounded-lg bg-brand-50 text-brand-900 text-sm mb-4">Crea primero un usuario <b>admin</b>.</div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div><label class="label">Correo electr√≥nico</label><input id="auth-user" type="email" class="input" autocomplete="email"></div>
        <div><label class="label">Contrase√±a</label><input id="auth-pass" type="password" class="input" autocomplete="current-password"></div>
      </div>
      <div class="flex items-center justify-between mt-3 text-sm">
        <label class="inline-flex items-center gap-2"><input id="remember" type="checkbox" class="rounded"> Recordar</label>
        <button id="open-recover" class="text-brand-700 hover:underline">Recuperar contrase√±a</button>
      </div>
      <div class="mt-6 flex gap-3">
        <button id="login" class="btn">Entrar</button>
        <button id="open-register" class="btn">Registrarse</button>
      </div>
      <div class="mt-4 grid sm:grid-cols-2 gap-3">
        <button id="login-google" class="btn w-full"><i class="fa-brands fa-google"></i> Google</button>
        <button id="login-phone" class="btn w-full"><i class="fa-solid fa-phone"></i> Tel√©fono</button>
      </div>
    </div>
  </section>

  <!-- APP VIEW -->
  <section id="view-app" class="hidden flex-1">
    <main class="app-shell">
        <div class="grid grid-cols-12 gap-4 py-3">
        <!-- LEFT COLUMN -->
        <aside class="col-span-12 xl:col-span-6 space-y-3">
        
<div class="card p-4">
  <div class="grid grid-cols-3 gap-3">
    <div class="col-span-2">
      <input id="q-name" class="input" placeholder="Nombre o ID del paciente">
    </div>
    <button id="q-search" class="btn"><i class="ic fa-solid fa-magnifying-glass"></i> Buscar Paciente</button>
  </div>

    <div class="mt-3 top-actions">
      <button id="p-new" class="btn"><i class="ic fa-solid fa-user-plus"></i> Nuevo Paciente</button>
    <button id="p-edit" class="btn" disabled><i class="ic fa-solid fa-pen"></i> Editar Paciente</button>
    <button id="p-del" class="btn btn--danger" disabled><i class="ic fa-solid fa-trash"></i> Eliminar Paciente</button>
    </div>
  </div>


        
        <div class="card mt-3">
          <div class="flex items-center gap-3 mb-3">
            <div class="label mb-0">Filtrar por fecha:</div>
            <input id="f-date" type="date" data-cal class="input max-w-[180px]" />
            <button id="f-apply" class="btn"><i class="ic fa-solid fa-filter"></i> Filtrar</button>
            <button id="p-all" class="btn"><i class="ic fa-solid fa-list"></i> Cargar Todos</button>
            <button id="p-appts" class="btn"><i class="ic fa-solid fa-calendar-day"></i> Citas</button>
          </div>
          <div class="overflow-y-auto rounded-xl border border-gray-200 max-h-60">
            <table>
              <thead><tr><th class="w-16">ID</th><th>Nombre</th><th class="w-24">Cita</th><th class="w-20"></th></tr></thead>
              <tbody id="tbl-patients"></tbody>
            </table>
          </div>
        </div>

        <div class="card mt-3">
          <div class="flex items-center justify-between mb-2">
            <h3 class="section-title mb-0">Historias Cl√≠nicas</h3>
            <button id="h-new" class="btn"><i class="ic fa-solid fa-file-circle-plus"></i> Crear Historia</button>
          </div>
          <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
        </div>

<div class="card mt-3">
  <div class="block-title">Acciones del Sistema</div>
  <div class="actions-grid">
    <button class="btn" id="act-appointments"><i class="ic fa-solid fa-calendar-check"></i> Citas</button>
    <button class="btn" id="act-reminders"><i class="ic fa-solid fa-bell"></i> Recordatorios</button>
    <button class="btn" id="act-billing"><i class="ic fa-solid fa-file-invoice-dollar"></i> Facturaci√≥n</button>
    <button class="btn" id="act-daily"><i class="ic fa-solid fa-calendar-day"></i> Informe Diario</button>
  </div>
</div>
      </aside>

        <!-- RIGHT COLUMN -->
        <section class="col-span-12 xl:col-span-6 space-y-3">
        <div class="card p-4">
          <h3 class="section-title mb-3">Informaci√≥n del Paciente</h3>
          <div class="flex gap-4">
            <div id="info-avatar" class="w-14 h-14 rounded-full overflow-hidden bg-gradient-to-br from-brand-50 to-brand-200 shadow-md ring-2 ring-brand-300 ring-offset-2 ring-white"></div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm flex-1">
              <div><span class="font-semibold">Nombre:</span> <span id="info-nombre"></span></div>
              <div><span class="font-semibold">Edad:</span> <span id="info-edad"></span></div>
              <div><span class="font-semibold">Sexo:</span> <span id="info-sexo"></span></div>
              <div><span class="font-semibold">C√©dula / ID:</span> <span id="info-doc"></span></div>
              <div><span class="font-semibold">Fecha Nac.:</span> <span id="info-fecha"></span></div>
              <div><span class="font-semibold">Nacionalidad:</span> <span id="info-nac"></span></div>
              <div><span class="font-semibold">Alergias:</span> <span id="info-alergias"></span></div>
              <div><span class="font-semibold">Tel√©fono:</span> <span id="info-tel"></span></div>
              <div><span class="font-semibold">Direcci√≥n:</span> <span id="info-dir"></span></div>
              <div><span class="font-semibold">Ocupaci√≥n:</span> <span id="info-ocup"></span></div>
              <div><span class="font-semibold">Medicamentos:</span> <span id="info-medfijos"></span></div>
              <div><span class="font-semibold">ARS:</span> <span id="info-ars"></span></div>
              <div><span class="font-semibold">Religi√≥n:</span> <span id="info-religion"></span></div>
              <div><span class="font-semibold">Tipo Sangre:</span> <span id="info-sangre"></span></div>
              <div><span class="font-semibold">Altura:</span> <span id="info-altura"></span></div>
              <div class="col-span-2"><span class="font-semibold">Dx Previos:</span> <span id="info-dxprev"></span></div>
            </div>
          </div>
        </div>

        <div class="card p-4" id="card-ap">
          <div class="flex items-center justify-between mb-3">
            <h3 class="section-title">Antecedentes Personales</h3>
            <button type="button" class="btn btn-icon collapse-btn" data-target="ap-body"><i class="fa-solid fa-minus"></i></button>
          </div>
          <div id="ap-body" class="grid md:grid-cols-2 gap-3">
            <div><label class="label">Cigarrillo</label><input id="ap-cig" class="input"/></div>
            <div><label class="label">Alcohol</label><input id="ap-alc" class="input"/></div>
            <div><label class="label">Drogas</label><input id="ap-dro" class="input"/></div>
            <div><label class="label">Caf√©</label><input id="ap-cafe" class="input"/></div>
            <div><label class="label">T√©</label><input id="ap-te" class="input"/></div>
            <div class="md:col-span-2"><label class="label">Patolog√≠as cr√≥nicas</label><input id="ap-cron" class="input"/></div>
            <div class="md:col-span-2 grid md:grid-cols-3 gap-3">
              <div><label class="label">A. Transfusionales</label><input id="ap-trans" class="input"/></div>
              <div><label class="label">A. Traum√°tico</label><input id="ap-traum" class="input"/></div>
              <div><label class="label">A. Quir√∫rgicos</label><input id="ap-quir" class="input"/></div>
            </div>
          </div>
        </div>

        <div class="card p-4" id="card-ah">
          <div class="flex items-center justify-between mb-3">
            <h3 class="section-title">Antecedentes Heredo-Familiares</h3>
            <button type="button" class="btn btn-icon collapse-btn" data-target="ah-body"><i class="fa-solid fa-minus"></i></button>
          </div>
          <div id="ah-body" class="grid md:grid-cols-2 gap-3">
            <div><label class="label">Padre</label><input id="ah-padre" class="input"/></div>
            <div><label class="label">Madre</label><input id="ah-madre" class="input"/></div>
            <div><label class="label">Hijos</label><input id="ah-hijos" class="input"/></div>
            <div><label class="label">Hermanos</label><input id="ah-hermanos" class="input"/></div>
          </div>
        </div>

        <div id="card-ob" class="card p-4 hidden">
          <div class="flex items-center justify-between mb-3">
            <h3 class="section-title">Antecedentes Gineco-Obst√©tricos</h3>
            <div class="flex items-center gap-2"><button type="button" id="ega-open" class="btn">Calculadora obst√©trica</button><button type="button" class="btn btn-icon collapse-btn" data-target="ob-body"><i class="fa-solid fa-minus"></i></button></div></div>
          <div id="ob-body" class="grid md:grid-cols-2 gap-3">
            <div><label class="label">Gesta</label><input id="go-gesta" class="input"/></div>
            <div><label class="label">Partos</label><input id="go-partos" class="input"/></div>
            <div><label class="label">Ces√°reas</label><input id="go-cesa" class="input"/></div>
            <div><label class="label">Abortos</label><input id="go-aborto" class="input"/></div>
            <div><label class="label">Fecha de sonograf√≠a</label><input id="go-sono" type="date" data-cal class="input"/></div>
            <div><label class="label">Semana de embarazo</label><input id="go-semana" class="input" readonly></div>
          </div>
        </div>

        <div id="card-vitals" class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="section-title"><i class="ic fa-solid fa-stethoscope"></i> Signos Vitales</h3>
            <button type="button" class="btn btn-icon collapse-btn" data-target="vitals-body"><i class="fa-solid fa-minus"></i></button>
          </div>
          <div id="vitals-body">
          <div class="grid md:grid-cols-7 gap-3">
            <div><label class="label">PA</label><div class="sv-wrap"><input id="v-pa" class="input pr-6" placeholder="mmHg"><span id="sv-pa" class="sv-light"></span></div></div>
            <div><label class="label">FC</label><div class="sv-wrap"><input id="v-fc" class="input pr-6" placeholder="lpm"><span id="sv-fc" class="sv-light"></span></div></div>
            <div><label class="label">FR</label><div class="sv-wrap"><input id="v-fr" class="input pr-6" placeholder="rpm"><span id="sv-fr" class="sv-light"></span></div></div>
            <div><label class="label">Glicemia</label><div class="sv-wrap"><input id="v-gli" class="input pr-6"><span id="sv-gli" class="sv-light"></span></div></div>
            <div><label class="label">Colesterol</label><div class="sv-wrap"><input id="v-col" class="input pr-6"><span id="sv-col" class="sv-light"></span></div></div>
            <div><label class="label">Oximetr√≠a</label><div class="sv-wrap"><input id="v-oxi" class="input pr-6" placeholder="%"><span id="sv-oxi" class="sv-light"></span></div></div>
            <div><label class="label">Temp</label><div class="sv-wrap"><input id="v-temp" class="input pr-6" placeholder="¬∞C"><span id="sv-temp" class="sv-light"></span></div></div>
          </div>
          <div class="grid md:grid-cols-4 gap-3 mt-3">
            <div class="md:col-span-2">
              <label class="label">Peso</label>
              <div class="flex gap-2">
                <input id="v-peso" type="number" class="input">
                <select id="v-unit" class="input w-24"><option value="kg">kg</option><option value="lb">lb</option></select>
              </div>
            </div>
            <div>
              <label class="label">IMC</label>
              <div class="sv-wrap"><input id="v-imc" class="input pr-6" readonly><span id="sv-imc" class="sv-light"></span></div>
            </div>
            <div>
              <label class="label">Estado Nutricional</label>
              <input id="v-imc-cat" class="input" readonly>
            </div>
          </div>
          </div>
        </div>

        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="section-title">Historia de la Enfermedad Actual</h3>
            <div class="text-sm text-gray-500">Modelo: <span id="cfg-model">‚Äî</span></div>
          </div>
          <textarea id="h-actual" data-min="240" class="input min-h-[240px]" placeholder="Relato cl√≠nico, evoluci√≥n, factores..."></textarea>
          <div class="grid sm:grid-cols-3 gap-3 mt-4">
            <button id="h-gen" class="requires-subscription btn"><i class="ic fa-solid fa-notes-medical"></i> Generar Historia Cl√≠nica</button>
            <button id="h-save" class="btn"><i class="ic fa-solid fa-floppy-disk"></i> Guardar Historia</button>
            <button id="h-export" class="requires-subscription btn"><i class="ic fa-solid fa-file-word"></i> Exportar a Word</button>
            <button id="h-rx" class="requires-subscription btn"><i class="ic fa-solid fa-prescription"></i> Generar Receta</button>
            <button id="h-lab" class="requires-subscription btn"><i class="ic fa-solid fa-vials"></i> Generar Laboratorio</button>
            <button id="h-imgind" class="requires-subscription btn"><i class="ic fa-solid fa-x-ray"></i> Solicitar Im√°genes</button>
            <button id="h-explain" class="requires-subscription btn"><i class="ic fa-solid fa-user-doctor"></i> Explicar al Paciente</button>
            <button id="h-ask" class="requires-subscription btn"><i class="ic fa-solid fa-circle-question"></i> Preguntar Historial</button>
            <button id="h-image" class="requires-subscription btn"><i class="ic fa-solid fa-image"></i> Analizar Imagen</button>
          </div>
          <div class="mt-3">
            <div class="text-sm font-semibold mb-1">ü§ñ Sugerencias Inteligentes del Asistente IA</div>
            <div id="h-out" class="outbox"></div>
          </div>
        </div>
      </section>

      </div>
    </main>
  </section>

  <!-- MODALS -->
  <dialog id="dlg-register" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-6">
      <div class="flex items-center gap-3 mb-4"><div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-user-plus"></i></div><h3 class="text-xl font-semibold">Registro de usuario</h3></div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div><label class="label">Nombre completo</label><input id="r-name" class="input" autocomplete="name"></div>
        <div><label class="label">Correo electr√≥nico</label><input id="r-user" type="email" class="input" autocomplete="email"></div>
        <div><label class="label">Contrase√±a</label><input id="r-pass1" type="password" class="input" autocomplete="new-password"></div>
        <div><label class="label">Confirmar contrase√±a</label><input id="r-pass2" type="password" class="input" autocomplete="new-password"></div>
        <div><label class="label">Fecha de nacimiento</label><input id="r-dob" type="date" data-cal class="input"></div>
        <div><label class="label">Pa√≠s</label>
          <select id="r-country" class="input"></select>
        </div>
        <div class="sm:col-span-2"><label class="label">Especialidad m√©dica</label>
          <select id="r-specialty" class="input"></select>
        </div>
        <div id="r-spec-other-wrap" class="hidden sm:col-span-2"><label class="label">Otra especialidad</label><input id="r-specialty-other" class="input"></div>
      </div>
      <div class="mt-6 flex gap-3 justify-end"><button class="btn" value="cancel">Cancelar</button><button id="r-save" class="btn" value="default" data-signup>Guardar</button></div>
    </form>
  </dialog>
  <dialog id="dlg-terms" class="rounded-2xl p-0 w-full max-w-3xl">
    <form method="dialog" class="card p-6 space-y-4">
      <h3 class="text-xl font-semibold">Contrato de Uso y Exoneraci√≥n de Responsabilidad ‚Äì HealthIA</h3>
      <div class="overflow-y-auto max-h-[60vh] text-sm space-y-3">
        <p>Entre: [Nombre del titular o empresa], con domicilio en [direcci√≥n], en adelante ‚Äúel Proveedor‚Äù, y el Usuario Profesional de la Salud, cuyos datos se detallan m√°s adelante, en adelante ‚Äúel Usuario‚Äù, se acuerda lo siguiente:</p>
        <p><strong>1. Objeto</strong></p>
        <p>El presente contrato regula el uso de HealthIA, herramienta digital que utiliza inteligencia artificial para asistir en la organizaci√≥n de datos cl√≠nicos, generaci√≥n de borradores de historias m√©dicas, y emisi√≥n de sugerencias diagn√≥sticas y terap√©uticas.</p>
        <p><strong>2. Naturaleza del servicio</strong></p>
        <p>HealthIA no sustituye la evaluaci√≥n cl√≠nica, el juicio profesional, ni la relaci√≥n m√©dico-paciente. Toda informaci√≥n generada por el sistema debe ser revisada, interpretada y validada por el Usuario antes de ser utilizada en la toma de decisiones cl√≠nicas.</p>
        <p><strong>3. Limitaciones tecnol√≥gicas</strong></p>
        <p>El Usuario reconoce que:</p>
        <p>La IA puede generar errores, omisiones o interpretaciones inexactas.</p>
        <p>La calidad de las sugerencias depende de la precisi√≥n y completitud de los datos ingresados.</p>
        <p>El Proveedor no garantiza resultados exactos ni responsabilidad sobre el uso de la informaci√≥n.</p>
        <p><strong>4. Responsabilidad del usuario</strong></p>
        <p>El Usuario se compromete a:</p>
        <p>Utilizar HealthIA √∫nicamente como herramienta de apoyo.</p>
        <p>No aplicar directamente diagn√≥sticos o tratamientos sin validaci√≥n profesional.</p>
        <p>Cumplir con la legislaci√≥n sanitaria y de protecci√≥n de datos vigente en su pa√≠s.</p>
        <p><strong>5. Exoneraci√≥n de responsabilidad</strong></p>
        <p>El Proveedor no ser√° responsable de da√±os directos, indirectos, incidentales, especiales o consecuentes, incluidos ‚Äîpero no limitados a‚Äî errores diagn√≥sticos, decisiones cl√≠nicas err√≥neas, perjuicios a pacientes o terceros, p√©rdida de datos o beneficios, derivados del uso o mal uso de HealthIA.</p>
        <p><strong>6. Confidencialidad y protecci√≥n de datos</strong></p>
        <p>El Proveedor implementa medidas t√©cnicas y organizativas para proteger los datos procesados. No obstante, el Usuario es el √∫nico responsable de la introducci√≥n, custodia y tratamiento de datos personales y cl√≠nicos, y de cumplir con las leyes aplicables (incluidas normativas de privacidad como GDPR, HIPAA, u otras locales).</p>
        <p><strong>7. Vigencia y terminaci√≥n</strong></p>
        <p>El presente contrato entra en vigor desde su aceptaci√≥n y permanecer√° vigente mientras el Usuario utilice HealthIA. Cualquiera de las partes podr√° darlo por terminado notificando por escrito, sin perjuicio de las obligaciones y responsabilidades asumidas.</p>
        <p><strong>8. Jurisdicci√≥n y ley aplicable</strong></p>
        <p>Este contrato se regir√° por las leyes de [pa√≠s], y cualquier controversia ser√° resuelta ante los tribunales de [ciudad/provincia].</p>
        <p><strong>9. Aceptaci√≥n</strong></p>
        <p>El Usuario declara que ha le√≠do y comprendido el presente contrato, y que acepta expresamente sus t√©rminos y condiciones.</p>
      </div>
      <div class="mt-4 flex justify-end gap-3"><button id="terms-cancel" class="btn" value="cancel">No acepto</button><button id="terms-accept" class="btn" value="default">Acepto</button></div>
    </form>
  </dialog>
  <dialog id="dlg-img" class="dialog-full">
    <form method="dialog" class="h-full flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">An√°lisis de Imagen</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="img-box" class="flex-1 overflow-y-auto p-4 chat-box bg-gray-50"></div>
      <div class="p-4 grid grid-cols-[1fr_auto] gap-2 border-t">
        <textarea id="img-input" class="input resize-none overflow-hidden" rows="1" data-min="44" placeholder="Pregunta..."></textarea>
        <button id="img-send" type="button" class="btn">Enviar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-config" class="rounded-2xl p-0 w-full max-w-xl">
    <form method="dialog" class="card p-6">
      <div class="flex items-center gap-3 mb-4"><div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-gear"></i></div><h3 class="text-xl font-semibold">Configuraci√≥n</h3></div>
      <div class="space-y-4">
        <div class="grid sm:grid-cols-2 gap-2">
          <button type="button" id="cfg-export" class="btn w-full"><i class="ic fa-solid fa-file-export"></i> Exportar base de datos</button>
          <button type="button" id="cfg-import" class="btn w-full"><i class="ic fa-solid fa-file-import"></i> Importar base de datos</button>
          <button type="button" id="cfg-cloud" class="btn w-full sm:col-span-2"><i class="ic fa-solid fa-cloud-arrow-down"></i> Descargar desde la nube</button>
          <input id="cfg-file" type="file" accept=".json,.db" class="hidden">
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end"><button class="btn" value="cancel">Cerrar</button></div>
    </form>
  </dialog>

  <dialog id="dlg-recover" class="rounded-2xl p-0 w-full max-w-xl">
    <form method="dialog" class="card p-6">
      <div class="flex items-center gap-3 mb-4"><div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-key"></i></div><h3 class="text-xl font-semibold">Restablecer contrase√±a</h3></div>
      <div class="space-y-3">
        <input id="rec-email" type="email" class="input" placeholder="Correo electr√≥nico" autocomplete="email" />
        <p id="rec-msg" class="text-sm text-gray-600"></p>
      </div>
      <div class="mt-6 flex gap-3 justify-end"><button class="btn" value="cancel">Cerrar</button><button id="rec-send" class="btn" value="default">Enviar enlace</button></div>
    </form>
  </dialog>

  <dialog id="dlg-phone" class="rounded-2xl p-0 w-full max-w-sm">
    <form method="dialog" class="card p-6 space-y-3">
      <div class="flex items-center gap-3 mb-2"><div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-phone"></i></div><h3 class="text-xl font-semibold">Ingresar con tel√©fono</h3></div>
      <div id="phone-step1" class="space-y-3">
        <input id="phone-number" class="input" placeholder="+1 809..." />
        <div id="recaptcha-container"></div>
        <button id="phone-send" type="button" class="btn w-full">Enviar c√≥digo</button>
      </div>
      <div id="phone-step2" class="space-y-3 hidden">
        <input id="phone-code" class="input" placeholder="C√≥digo" />
        <button id="phone-verify" type="button" class="btn w-full">Verificar</button>
      </div>
      <div class="mt-4 flex gap-3 justify-end"><button class="btn" value="cancel">Cerrar</button></div>
    </form>
  </dialog>

  <dialog id="dlg-profile" class="rounded-2xl p-0 w-full max-w-md">
    <form method="dialog" class="card p-6 space-y-3">
      <div class="flex items-center gap-3 mb-2"><div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-hospital"></i></div><h3 class="text-xl font-semibold">Datos del Centro M√©dico</h3></div>
      <div class="space-y-3">
        <div><label class="label">Nombre del m√©dico</label><input id="prof-doctor" class="input"></div>
        <div><label class="label">Nombre del hospital</label><input id="prof-hospital" class="input"></div>
        <div><label class="label">Correo</label><input id="prof-email" class="input"></div>
        <div><label class="label">Direcci√≥n</label><input id="prof-address" class="input"></div>
        <div><label class="label">Tel√©fono</label><input id="prof-phone" class="input"></div>
      </div>
      <div class="mt-4 flex gap-3 justify-end"><button class="btn" value="cancel">Cancelar</button><button id="prof-save" class="btn" value="default">Guardar</button></div>
    </form>
  </dialog>

  <dialog id="dlg-intake" class="dialog-full">
    <form method="dialog" class="h-full flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Asistente IA</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="intake-box" class="flex-1 overflow-y-auto p-4 chat-box bg-gray-50"></div>
      <div class="p-4 grid grid-cols-[1fr_auto_auto] gap-2 border-t">
        <textarea id="intake-input" class="input resize-none overflow-hidden" rows="1" data-min="44" placeholder="Respuesta..."></textarea>
        <button id="intake-copy" type="button" class="btn">‚Ü™</button>
        <button id="intake-send" type="button" class="btn use-ai">Enviar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-ask" class="dialog-full">
    <form method="dialog" class="h-full flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Preguntar Historial</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="ask-box" class="flex-1 overflow-y-auto p-4 chat-box bg-gray-50"></div>
      <div class="p-4 grid grid-cols-[1fr_auto] gap-2 border-t">
        <textarea id="ask-input" class="input resize-none overflow-hidden" rows="1" data-min="44" placeholder="Pregunta..."></textarea>
        <button id="ask-send" type="button" class="btn use-ai">Enviar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-rx" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Receta</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="rx-header" class="text-sm text-gray-700"></div>
      <div id="rx-box" class="outbox"></div>
      <div class="grid sm:grid-cols-[1fr_auto] gap-2">
        <input id="rx-prompt" class="input" placeholder="Instrucciones para modificar (ej. agregar ibuprofeno)">
        <button id="rx-ai" type="button" class="btn use-ai">Modificar via IA</button>
      </div>
      <div class="flex justify-end"><button id="rx-print" type="button" class="btn">Imprimir</button></div>
    </form>
  </dialog>

  <dialog id="dlg-lab" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Solicitud de Laboratorio</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="lab-header" class="text-sm text-gray-700"></div>
      <div id="lab-box" class="outbox"></div>
      <div class="grid sm:grid-cols-[1fr_auto] gap-2">
        <input id="lab-prompt" class="input" placeholder="Instrucciones para modificar (ej. agregar TSH)">
        <button id="lab-ai" type="button" class="btn use-ai">Modificar via IA</button>
      </div>
  <div class="flex justify-end"><button id="lab-print" type="button" class="btn">Imprimir</button></div>
    </form>
  </dialog>

  <dialog id="dlg-imgind" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Solicitud de Im√°genes</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="imgind-header" class="text-sm text-gray-700"></div>
      <div id="imgind-box" class="outbox"></div>
      <div class="grid sm:grid-cols-[1fr_auto] gap-2">
        <input id="imgind-prompt" class="input" placeholder="Instrucciones para modificar (ej. agregar tomograf√≠a)">
        <button id="imgind-ai" type="button" class="btn use-ai">Modificar via IA</button>
      </div>
      <div class="flex justify-end"><button id="imgind-print" type="button" class="btn">Imprimir</button></div>
    </form>
  </dialog>

  <dialog id="dlg-explain" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Explicar al Paciente</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div id="exp-box" class="outbox"></div>
    </form>
  </dialog>

  <dialog id="dlg-fixedmed" class="rounded-2xl p-0 w-full max-w-md">
    <form method="dialog" class="card p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Medicaci√≥n Fija</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <input id="medfijos-box" class="input" placeholder="Medicamentos continuos">
      <div class="flex justify-end"><button id="medfijos-save" type="button" class="btn">Guardar</button></div>
    </form>
  </dialog>

  <dialog id="dlg-patient" class="rounded-2xl p-0 w-full max-w-2xl">
    <form id="dlg-p-form" class="card p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-9 h-9 grid place-content-center bg-brand-500 text-white rounded-xl"><i class="fa-solid fa-stethoscope"></i></div>
        <h3 class="text-xl font-semibold">Paciente</h3>
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div><label class="label">Nombre completo</label><input id="dlg-p-nombre" class="input"></div>
        <div><label class="label">C√©dula / ID</label><input id="dlg-p-doc" class="input"></div>
        <div><label class="label">Fecha de Nacimiento</label><input id="dlg-p-fecha" type="text" data-cal class="input"></div>
        <div><label class="label">Edad</label><input id="dlg-p-edad" type="number" class="input"></div>
        <div><label class="label">Sexo</label><select id="dlg-p-sexo" class="input"><option>Masculino</option><option>Femenino</option></select></div>
        <div><label class="label">Alergias</label><input id="dlg-p-alergias" class="input"></div>
        <div><label class="label">Tel√©fono</label><input id="dlg-p-tel" class="input"></div>
        <div class="sm:col-span-2"><label class="label">Direcci√≥n</label><input id="dlg-p-dir" class="input"></div>
        <div><label class="label">Medicamentos Continuos</label><input id="dlg-p-medfijos" class="input"></div>
        <div><label class="label">Altura (cm)</label><input id="dlg-p-talla" type="number" class="input"></div>
        <div><label class="label">Nacionalidad</label><div class="flex gap-2"><input id="dlg-p-nac" class="input flex-1" list="nac-options"><button type="button" id="add-nac" class="btn btn-icon"><i class="ic fa-solid fa-plus"></i></button></div></div>
        <div><label class="label">Ocupaci√≥n</label><div class="flex gap-2"><input id="dlg-p-ocup" class="input flex-1" list="ocup-options"><button type="button" id="add-ocup" class="btn btn-icon"><i class="ic fa-solid fa-plus"></i></button></div></div>
        <div><label class="label">ARS</label><div class="flex gap-2"><input id="dlg-p-ars" class="input flex-1" list="ars-options"><button type="button" id="add-ars" class="btn btn-icon"><i class="ic fa-solid fa-plus"></i></button></div></div>
        <div><label class="label">Religi√≥n</label><div class="flex gap-2"><input id="dlg-p-religion" class="input flex-1" list="religion-options"><button type="button" id="add-religion" class="btn btn-icon"><i class="ic fa-solid fa-plus"></i></button></div></div>
        <div class="sm:col-span-2"><label class="label">Diagn√≥sticos Previos</label><input id="dlg-p-dxprev" class="input"></div>
        <div class="sm:col-span-2"><label class="label">Tipo de Sangre</label><select id="dlg-p-sangre" class="input"><option>O+</option><option>O-</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>No sabe</option></select></div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancelar</button>
        <button id="dlg-p-save" type="submit" class="btn">Guardar</button>
      </div>
    </form>
  </dialog>
  <dialog id="dlg-catalog" class="rounded-2xl p-0 w-full max-w-2xl">
    <form method="dialog" class="card p-4 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Cat√°logo</h3>
        <button class="btn" value="cancel">Cerrar</button>
      </div>
      <div class="grid sm:grid-cols-4 gap-2">
        <input id="cat-code" class="input" placeholder="C√≥digo">
        <input id="cat-name" class="input" placeholder="Nombre">
        <input id="cat-price" type="number" min="0" class="input" placeholder="Precio">
        <input id="cat-tax" type="number" min="0" class="input" placeholder="Imp%">
      </div>
      <div class="flex justify-end"><button id="cat-add" type="button" class="btn">Guardar √çtem</button></div>
      <div class="overflow-y-auto max-h-60">
        <table>
          <thead><tr><th>C√≥digo</th><th>Nombre</th><th>Precio</th><th>Imp%</th><th></th></tr></thead>
          <tbody id="tbl-catalog"></tbody>
        </table>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-invoice" class="rounded-2xl p-0 w-full max-w-3xl">
    <form method="dialog" class="card p-4 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Nueva Factura</h3>
        <div class="flex gap-2">
          <button id="btn-invoices" type="button" class="btn">Historial</button>
          <button id="btn-open-catalog" type="button" class="btn">Cat√°logo</button>
          <button class="btn" value="cancel">Cerrar</button>
        </div>
      </div>
      <div class="grid sm:grid-cols-4 gap-2">
        <input id="inv-number" class="input" readonly>
        <input id="inv-date" type="date" data-cal class="input">
        <select id="inv-terms" class="input"><option>Contado</option><option>Cr√©dito</option></select>
        <input id="inv-ars" class="input" placeholder="ARS">
      </div>
      <div class="grid sm:grid-cols-2 gap-2">
        <input id="inv-patient" class="input" readonly>
        <input id="inv-doc" class="input" readonly>
      </div>
      <div class="grid sm:grid-cols-[1fr_auto_auto_auto] gap-2">
        <input id="it-search" class="input" placeholder="C√≥digo o nombre">
        <input id="it-price" type="number" class="input" placeholder="Precio">
        <input id="it-qty" type="number" min="1" value="1" class="input" placeholder="Cant">
        <button id="it-add" type="button" class="btn">Agregar</button>
      </div>
      <div class="overflow-y-auto max-h-40">
        <table>
          <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant</th><th>Precio</th><th>Imp%</th><th>Total</th><th></th></tr></thead>
          <tbody id="tbl-items"></tbody>
        </table>
      </div>
      <div class="grid sm:grid-cols-2 gap-2">
        <div class="grid grid-cols-2 gap-2 items-center">
          <label class="label mb-0">Descuento</label><input id="inv-discount" type="number" min="0" value="0" class="input">
          <label class="label mb-0">Cobertura ARS %</label><input id="inv-insure" type="number" min="0" max="100" value="0" class="input">
        </div>
        <div class="grid grid-cols-2 gap-2 items-center">
          <label class="label mb-0">Pago</label>
          <select id="pay-method" class="input"><option>Efectivo</option><option>Tarjeta</option><option>Mixto</option></select>
          <input id="pay-cash" type="number" class="input hidden" placeholder="Efectivo">
          <input id="pay-card" type="number" class="input hidden" placeholder="Tarjeta">
        </div>
      </div>
      <div class="text-right space-y-1">
        <div>Sub: <span id="sum-sub">0</span></div>
        <div>Imp: <span id="sum-tax">0</span></div>
        <div>Desc: <span id="sum-disc">0</span></div>
        <div>ARS: <span id="sum-ins">0</span></div>
        <div class="font-bold">Total: <span id="sum-total">0</span></div>
      </div>
      <div class="flex justify-end gap-2">
        <button id="inv-save" type="button" class="btn">Guardar</button>
        <button id="inv-pdf" type="button" class="btn">PDF</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-invoices" class="dialog-full">
    <div class="p-4 flex items-center justify-between">
      <h3 class="text-lg font-semibold">Facturas del Paciente</h3>
      <button class="btn" value="cancel">Cerrar</button>
    </div>
    <div class="p-4 overflow-y-auto h-[calc(100vh-80px)]">
      <table class="w-full">
        <thead><tr><th>Fecha</th><th>#</th><th>Descripci√≥n</th><th>Total</th><th></th></tr></thead>
        <tbody id="tbl-invoices"></tbody>
      </table>
    </div>
  </dialog>

  <dialog id="dlg-daily" class="rounded-2xl p-0 w-full max-w-md overflow-visible">
    <form id="daily-form" method="dialog" class="card p-4 space-y-3">
      <div class="grid grid-cols-2 gap-2">
        <div class="flex flex-col">
          <label class="label mb-0">Desde</label>
          <input id="daily-start" type="date" class="input">
        </div>
        <div class="flex flex-col">
          <label class="label mb-0">Hasta</label>
          <input id="daily-end" type="date" class="input">
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="btn" value="cancel">Cancelar</button>
        <button id="daily-gen" type="button" class="btn">Generar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-reminders" class="rounded-2xl p-0 w-full max-w-2xl">
    <div class="card p-4 space-y-3">
      <h3 class="text-lg"><i class="fa-solid fa-bell"></i> Recordatorios</h3>
      <div class="grid grid-cols-2 gap-4">
        <form id="rem-form" class="space-y-2">
          <input id="rem-title" class="input w-full" placeholder="Descripci√≥n" required>
          <input id="rem-motive" class="input w-full" placeholder="Motivo">
          <input id="rem-patient" class="input w-full" list="dl-patients" placeholder="Paciente">
          <input id="rem-date" type="datetime-local" class="input w-full" required>
          <button type="submit" class="btn w-full">Agregar</button>
        </form>
        <ul id="rem-list" class="max-h-60 overflow-y-auto space-y-1 text-sm"></ul>
      </div>
      <div class="text-right">
        <button class="btn" onclick="$('#dlg-reminders').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <dialog id="dlg-rem-alert" class="rounded-xl p-4">
    <p id="rem-alert-msg" class="mb-4"></p>
    <div class="text-right">
      <button class="btn" onclick="$('#dlg-rem-alert').close()">Cerrar</button>
    </div>
  </dialog>

  <dialog id="dlg-appointments" class="rounded-2xl p-0 w-full max-w-3xl overflow-visible">
    <div class="card p-4 space-y-3">
      <h3 class="text-lg"><i class="fa-solid fa-calendar-check"></i> Citas M√©dicas</h3>
      <div class="grid grid-cols-2 gap-4">
        <form id="appt-form" class="space-y-2">
          <input id="appt-patient" class="input w-full" list="dl-patients" placeholder="Paciente" required>
          <input id="appt-date" type="date" class="input w-full" required>
          <input id="appt-time" type="time" class="input w-full" required>
          <input id="appt-motive" class="input w-full" placeholder="Motivo" required>
          <button type="submit" class="btn w-full">Agendar</button>
        </form>
        <div class="max-h-60 overflow-y-auto">
          <table class="w-full text-sm" id="appt-table">
            <thead><tr><th>Paciente</th><th>Fecha</th><th>Hora</th><th>Motivo</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="text-right">
        <button class="btn" onclick="$('#dlg-appointments').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <div id="invoice-print" class="hidden">
    <div class="p-4" id="pr-hdr">
      <div class="text-center">
        <div id="pr-hospital"></div>
        <div id="pr-address"></div>
        <div id="pr-phone"></div>
        <div id="pr-email"></div>
        <div id="pr-doctor" class="mt-2"></div>
      </div>
      <div class="mt-4 flex justify-between">
        <div>
          <div><b>Factura:</b> <span id="pr-number"></span></div>
          <div><b>Fecha:</b> <span id="pr-date"></span></div>
          <div><b>Condici√≥n:</b> <span id="pr-terms"></span></div>
          <div><b>ARS:</b> <span id="pr-ars"></span></div>
          <div><b>Pago:</b> <span id="pr-pay"></span></div>
        </div>
        <div>
          <div><b>Paciente:</b> <span id="pr-patient"></span></div>
          <div><b>ID:</b> <span id="pr-doc"></span></div>
          <div><b>Direcci√≥n:</b> <span id="pr-addr"></span></div>
        </div>
      </div>
      <table class="w-full mt-4" id="pr-items">
        <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant</th><th>Precio</th><th>Imp%</th><th>Importe</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="text-right mt-2">
        <div>Sub: <span id="pr-sub"></span></div>
        <div>Imp: <span id="pr-tax"></span></div>
        <div>Desc: <span id="pr-disc"></span></div>
        <div>ARS: <span id="pr-ins"></span></div>
        <div class="font-bold">Total: <span id="pr-total"></span></div>
      </div>
    </div>
  </div>
  <div id="daily-print" class="hidden"></div>
  <datalist id="dl-patients"></datalist>
  <datalist id="ars-options">
    <option>ARS Humano</option>
    <option>ARS Senasa</option>
    <option>ARS Universal</option>
    <option>Privada</option>
    <option>Ninguna</option>
  </datalist>
  <datalist id="religion-options">
    <option>Cristianismo</option>
    <option>Catolicismo</option>
    <option>Protestantismo</option>
    <option>Ortodoxia</option>
    <option>Anglicanismo</option>
    <option>Islam</option>
    <option>Hinduismo</option>
    <option>Budismo</option>
    <option>Juda√≠smo</option>
    <option>Sijismo</option>
    <option>Confucianismo</option>
    <option>Tao√≠smo</option>
    <option>Shinto√≠smo</option>
    <option>Baha√≠smo</option>
    <option>Jainismo</option>
    <option>Espiritismo</option>
    <option>Ate√≠smo</option>
    <option>Agnosticismo</option>
    <option>Otra</option>
  </datalist>
  <datalist id="ocup-options">
    <option>Estudiante</option>
    <option>Empleado</option>
    <option>Desempleado</option>
  </datalist>
  <datalist id="nac-options">
    <option>Dominicana</option>
    <option>Haitiana</option>
    <option>Venezolana</option>
  </datalist>
</div>
<!-- PROMPT -->
  <script src="prompt_history.js"></script>
<script>
/********* IndexedDB *********/
const DB_NAME='healthia_web_db_v2'; const DB_VERSION=6; let db;
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);const timer=setTimeout(()=>rej(new Error('IndexedDB timeout')),10000);r.onupgradeneeded=e=>{const d=e.target.result; if(!d.objectStoreNames.contains('users')) d.createObjectStore('users',{keyPath:'username'}); if(!d.objectStoreNames.contains('patients')) d.createObjectStore('patients',{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains('histories')) d.createObjectStore('histories',{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains('config')) d.createObjectStore('config',{keyPath:'k'}); if(!d.objectStoreNames.contains('invoices')) d.createObjectStore('invoices',{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains('catalog')) d.createObjectStore('catalog',{keyPath:'code'}); if(!d.objectStoreNames.contains('lookups')) d.createObjectStore('lookups',{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains('reminders')) d.createObjectStore('reminders',{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains('appointments')) d.createObjectStore('appointments',{keyPath:'id',autoIncrement:true});}; r.onsuccess=()=>{clearTimeout(timer); db=r.result; res();}; r.onerror=()=>{clearTimeout(timer); rej(r.error);};});}
function getData(store,key){return idbGet(store,key);}
function getAllData(store){return idbAll(store);}
async function updateData(store,id,newData){const cur=await idbGet(store,id); if(cur){await saveData(store,{...cur,...newData});}}
function idbGet(store,key){return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly'); const st=tx.objectStore(store); const rq=st.get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error);});}
function idbAll(store){return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly'); const st=tx.objectStore(store); const rq=st.getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error);});}
function idbPut(store,val){return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); const st=tx.objectStore(store); const rq=st.put(val); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);});}
function idbDelete(store,key){return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); const st=tx.objectStore(store); const rq=st.delete(key); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error);});}
function idbClear(store){return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); const st=tx.objectStore(store); const rq=st.clear(); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error);});}


/********* Lookups *********/
async function loadLookups(type){
  const ids={ars:'#ars-options',religion:'#religion-options',ocup:'#ocup-options',nac:'#nac-options'};
  const list=$(ids[type]);
  if(!list) return;
  const rows=await idbAll('lookups');
  const vals=rows.filter(r=>r.type===type).map(r=>r.value);
  const existing=new Set(Array.from(list.children).map(o=>o.value||o.textContent));
  vals.forEach(v=>{if(!existing.has(v)){const opt=document.createElement('option');opt.value=v;list.appendChild(opt);}});
}
async function addLookup(type){
  const names={ars:'ARS',religion:'Religi√≥n',ocup:'Ocupaci√≥n',nac:'Nacionalidad'};
  const val=prompt('Nueva '+names[type]+':');
  if(val){await saveData('lookups',{type,value:val});await loadLookups(type);}
}

/********* Utils *********/
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const on=(sel,ev,fn)=>{const el=$(sel); if(el) el.addEventListener(ev,fn);};
let weightUnit='kg';
let reminders=[];
let appointments=[];
function sha256(s){const te=new TextEncoder(); return crypto.subtle.digest('SHA-256',te.encode(s)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''));}
function toast(m){const n=document.createElement('div'); n.className='fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg'; n.textContent=m; document.body.appendChild(n); setTimeout(()=>n.remove(),2400);}
function calcIMC(kg,cm){if(!kg||!cm) return ''; const m=cm/100; return (kg/(m*m)).toFixed(1);}
function nutritivo(imc){if(!imc) return ''; imc=parseFloat(imc); if(imc<18.5) return 'Bajo peso'; if(imc<25) return 'Normal'; if(imc<30) return 'Sobrepeso'; return 'Obesidad';}
function estadoNutricional(imc){
  const age=calcAge(window.__pfecha);
  if (Number.isFinite(age) && age<19) return imc? 'Consultar curva de crecimiento' : '';
  return nutritivo(imc);
}
function updateIMC(){ const w=parseFloat($('#v-peso').value); if(isNaN(w)||!window.__pheight){$('#v-imc').value=''; $('#v-imc-cat').value=''; return;} const kg=$('#v-unit').value==='lb'? w*0.45359237:w; const imc=calcIMC(kg,window.__pheight); $('#v-imc').value=imc; $('#v-imc-cat').value=estadoNutricional(imc); }
function setLight(id,color){ const el=$('#sv-'+id); if(el) el.className='sv-light'+(color? ' '+color:''); }
function lightColor(id,val){
  const n=parseFloat(val);
  switch(id){
    case 'pa':{
      const m=val.match(/(\d+)\s*\/\s*(\d+)/); if(!m) return ''; const sys=+m[1], dia=+m[2];
      if(sys>=140||dia>=90) return 'red'; if(sys>=120||dia>=80) return 'yellow'; return 'green';
    }
    case 'fc': if(!n) return ''; if(n<60||n>100) return 'red'; return 'green';
    case 'fr': if(!n) return ''; if(n<12||n>20) return 'red'; return 'green';
    case 'temp': if(!n) return ''; if(n<36||n>38.5) return 'red'; if(n<=37.5) return 'green'; return 'yellow';
    case 'oxi': if(!n) return ''; if(n<90) return 'red'; if(n<95) return 'yellow'; return 'green';
    case 'gli': if(!n) return ''; if(n<70||n>140) return 'red'; if(n<=110) return 'green'; return 'yellow';
    case 'col': if(!n) return ''; if(n<200) return 'green'; if(n<240) return 'yellow'; return 'red';
    case 'imc': if(!n) return ''; if(n<18.5||n>=30) return 'red'; if(n<25) return 'green'; return 'yellow';
    default: return '';
  }
}
function updateVitalsLights(){
  setLight('pa', lightColor('pa', $('#v-pa').value));
  setLight('fc', lightColor('fc', $('#v-fc').value));
  setLight('fr', lightColor('fr', $('#v-fr').value));
  setLight('gli', lightColor('gli', $('#v-gli').value));
  setLight('col', lightColor('col', $('#v-col').value));
  setLight('oxi', lightColor('oxi', $('#v-oxi').value));
  setLight('temp', lightColor('temp', $('#v-temp').value));
  setLight('imc', lightColor('imc', $('#v-imc').value));
}
function today(){return new Date().toISOString().slice(0,10)}
function enhanceCalendars(){
  const now=new Date().getFullYear();
  $$('input[data-cal]').forEach(el=>{
    if(el._flatpickr) return;
    el.type='text';
    const dialog=el.closest('dialog');
    const fp=flatpickr(el,{
      dateFormat:'Y-m-d',
      monthSelectorType:'dropdown',
      allowInput:true,
      appendTo: dialog || document.body,
      onOpen(_,__,inst){
        const rect=el.getBoundingClientRect();
        const cal=inst.calendarContainer;
        cal.style.position='fixed';
        cal.style.zIndex='10000';
        cal.style.left=rect.left+"px";
        cal.style.top=rect.bottom+"px";
        requestAnimationFrame(()=>{
          const crect=cal.getBoundingClientRect();
          if(crect.bottom>window.innerHeight){
            cal.style.top=(rect.top-crect.height)+"px";
          }
          if(crect.right>window.innerWidth){
            cal.style.left=(window.innerWidth-crect.width-5)+"px";
          }
        });
      },
      onReady(_,__,inst){
        try{
          const yr=(inst.yearElements||[])[0];
          if(!yr) return;
          const sel=document.createElement('select');
          sel.className='flatpickr-yearDropdown';
          for(let y=now-100;y<=now+20;y++){
            const opt=document.createElement('option');
            opt.value=y; opt.textContent=y; sel.appendChild(opt);
          }
          sel.value=inst.currentYear;
          sel.addEventListener('change',e=>inst.changeYear(e.target.value));
          yr.parentNode.replaceChild(sel,yr);
          inst.yearElements=[sel];
        }catch(err){console.error('Year dropdown init failed',err);}
      }
    });
    if(dialog){
      dialog.addEventListener('close',()=>fp.close());
    }
  });
}
function autoResize(el){const min=parseInt(el.dataset.min||'0',10);el.style.height='auto';el.style.height=Math.max(el.scrollHeight,min)+'px';}
function mdToHtml(md){return md.replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<b>$1</b>');}
function streamMarkdown(md,el,delay=5,step=3){return new Promise(res=>{el.dataset.raw=md;el.innerHTML='';let i=0;(function loop(){i+=step;el.innerHTML=mdToHtml(md.slice(0,i));el.scrollTop=el.scrollHeight;if(i<md.length) setTimeout(loop,delay); else res();})();});}

/********* Intro *********/
function typeWriter(el,text,delay=20,step=1,cb){let i=0;const t=setInterval(()=>{el.textContent+=text.slice(i,i+step);i+=step;if(i>=text.length){clearInterval(t);cb&&cb();}},delay);}
function showIntro(){return new Promise(res=>{const msg='ü©∫  Bienvenido a HealthIA - Tu asistente m√©dico inteligente üß†';const msgEl=$('#intro-msg');const barEl=$('#intro-progress');let doneT=false,doneB=false;const finish=()=>{if(doneT&&doneB){$('#view-intro').classList.add('hidden');res();}};typeWriter(msgEl,msg,8,2,()=>{doneT=true;finish();});let p=0;const it=setInterval(()=>{p+=10;barEl.style.width=p+'%';if(p>=100){clearInterval(it);doneB=true;finish();}},15);setTimeout(()=>{doneT=true;doneB=true;finish();},3000);});}

/********* Auth *********/
function unauthorizedDomainMessage(err){
  if(err.code==='auth/unauthorized-domain')
    return 'Dominio no autorizado. A√±ade este dominio en Firebase Authentication > Dominios autorizados.';
  return null;
}
async function showAuthTip(){ $('#tip-admin').classList.add('hidden'); }

const CONTRACT_TEXT=`Contrato de Uso y Exoneraci√≥n de Responsabilidad ‚Äì HealthIA\n\nEntre:\nHealthIA, en adelante ‚Äúel Proveedor‚Äù,\ny el Usuario Profesional de la Salud, cuyos datos se detallan m√°s adelante, en adelante ‚Äúel Usuario‚Äù,\nse acuerda lo siguiente:\n\n1. Objeto\n\nEl presente contrato regula el uso de HealthIA, herramienta digital que utiliza inteligencia artificial para asistir en la organizaci√≥n de datos cl√≠nicos, generaci√≥n de borradores de historias m√©dicas, y emisi√≥n de sugerencias diagn√≥sticas y terap√©uticas.\n\n2. Naturaleza del servicio\n\nHealthIA no sustituye la evaluaci√≥n cl√≠nica, el juicio profesional, ni la relaci√≥n m√©dico-paciente.\nToda informaci√≥n generada por el sistema debe ser revisada, interpretada y validada por el Usuario antes de ser utilizada en la toma de decisiones cl√≠nicas.\n\n3. Limitaciones tecnol√≥gicas\n\nEl Usuario reconoce que:\n\nLa IA puede generar errores, omisiones o interpretaciones inexactas.\n\nLa calidad de las sugerencias depende de la precisi√≥n y completitud de los datos ingresados.\n\nEl Proveedor no garantiza resultados exactos ni responsabilidad sobre el uso de la informaci√≥n.\n\n4. Responsabilidad del usuario\n\nEl Usuario se compromete a:\n\nUtilizar HealthIA √∫nicamente como herramienta de apoyo.\n\nNo aplicar directamente diagn√≥sticos o tratamientos sin validaci√≥n profesional.\n\nCumplir con la legislaci√≥n sanitaria y de protecci√≥n de datos vigente en su pa√≠s.\n\n5. Exoneraci√≥n de responsabilidad\n\nEl Proveedor no ser√° responsable de da√±os directos, indirectos, incidentales, especiales o consecuentes, incluidos ‚Äîpero no limitados a‚Äî errores diagn√≥sticos, decisiones cl√≠nicas err√≥neas, perjuicios a pacientes o terceros, p√©rdida de datos o beneficios, derivados del uso o mal uso de HealthIA.\n\n6. Confidencialidad y protecci√≥n de datos\n\nEl Proveedor implementa medidas t√©cnicas y organizativas para proteger los datos procesados. No obstante, el Usuario es el √∫nico responsable de la introducci√≥n, custodia y tratamiento de datos personales y cl√≠nicos, y de cumplir con las leyes aplicables (incluidas normativas de privacidad como GDPR, HIPAA, u otras locales).\n\n7. Vigencia y terminaci√≥n\n\nEl presente contrato entra en vigor desde su aceptaci√≥n y permanecer√° vigente mientras el Usuario utilice HealthIA.\nCualquiera de las partes podr√° darlo por terminado notificando por escrito, sin perjuicio de las obligaciones y responsabilidades asumidas.\n\n8. Jurisdicci√≥n y ley aplicable\n\nEste contrato se regir√° por las leyes de [pa√≠s], y cualquier controversia ser√° resuelta ante los tribunales de [ciudad/provincia].\n\n9. Aceptaci√≥n\n\nEl Usuario declara que ha le√≠do y comprendido el presente contrato, y que acepta expresamente sus t√©rminos y condiciones.`;

async function ensureContract(uid,name){
  if(window.__profile?.contratoAceptado===true || localStorage.getItem('contract:'+uid)==='1'){
    localStorage.setItem('contract:'+uid,'1');
    window.__profile={...window.__profile,contratoAceptado:true};
    return true;
  }
  return new Promise((resolve)=>{
    const dlg=$('#dlg-terms');
    const accept=$('#terms-accept');
    const cancel=$('#terms-cancel');
    function clean(){ accept.onclick=null; cancel.onclick=null; }
    accept.onclick=async()=>{
      try{
        await setDoc(doc(window.firestore,'users',uid),{contratoAceptado:true,contratoFecha:new Date().toISOString(),contratoTexto:CONTRACT_TEXT,nombre:name},{merge:true});
        localStorage.setItem('contract:'+uid,'1');
        window.__profile={...window.__profile,contratoAceptado:true};
        dlg.close();
        resolve(true);
      }catch(e){ console.error('Contract save',e); toast('Error guardando contrato'); }
      clean();
    };
    cancel.onclick=()=>{ clean(); dlg.close(); resolve(false); };
    dlg.showModal();
  });
}

const COUNTRIES=[
  'Afganist√°n','Albania','Alemania','Andorra','Angola','Antigua y Barbuda','Arabia Saudita','Argelia','Argentina','Armenia',
  'Australia','Austria','Azerbaiy√°n','Bahamas','Banglad√©s','Barbados','Bar√©in','B√©lgica','Belice','Ben√≠n','Bielorrusia','Bolivia',
  'Bosnia y Herzegovina','Botsuana','Brasil','Brun√©i','Bulgaria','Burkina Faso','Burundi','But√°n','Cabo Verde','Camboya','Camer√∫n',
  'Canad√°','Catar','Chad','Chile','China','Chipre','Colombia','Comoras','Corea del Norte','Corea del Sur','Costa Rica',
  'Costa de Marfil','Croacia','Cuba','Dinamarca','Dominica','Ecuador','Egipto','El Salvador','Emiratos √Årabes Unidos','Eritrea',
  'Eslovaquia','Eslovenia','Espa√±a','Estados Unidos','Estonia','Etiop√≠a','Filipinas','Finlandia','Fiyi','Francia','Gab√≥n',
  'Gambia','Georgia','Ghana','Granada','Grecia','Guatemala','Guinea','Guinea-Bis√°u','Guinea Ecuatorial','Guyana','Hait√≠',
  'Honduras','Hungr√≠a','India','Indonesia','Irak','Ir√°n','Irlanda','Islandia','Islas Marshall','Islas Salom√≥n','Israel',
  'Italia','Jamaica','Jap√≥n','Jordania','Kazajist√°n','Kenia','Kirguist√°n','Kiribati','Kuwait','Laos','Lesoto','Letonia',
  'L√≠bano','Liberia','Libia','Liechtenstein','Lituania','Luxemburgo','Macedonia del Norte','Madagascar','Malasia','Malaui',
  'Maldivas','Mal√≠','Malta','Marruecos','Mauricio','Mauritania','M√©xico','Micronesia','Moldavia','M√≥naco','Mongolia',
  'Montenegro','Mozambique','Namibia','Nauru','Nepal','Nicaragua','N√≠ger','Nigeria','Noruega','Nueva Zelanda','Om√°n',
  'Pa√≠ses Bajos','Pakist√°n','Palaos','Panam√°','Pap√∫a Nueva Guinea','Paraguay','Per√∫','Polonia','Portugal','Reino Unido',
  'Rep√∫blica Centroafricana','Rep√∫blica Checa','Rep√∫blica del Congo','Rep√∫blica Democr√°tica del Congo',
  'Rep√∫blica Dominicana','Ruanda','Rumania','Rusia','Samoa','San Crist√≥bal y Nieves','San Marino','San Vicente y las Granadinas',
  'Santa Luc√≠a','Santo Tom√© y Pr√≠ncipe','Senegal','Serbia','Seychelles','Sierra Leona','Singapur','Siria','Somalia','Sri Lanka',
  'Suazilandia','Sud√°frica','Sud√°n','Sud√°n del Sur','Suecia','Suiza','Surinam','Tailandia','Tanzania','Tayikist√°n','Timor Oriental',
  'Togo','Tonga','Trinidad y Tobago','T√∫nez','Turkmenist√°n','Turqu√≠a','Tuvalu','Ucrania','Uganda','Uruguay','Uzbekist√°n',
  'Vanuatu','Vaticano','Venezuela','Vietnam','Yemen','Yibuti','Zambia','Zimbabue'
];

const SPECIALTIES={
  'Especialidades m√©dicas troncales':[ 'Medicina Interna','Pediatr√≠a','Ginecolog√≠a y Obstetricia','Cirug√≠a General',
    'Medicina Familiar y Comunitaria','Medicina de Urgencias y Emergencias','Anestesiolog√≠a y Reanimaci√≥n','Psiquiatr√≠a',
    'Medicina Preventiva y Salud P√∫blica'],
  'Especialidades m√©dicas cl√≠nicas':[ 'Cardiolog√≠a','Neumolog√≠a','Endocrinolog√≠a y Nutrici√≥n','Gastroenterolog√≠a','Nefrolog√≠a',
    'Hematolog√≠a y Hemoterapia','Oncolog√≠a M√©dica','Oncolog√≠a Radioter√°pica','Reumatolog√≠a','Alergolog√≠a e Inmunolog√≠a Cl√≠nica',
    'Medicina del Deporte','Medicina F√≠sica y Rehabilitaci√≥n','Geriatr√≠a','Infectolog√≠a','Dermatolog√≠a','Neurolog√≠a',
    'Gen√©tica M√©dica','Cuidados Paliativos'],
  'Especialidades quir√∫rgicas':[ 'Cirug√≠a Cardiovascular','Cirug√≠a Tor√°cica','Cirug√≠a Pedi√°trica',
    'Cirug√≠a Pl√°stica, Est√©tica y Reparadora','Cirug√≠a Oral y Maxilofacial','Neurocirug√≠a','Traumatolog√≠a y Ortopedia','Urolog√≠a',
    'Otorrinolaringolog√≠a','Oftalmolog√≠a','Proctolog√≠a / Coloproctolog√≠a','Cirug√≠a Vascular y Endovascular'],
  'Especialidades m√©dico-quir√∫rgicas':[ 'Otorrinolaringolog√≠a','Oftalmolog√≠a','Dermatolog√≠a','Urolog√≠a',
    'Ginecolog√≠a y Obstetricia','Cirug√≠a Oral y Maxilofacial'],
  'Especialidades diagn√≥sticas':[ 'Radiolog√≠a e Imagen Diagn√≥stica','Medicina Nuclear','Anatom√≠a Patol√≥gica',
    'Laboratorio Cl√≠nico / Bioqu√≠mica Cl√≠nica','Gen√©tica y Biolog√≠a Molecular','Hematolog√≠a de Laboratorio'],
  'Subespecialidades frecuentes':[ 'Cardiolog√≠a Intervencionista','Neurofisiolog√≠a Cl√≠nica','Oncolog√≠a Pedi√°trica',
    'Endocrinolog√≠a Pedi√°trica','Neumolog√≠a Pedi√°trica','Medicina Materno-Fetal','Neurocirug√≠a Pedi√°trica',
    'Cirug√≠a Oncol√≥gica','Radiolog√≠a Intervencionista','Gastroenterolog√≠a Pedi√°trica']
};

function populateRegisterOptions(){
  const countrySel=$('#r-country');
  countrySel.innerHTML='<option value="">Seleccione</option>';
  COUNTRIES.forEach(c=>countrySel.append(new Option(c,c)));
  const specSel=$('#r-specialty');
  specSel.innerHTML='<option value="">Seleccione</option>';
  for(const [grp,list] of Object.entries(SPECIALTIES)){
    const og=document.createElement('optgroup');
    og.label=grp;
    list.forEach(name=>{const o=document.createElement('option');o.value=name;o.textContent=name;og.appendChild(o);});
    specSel.appendChild(og);
  }
  specSel.append(new Option('Otro','Otro'));
}
async function doRegister(){
  const name=$('#r-name').value.trim();
  const u=$('#r-user').value.trim();
  const p1=$('#r-pass1').value;
  const p2=$('#r-pass2').value;
  const dob=$('#r-dob').value;
  const country=$('#r-country').value;
  let specialty=$('#r-specialty').value;
  if(specialty==='Otro') specialty=$('#r-specialty-other').value.trim();
  if(!name||!u||!p1||!p2||!dob||!country||!specialty){toast('Completa campos');return;}
  if(p1!==p2){toast('Contrase√±as no coinciden');return;}
  try{
    const cred=await createUserWithEmailAndPassword(window.firebaseAuth,u,p1);
    const profile={email:u,nombre:name,nacimiento:dob,pais:country,especialidad:specialty};
    try{
      await setDoc(doc(window.firestore,'users',cred.user.uid),profile);
    }catch(e){console.error('Profile save error',e);}
    window.__profile=profile;
    if(!(await ensureContract(cred.user.uid,name))){
      await signOut(window.firebaseAuth);
      toast('Debes aceptar el contrato');
      return;
    }
    $('#dlg-register').close();
    window.dispatchEvent(new CustomEvent('user-signed-up',{detail:{user:cred.user}}));
    toast('Usuario creado. Bienvenido.');
  }catch(err){
    console.error('Register error',err);
    let msg='Error al registrar';
    if(err.code==='auth/invalid-email') msg='Correo inv√°lido';
    else if(err.code==='auth/email-already-in-use') msg='Correo ya registrado';
    else if(err.code==='auth/weak-password') msg='Contrase√±a muy d√©bil';
    msg=unauthorizedDomainMessage(err)||msg;
    toast(msg);
  }
}
async function doLogin(){
  const u=$('#auth-user').value.trim();
  const p=$('#auth-pass').value;
  let cred;
  try{
    cred=await signInWithEmailAndPassword(window.firebaseAuth,u,p);
  }catch(err){
    console.error('Login error',err);
    let msg='Credenciales incorrectas';
    if(err.code==='auth/user-not-found') msg='Correo no registrado';
    else if(err.code==='auth/wrong-password') msg='Contrase√±a incorrecta';
    else if(err.code==='auth/invalid-credential') msg='Credenciales incorrectas';
    msg=unauthorizedDomainMessage(err)||msg;
    toast(msg);
    return;
  }
  window.__user=cred.user;
  if($('#remember').checked){
    localStorage.setItem('remember', JSON.stringify({u, p:btoa(p)}));
  }
  try{
    const snap=await getDoc(doc(window.firestore,'users',cred.user.uid));
    window.__profile=snap.exists()?snap.data():{};
  }catch(e){
    console.error('Profile load error',e);
    window.__profile={};
  }
  if(!(await ensureContract(cred.user.uid, window.__profile?.nombre||cred.user.email||u))){
    await signOut(window.firebaseAuth);
    toast('Debes aceptar el contrato');
    return;
  }
  $('#top-username').textContent=window.__profile?.nombre||cred.user.email||u;
  await showApp();
}
async function doRecover(){
  const email=$('#rec-email').value.trim();
  if(!email){toast('Ingresa tu correo');return;}
  try{
    await sendPasswordResetEmail(window.firebaseAuth,email);
    $('#rec-msg').textContent='Revisa tu correo para restablecer la contrase√±a.';
  }catch(err){
    console.error('Recover error',err);
    let msg='Error al enviar';
    if(err.code==='auth/invalid-email') msg='Correo inv√°lido';
    else if(err.code==='auth/user-not-found') msg='Correo no registrado';
    msg=unauthorizedDomainMessage(err)||msg;
    toast(msg);
  }
}

async function loginGoogle(){
  try{
    const cred=await signInWithPopup(window.firebaseAuth,new GoogleAuthProvider());
    window.__user=cred.user;
    try{
      const uSnap=await getDoc(doc(window.firestore,'users',cred.user.uid));
      window.__profile=uSnap.exists()?uSnap.data():{};
    }catch(e){ console.error('Profile load',e); window.__profile={}; }
    if(!(await ensureContract(cred.user.uid, cred.user.displayName||cred.user.email||'Usuario'))){
      await signOut(window.firebaseAuth);
      toast('Debes aceptar el contrato');
      return;
    }
    $('#top-username').textContent=window.__profile?.nombre||cred.user.email||'Usuario';
    await showApp();
  }catch(err){ console.error('Google login',err); const msg=unauthorizedDomainMessage(err)||err.message; toast('Google: '+msg); }
}

let phoneConfirm;
function openPhone(){ $('#phone-step1').classList.remove('hidden'); $('#phone-step2').classList.add('hidden'); $('#dlg-phone').showModal(); if(!window.recaptchaVerifier){ window.recaptchaVerifier=new RecaptchaVerifier('recaptcha-container',{size:'invisible'},window.firebaseAuth); window.recaptchaVerifier.render(); }}
async function sendPhoneCode(){ const num=$('#phone-number').value.trim(); try{ phoneConfirm=await signInWithPhoneNumber(window.firebaseAuth,num,window.recaptchaVerifier); $('#phone-step1').classList.add('hidden'); $('#phone-step2').classList.remove('hidden'); }catch(err){ console.error('Phone send',err); const msg=unauthorizedDomainMessage(err)||err.message; toast('Tel√©fono: '+msg); }}
async function verifyPhoneCode(){ const code=$('#phone-code').value.trim(); try{ const cred=await phoneConfirm.confirm(code); window.__user=cred.user; $('#dlg-phone').close(); try{ const uSnap=await getDoc(doc(window.firestore,'users',cred.user.uid)); window.__profile=uSnap.exists()?uSnap.data():{}; }catch(e){ console.error('Profile load',e); window.__profile={}; } if(!(await ensureContract(cred.user.uid, cred.user.phoneNumber||'Usuario'))){ await signOut(window.firebaseAuth); toast('Debes aceptar el contrato'); return; } $('#top-username').textContent=window.__profile?.nombre||cred.user.phoneNumber||'Usuario'; await showApp(); }catch(err){ console.error('Phone verify',err); toast('C√≥digo incorrecto'); }}

/********* Config *********/
/********* Config *********/
const OPENAI_MODEL = 'gpt-4.1';

const OPENAI_MODEL_NAME = (function brand(model){
  const m = String(model || '').toLowerCase().trim();

  // ‚Äî‚Äî GPT-5 (todas las variantes) ‚Äî‚Äî
  if (/^gpt-5.*nano/.test(m)) return 'healthia-5-nano ecr';
  if (/^gpt-5.*mini/.test(m)) return 'healthia-5-mini ecr';
  if (/^gpt-5/.test(m))       return 'healthia-5-pro ecr';    // gpt-5, gpt-5o, etc.

  // ‚Äî‚Äî GPT-4.1 (todas las variantes) ‚Äî‚Äî
  if (/^gpt-4\.1.*nano/.test(m)) return 'healthia-4.1-nano';
  if (/^gpt-4\.1.*mini/.test(m)) return 'healthia-4.1-mini';
  if (/^gpt-4\.1/.test(m))       return 'healthia-4.1-pro';

  // ‚Äî‚Äî Razonadores familia "o*" (por si acaso) ‚Äî‚Äî
  if (/^(o[0-9]|o4o)/.test(m)) return 'healthia-5-pro ecr';

  // ‚Äî‚Äî Fallback ‚Äî‚Äî
  return 'healthia';
})(OPENAI_MODEL);


// Detecta si estamos en localhost
const API_BASE = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost'
  ? '/api'
  : 'https://us-central1-healthia-6088a.cloudfunctions.net/api';


async function exportDB(){
  const stores=['users','patients','histories','config','invoices','catalog','lookups','appointments','reminders'];
  const data={};
  for(const s of stores){ data[s]=await getAllData(s); }
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='healthia_db.json';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Base exportada');
}

async function downloadCloudDB(){
  const auth=window.firebaseAuth, db=window.firestore;
  if(!auth||!auth.currentUser||!db){ toast('Sin sesi√≥n'); return; }
  const uid=auth.currentUser.uid;
  const stores=['patients','histories','appointments','reminders','config','invoices','catalog','lookups'];
  const data={};
  for(const s of stores){
    const snap=await getDocs(collection(db,'users',uid,s));
    data[s]=snap.docs.map(d=>d.data());
  }
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='healthia_cloud_'+uid+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Datos descargados');
}

function norm(t){return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function parseAP(text){
  const map={
    tabaquismo:'cig',
    alcohol:'alc',
    drogas:'dro',
    cafe:'cafe',
    te:'te',
    'patologias cronicas':'cron',
    transfusiones:'trans',
    traumatismos:'traum',
    quirurgicos:'quir'
  };
  const res={};
  text.split(';').forEach(seg=>{const [k,v]=seg.split(':').map(s=>s&&s.trim());if(!k) return;const key=map[norm(k)];if(key) res[key]=v||'';});
  return res;
}
function parseAH(text){const res={};text.split(';').forEach(seg=>{const [k,v]=seg.split(':').map(s=>s&&s.trim());if(!k) return;const nk=norm(k);if(nk.startsWith('padre')) res.padre=v||''; else if(nk.startsWith('madre')) res.madre=v||''; else if(nk.startsWith('hijos')) res.hijos=v||''; else if(nk.startsWith('herman')) res.hermanos=v||'';});return res;}
function formatAP(o){
  return [
    o.cig && `Tabaquismo: ${o.cig}`,
    o.alc && `Alcohol: ${o.alc}`,
    o.dro && `Drogas: ${o.dro}`,
    o.cafe && `Cafe: ${o.cafe}`,
    o.te && `Te: ${o.te}`,
    o.cron && `Patologias cronicas: ${o.cron}`,
    o.trans && `Transfusiones: ${o.trans}`,
    o.traum && `Traumatismos: ${o.traum}`,
    o.quir && `Quirurgicos: ${o.quir}`
  ].filter(Boolean).join('; ');
}
function formatAH(o){
  return [
    o.padre && `Padre: ${o.padre}`,
    o.madre && `Madre: ${o.madre}`,
    o.hijos && `Hijos: ${o.hijos}`,
    o.hermanos && `Hermanos: ${o.hermanos}`
  ].filter(Boolean).join('; ');
}

async function importDB(e){
  const file=e.target.files[0];
  if(!file) return;
  const finish=async()=>{
    await loadReminders();
    await loadAppointments();
    await Promise.all(['ars','religion','ocup','nac'].map(loadLookups));
    await listPatients($('#q-name').value,$('#f-date').value);
    toast('Base importada');
    e.target.value='';
  };
  try{
    if(file.name.endsWith('.json')){
      const text=await file.text();
      const data=JSON.parse(text);
      for(const [s,rows] of Object.entries(data)){
        await idbClear(s);
        if(Array.isArray(rows)) for(const row of rows) await saveData(s,row);
      }
      await finish();
    }else if(file.name.endsWith('.db')){
      const reader=new FileReader();
      reader.onload=async()=>{
        try{
          const SQL=await initSqlJs({locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}`});
          const sqlite=new SQL.Database(new Uint8Array(reader.result));
          const map={
            users:'users',usuarios:'users',
            patients:'patients',pacientes:'patients',
            histories:'histories',historias:'histories',historias_clinicas:'histories',
            config:'config',
            invoices:'invoices',facturas:'invoices',
            catalog:'catalog',catalogo:'catalog',
            lookups:'lookups',
            appointments:'appointments',citas:'appointments',
            reminders:'reminders',recordatorios:'reminders'
          };
          for(const t of Object.keys(map)){
            const store=map[t];
            await idbClear(store);
            try{
              const res=sqlite.exec(`SELECT * FROM ${t}`)[0];
              if(res){
                const cols=res.columns;
                for(const row of res.values){
                  const obj={}; cols.forEach((c,i)=>obj[c]=row[i]);
                  if(store==='patients'){
                    const rec={
                      id:obj.id,
                      nombre:obj.nombre||'',
                      doc:obj.documento_id||obj.doc||'',
                      fecha:obj.fecha_nacimiento||obj.fecha||null,
                      sexo:obj.sexo||'',
                      alergias:obj.alergias||'',
                      tel:obj.telefono||'',
                      dir:obj.direccion||'',
                      nacionalidad:obj.nacionalidad||'',
                      ocup:obj.ocupacion||'',
                      medfijos:obj.medicamentos_continuos||'',
                      ars:obj.ars||'',
                      religion:obj.religion||'',
                      dxprev:obj.diagnosticos_previos||'',
                      sangre:obj.tipo_sangre||'',
                      talla:obj.altura||null,
                      go:{
                        gesta:obj.gestas_previas||'',
                        partos:obj.partos_vaginales||obj.nacidos_vivos||'',
                        cesa:obj.cesareas||'',
                        aborto:obj.abortos||'',
                        sono:obj.embarazo_inicio||''
                      }
                    };
                    await saveData(store,rec);
                  }else if(store==='histories'){
                    const rec={
                      id:obj.id,
                      pid:obj.paciente_id||obj.pid,
                      title:'Historia Cl√≠nica',
                      input:obj.historia_enfermedad||obj.input||'',
                      out:(obj.sugerencias_ia||obj.out||'')+(obj.interaccion_ia?`\n${obj.interaccion_ia}`:''),
                      t:obj.fecha?new Date(obj.fecha).getTime():obj.t||Date.now(),
                      antecedentes_personales:obj.antecedentes_personales||"",
                      antecedentes_familiares:obj.antecedentes_heredofamiliares||"",
                      presion_arterial:obj.presion_arterial||"",
                      frecuencia_cardiaca:obj.frecuencia_cardiaca||"",
                      frecuencia_respiratoria:obj.frecuencia_respiratoria||"",
                      temperatura:obj.temperatura||"",
                      saturacion_oxigeno:obj.saturacion_oxigeno||"",
                      vitals:{},
                    };
                    const apTxt=rec.antecedentes_personales;
                    const ahTxt=rec.antecedentes_familiares;
                    if(apTxt) rec.ap=parseAP(apTxt);
                    if(ahTxt) rec.ah=parseAH(ahTxt);
                    rec.vitals={
                      pa:rec.presion_arterial,
                      fc:rec.frecuencia_cardiaca,
                      fr:rec.frecuencia_respiratoria,
                      temp:rec.temperatura,
                      oxi:rec.saturacion_oxigeno,
                      gli:'',
                      col:'',
                      peso:'',
                      unit:'kg',
                      imc:'',
                      cat:''
                    };
                    try{
                      const vres=sqlite.exec(`SELECT * FROM signos_vitales WHERE historia_id=${obj.id}`)[0];
                      if(vres&&vres.values.length){
                        const vobj={}; vres.columns.forEach((c,i)=>vobj[c]=vres.values[0][i]);
                        rec.vitals={
                          pa:rec.vitals.pa||vobj.presion||'',
                          fc:rec.vitals.fc||vobj.frecuencia||'',
                          fr:rec.vitals.fr||vobj.frecuencia_respiratoria||'',
                          gli:vobj.glicemia||'',
                          col:vobj.colesterol||'',
                          oxi:rec.vitals.oxi||vobj.oximetria||'',
                          temp:rec.vitals.temp||vobj.temperatura||'',
                          peso:vobj.peso||'',
                          unit:vobj.peso_unidad||'kg',
                          imc:vobj.imc||'',
                          cat:''
                        };
                      }
                    }catch{}
                    await saveData(store,rec);
                    if(apTxt||ahTxt || Object.values(rec.vitals).some(v=>v)){
                      const p=await idbGet('patients',rec.pid)||{id:rec.pid};
                      if(apTxt) p.ap=parseAP(apTxt);
                      if(ahTxt) p.ah=parseAH(ahTxt);
                      if(Object.values(rec.vitals).some(v=>v)) p.v=rec.vitals;
                      await saveData('patients',p);
                    }
                    }else{
                      await saveData(store,obj);
                    }
                }
              }
            }catch{}
          }
          await finish();
        }catch(err){ toast('Error importando'); e.target.value=''; }
      };
      reader.readAsArrayBuffer(file);
    }
  }catch(err){ toast('Error importando'); e.target.value=''; }
}

/********* Perfil *********/
async function loadProfile(){
  $('#prof-doctor').value=(await idbGet('config','doctor'))?.v||'';
  $('#prof-hospital').value=(await idbGet('config','hospital'))?.v||'';
  $('#prof-email').value=(await idbGet('config','hospital_email'))?.v||'';
  $('#prof-address').value=(await idbGet('config','hospital_address'))?.v||'';
  $('#prof-phone').value=(await idbGet('config','hospital_phone'))?.v||'';
}
async function saveProfile(){
  await saveData('config',{k:'doctor',v:$('#prof-doctor').value.trim()});
  await saveData('config',{k:'hospital',v:$('#prof-hospital').value.trim()});
  await saveData('config',{k:'hospital_email',v:$('#prof-email').value.trim()});
  await saveData('config',{k:'hospital_address',v:$('#prof-address').value.trim()});
  await saveData('config',{k:'hospital_phone',v:$('#prof-phone').value.trim()});
  toast('Datos guardados');
  $('#dlg-profile').close();
}

/********* Patients *********/
function normText(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
async function listPatients(q = '', d = '', onlyAppt = false) {
  let all = [];
  const auth = firebaseAuth;
  const db = firestore;
  if (auth?.currentUser && db) {
    try {
      const uid = auth.currentUser.uid;
      const snap = await getDocs(collection(db, 'users', uid, 'patients'));
      all = snap.docs.map(d => d.data());
    } catch (e) {
      console.error('Buscar pacientes (Firestore)', e);
      try { await idbClear('patients'); } catch {}
      all = [];
    }
  } else {
    all = await idbAll('patients');
  }
  const ql=normText(q);
  let rows=all.filter(p=>{
    const name=normText(p.nombre);
    const doc=normText(p.doc);
    return name.includes(ql) || String(p.id||'').includes(ql) || doc.includes(ql);
  });
  let apptMap;
  if(onlyAppt){
    const date=d||today();
    const appts=await idbAll('appointments');
    const todays=appts.filter(a=>a.fecha===date);
    const ids=new Set(todays.map(a=>a.pid));
    apptMap=new Map(todays.map(a=>[a.pid,a.hora]));
    rows=rows.filter(p=>ids.has(p.id));
  }else if(d){
    const start=new Date(d); if(!isNaN(start)){ start.setHours(0,0,0,0); const end=new Date(start); end.setDate(start.getDate()+1);
      const hist=await idbAll('histories');
      const ids=new Set(hist.filter(h=>h.t>=start.getTime() && h.t<end.getTime()).map(h=>h.pid));
      rows=rows.filter(p=>ids.has(p.id));
    }
  }
  const tbody=$('#tbl-patients'); tbody.innerHTML='';
  rows.forEach(p=>{
    const tr=document.createElement('tr');
    tr.dataset.id=p.id;
    tr.className='hover:bg-gray-50 cursor-pointer transition';
    const a=calcAge(p.fecha);
    const age=Number.isFinite(a) ? a : Number(p.edad);
    const icon=`<img src="${avatarUrl(p.nombre,p.sexo,age)}" class="w-5 h-5 inline-block rounded-full mr-1 object-cover ring-2 ring-brand-300 ring-offset-1 ring-white shadow-sm" alt="avatar"/>`;
    const cita=apptMap? apptMap.get(p.id)||'' : p.cita||'';
    tr.innerHTML=`<td>${p.id}</td><td>${icon}${p.nombre||''}</td><td>${cita}</td><td class="actions text-center hidden"><button class="btn btn-icon" title="Medicaci√≥n fija"><i class="ic fa-solid fa-pills"></i></button> <button class="btn btn-icon" title="Editar"><i class="ic fa-solid fa-pen"></i></button> <button class="btn btn-icon btn--danger" title="Eliminar"><i class="ic fa-solid fa-trash"></i></button></td>`;
    const [mb,eb,db]=tr.querySelectorAll('button');
    mb.addEventListener('click',e=>{e.stopPropagation();selectPatient(p.id).then(()=>openFixedMed());});
    eb.addEventListener('click',e=>{e.stopPropagation();selectPatient(p.id).then(()=>openPatientForm(true));});
    db.addEventListener('click',e=>{e.stopPropagation();selectPatient(p.id).then(()=>delPatient());});
    tr.addEventListener('click',()=>selectPatient(p.id));
    tbody.appendChild(tr);
  });
  highlightSelectedPatient();
}

function searchPatients(){
  listPatients($('#q-name').value.trim(), $('#f-date').value);
}
function highlightSelectedPatient(){
  $$('#tbl-patients tr').forEach(tr=>{
    tr.classList.remove('bg-brand-50','font-bold','ring-2','ring-brand-500','shadow-sm');
    const a=tr.querySelector('.actions'); if(a) a.classList.add('hidden');
  });
  if(window.__pid){
    const tr=$(`#tbl-patients tr[data-id="${window.__pid}"]`);
    if(tr){ tr.classList.add('bg-brand-50','font-bold','ring-2','ring-brand-500','shadow-sm'); const a=tr.querySelector('.actions'); if(a) a.classList.remove('hidden'); }
  }
  updatePatientButtons();
}
function updatePatientButtons(){
  $('#p-edit').disabled=!window.__pid;
  $('#p-del').disabled=!window.__pid;
}
function calcAge(fecha){
  if (!fecha) return NaN;
  const d=new Date(fecha);
  if (isNaN(d)) return NaN;
  return Math.floor((Date.now()-d.getTime())/31557600000);
}
function calcSemana(f){ if(!f) return ''; const d=new Date(f); if(isNaN(d)) return ''; return Math.floor((Date.now()-d.getTime())/604800000); }
const AVATAR_BUST = Date.now();
function avatarUrl(name,sex,age){
  const ver = AVATAR_BUST;
  const g = /^f/i.test(sex || '') || /mujer/i.test(sex || '') ? 'f' : 'm';
  let ageNum = Number(age);
  if (!isFinite(ageNum) || ageNum < 0) ageNum = 99;
  const isBaby = ageNum < 3;
  const isChild = ageNum < 18;
  if (g === 'f') {
    return isBaby
      ? `/avatars/baby-girl.svg?v=${ver}`
      : (isChild ? `/avatars/girl.svg?v=${ver}` : `/avatars/female.svg?v=${ver}`);
  }
  return isBaby
    ? `/avatars/baby-boy.svg?v=${ver}`
    : (isChild ? `/avatars/boy.svg?v=${ver}` : `/avatars/male.svg?v=${ver}`);
}

async function fillPatientDatalist(){
  const dl=$('#dl-patients');
  dl.innerHTML='';
  const pats=await idbAll('patients');
  pats.forEach(p=>{const o=document.createElement('option');o.value=p.nombre; dl.appendChild(o);});
  return pats;
}
function toggleObCard(p){ const card=$('#card-ob'); const age=calcAge(p.fecha); const show=p.sexo==='Femenino' && age>=10 && age<=55; card.classList.toggle('hidden',!show); }
function updateInfoCard(p){
  $('#info-nombre').textContent = p.nombre || '';
  $('#info-doc').textContent = p.doc || '';
  $('#info-fecha').textContent = p.fecha || '';
  const ageInput = $('#dlg-p-edad');
  let age = calcAge(p.fecha);
  if (!Number.isFinite(age) && p.edad) age = Number(p.edad);
  $('#info-edad').textContent = Number.isFinite(age) ? age + ' a√±os' : '';
  if (ageInput) ageInput.value = Number.isFinite(age) ? age : '';
  $('#info-sexo').textContent = p.sexo || '';
  $('#info-avatar').innerHTML = `<img src="${avatarUrl(p.nombre,p.sexo,age)}" alt="avatar" class="w-full h-full object-cover"/>`;
  $('#info-nac').textContent = p.nacionalidad || '';
  $('#info-alergias').textContent = p.alergias || '';
  $('#info-tel').textContent = p.tel || '';
  $('#info-dir').textContent = p.dir || '';
  $('#info-ocup').textContent = p.ocup || '';
  $('#info-medfijos').textContent = p.medfijos || '';
  $('#info-ars').textContent = p.ars || '';
  $('#info-religion').textContent = p.religion || '';
  $('#info-sangre').textContent = p.sangre || '';
  $('#info-altura').textContent = p.talla ? p.talla + ' cm' : '';
  $('#info-dxprev').textContent = p.dxprev || '';
  toggleObCard(p);
}
async function saveAntecedentes(){
  if(!window.__pid) return;
  const p=await idbGet('patients',window.__pid)||{};
  p.ap={
    cig:$('#ap-cig').value.trim(),
    alc:$('#ap-alc').value.trim(),
    dro:$('#ap-dro').value.trim(),
    cafe:$('#ap-cafe').value.trim(),
    te:$('#ap-te').value.trim(),
    cron:$('#ap-cron').value.trim(),
    trans:$('#ap-trans').value.trim(),
    traum:$('#ap-traum').value.trim(),
    quir:$('#ap-quir').value.trim()
  };
  p.ah={
    padre:$('#ah-padre').value.trim(),
    madre:$('#ah-madre').value.trim(),
    hijos:$('#ah-hijos').value.trim(),
    hermanos:$('#ah-hermanos').value.trim()
  };
  p.go={
    gesta:$('#go-gesta').value.trim(),
    partos:$('#go-partos').value.trim(),
    cesa:$('#go-cesa').value.trim(),
    aborto:$('#go-aborto').value.trim(),
    sono:$('#go-sono').value
  };
  await saveData('patients',p);
}

async function saveVitals(){
  if(!window.__pid) return;
  const p=await idbGet('patients',window.__pid)||{};
  p.v={
    pa:$('#v-pa').value.trim(),
    fc:$('#v-fc').value.trim(),
    fr:$('#v-fr').value.trim(),
    gli:$('#v-gli').value.trim(),
    col:$('#v-col').value.trim(),
    oxi:$('#v-oxi').value.trim(),
    temp:$('#v-temp').value.trim(),
    peso:$('#v-peso').value.trim(),
    unit:$('#v-unit').value,
    imc:$('#v-imc').value,
    cat:$('#v-imc-cat').value
  };
  await saveData('patients',p);
}

async function openFixedMed(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const p=await idbGet('patients',window.__pid);
  $('#medfijos-box').value=p?.medfijos||'';
  $('#dlg-fixedmed').showModal();
}
async function saveFixedMed(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const p=await idbGet('patients',window.__pid)||{};
  p.medfijos=$('#medfijos-box').value.trim();
  await saveData('patients',p);
  toast('Medicaci√≥n fija guardada');
  $('#dlg-fixedmed').close();
}

function popupReminder(rec){
  $('#rem-alert-msg').textContent=`${rec.titulo}${rec.motivo?' - '+rec.motivo:''}${rec.paciente?' - '+rec.paciente:''}`;
  $('#dlg-rem-alert').showModal();
  if(Notification.permission==='granted'){
    new Notification(rec.titulo,{body:new Date(rec.fecha).toLocaleString()});
  }
}
function scheduleReminder(rec){
  const ms=new Date(rec.fecha).getTime()-Date.now();
  if(ms<=0){popupReminder(rec);return;}
  const showTime=ms>5*60*1000?ms-5*60*1000:ms;
  setTimeout(()=>popupReminder(rec),showTime);
}
async function loadReminders(){
  reminders=await getAllData('reminders');
  const pats=await idbAll('patients');
  reminders.forEach(r=>{
    if(!r.paciente && r.pid){
      const p=pats.find(x=>x.id===r.pid);
      if(p) r.paciente=p.nombre;
    }
    scheduleReminder(r);
  });
  renderReminders();
}
function renderReminders(){
  const ul=$('#rem-list'); ul.innerHTML='';
  reminders.forEach(r=>{
    const li=document.createElement('li');
    li.className='flex justify-between items-center';
      li.innerHTML=`<span class="${r.done?'line-through':''}">${r.titulo}${r.motivo?' - '+r.motivo:''}${r.paciente?' - '+r.paciente:''} - ${new Date(r.fecha).toLocaleString()}</span>`+
        `<div class='flex gap-1'><button class='btn btn-icon' onclick='toggleReminder(${r.id})'><i class="ic fa-solid fa-check"></i></button>`+
        `<button class='btn btn-icon btn--danger' onclick='delReminder(${r.id})'><i class="ic fa-solid fa-xmark"></i></button></div>`;
    ul.appendChild(li);
  });
}
async function addReminder(e){
  e.preventDefault();
  const titulo=$('#rem-title').value.trim();
  const motivo=$('#rem-motive').value.trim();
  const name=$('#rem-patient').value.trim();
  const fecha=$('#rem-date').value;
  if(!titulo||!fecha) return;
  let pid=null,paciente='';
  if(name){
    const pats=await idbAll('patients');
    const p=pats.find(x=>x.nombre.toLowerCase()===name.toLowerCase());
    if(p){pid=p.id; paciente=p.nombre;} else {paciente=name;}
  }
  const rec={titulo,motivo,fecha,pid,paciente,done:false};
  rec.id=await saveData('reminders',rec);
  reminders.push(rec);
  renderReminders();
  scheduleReminder(rec);
  e.target.reset();
}
async function delReminder(id){
  reminders=reminders.filter(r=>r.id!==id);
  await deleteData('reminders',id);
  renderReminders();
}
async function toggleReminder(id){
  const r=reminders.find(x=>x.id===id); if(!r) return;
  r.done=!r.done;
  await updateData('reminders',id,{done:r.done});
  renderReminders();
}
async function openReminders(){
  const pats=await fillPatientDatalist();
  $('#rem-patient').value='';
  if(window.__pid){ const p=pats.find(x=>x.id===window.__pid); if(p) $('#rem-patient').value=p.nombre; }
  renderReminders();
  $('#dlg-reminders').showModal();
  if(Notification.permission==='default') Notification.requestPermission();
}

async function loadAppointments(){
  appointments=await getAllData('appointments');
  const pats=await idbAll('patients');
  appointments.forEach(a=>{
    if(!a.paciente && a.pid){
      const p=pats.find(x=>x.id===a.pid);
      if(p) a.paciente=p.nombre;
    }
  });
  renderAppointments();
}
function renderAppointments(){
  const tb=$('#appt-table tbody'); tb.innerHTML='';
  appointments.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.paciente||''}</td><td>${a.fecha}</td><td>${a.hora}</td><td>${a.motivo}</td>`+
      `<td class='text-center'><button class='btn btn-icon btn--danger' onclick='delAppointment(${a.id})'><i class="ic fa-solid fa-xmark"></i></button></td>`;
    tb.appendChild(tr);
  });
}
async function addAppointment(e){
  e.preventDefault();
  const name=$('#appt-patient').value.trim();
  const fecha=$('#appt-date').value;
  const hora=$('#appt-time').value;
  const motivo=$('#appt-motive').value.trim();
  if(!name||!fecha||!hora||!motivo) return;
  const pats=await idbAll('patients');
  const p=pats.find(x=>x.nombre.toLowerCase()===name.toLowerCase());
  const appt={pid:p?p.id:null,paciente:p?p.nombre:name,fecha,hora,motivo};
  appt.id=await saveData('appointments',appt);
  appointments.push(appt);
  renderAppointments();
  e.target.reset();
}
async function delAppointment(id){
  appointments=appointments.filter(a=>a.id!==id);
  await deleteData('appointments',id);
  renderAppointments();
}
async function openAppointments(){
  const pats=await fillPatientDatalist();
  $('#appt-patient').value='';
  if(window.__pid){ const p=pats.find(x=>x.id===window.__pid); if(p) $('#appt-patient').value=p.nombre; }
  $('#appt-date').value=today();
  renderAppointments();
  $('#dlg-appointments').showModal();
}
function openDaily(){
  $('#daily-start').value=today();
  $('#daily-end').value=today();
  $('#dlg-daily').showModal();
}
async function generateDaily(e){
  if(e) e.preventDefault();
  try{
    const s=$('#daily-start').value;
    const en=$('#daily-end').value;
    if(!s||!en){toast('Seleccione fechas');return;}
    const ini=new Date(s);
    const fin=new Date(en); fin.setHours(23,59,59,999);
    const hist=await idbAll('histories');
    const rows=hist.filter(h=>h.t>=ini.getTime()&&h.t<=fin.getTime()).sort((a,b)=>a.t-b.t);
    if(!rows.length){toast('Sin registros');return;}
    const csv=[]; const data=[]; const header=['No.','FECHA','PACIENTE','FICHA','C√âDULA/NUI','NO. SEGURO','EDAD','SEXO','NAC.','DIRECCI√ìN','R√âGIMEN ARS','LUGAR','FRECUENCIA','SERVICIO','TIPO ATENCI√ìN','DIAGN√ìSTICO'];
    const delim=';';
    csv.push(header.join(delim)); data.push(header);
    const title=`REGISTRO DIARIO DE CONSULTA (${formatDateShort(ini)} - ${formatDateShort(fin)})`;
    let html=`<h3 class="text-center mb-2 font-bold">${title}</h3><table><thead><tr>`+header.map(h=>`<th>${h}</th>`).join('')+`</tr></thead><tbody>`;
    let i=1;
    for(const h of rows){
      const p=await idbGet('patients',h.pid)||{};
      const edad=p.fecha? (Number.isFinite(calcAge(p.fecha))?calcAge(p.fecha):'') : '';
      const diagRaw=extractDiag(h);
      const diagHtml=diagList(diagRaw);
      const diagText=diagRaw.replace(/\n+/g,' ');
      const row=[i,formatDateShort(h.t),p.nombre||'',p.ficha||'',p.doc||'',p.seguro||'',edad,p.sexo||'',p.nacionalidad||'',p.dir||'',p.ars||'Ninguna',h.lugar||'',h.freq||'',h.serv||'',h.tipo||'',diagText];
      csv.push(row.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(delim));
      data.push(row);
      html+=`<tr><td>${i}</td><td>${formatDateShort(h.t)}</td><td>${p.nombre||''}</td><td>${p.ficha||''}</td><td>${p.doc||''}</td><td>${p.seguro||''}</td><td>${edad}</td><td>${p.sexo||''}</td><td>${p.nacionalidad||''}</td><td>${p.dir||''}</td><td>${p.ars||'Ninguna'}</td><td>${h.lugar||''}</td><td>${h.freq||''}</td><td>${h.serv||''}</td><td>${h.tipo||''}</td><td class="diag">${diagHtml}</td></tr>`;
      i++;
    }
    html+='</tbody></table>';
    const cont=$('#daily-print');
    cont.innerHTML=html;
    cont.classList.remove('hidden');
    await new Promise(r=>requestAnimationFrame(r));
    const canvas=await html2canvas(cont,{scale:2});
    cont.classList.add('hidden');
    const img=canvas.toDataURL('image/png');
    const { jsPDF }=window.jspdf; const pdf=new jsPDF('l','mm','a4');
    const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=canvas.height*pdfW/canvas.width;
    pdf.addImage(img,'PNG',0,0,pdfW,pdfH);
    pdf.save(`informe_${s}_${en}.pdf`);
    downloadCSV(csv,`informe_${s}_${en}.csv`);
    downloadXLSX(data,`informe_${s}_${en}.xlsx`);
    $('#dlg-daily').close();
  }catch(err){
    console.error(err);
    toast('Error generando informe');
  }
}

/* ====== Facturaci√≥n ====== */
let cart=[];
async function openBilling(){
  if(!window.__pid){toast('Seleccione un paciente');return;}
  const pats=await idbGet('patients',window.__pid);
  $('#inv-patient').value=pats?.nombre||'';
  $('#inv-doc').value=pats?.doc||'';
  $('#inv-number').value=String((await idbAll('invoices')).length+1).padStart(6,'0');
  $('#inv-date').value=today();
  $('#inv-terms').value='Contado';
  $('#inv-ars').value=pats?.ars||'';
  $('#inv-discount').value='0';
  $('#inv-insure').value='0';
  $('#pay-method').value='Efectivo';
  $('#pay-cash').classList.add('hidden');
  $('#pay-card').classList.add('hidden');
  cart=[]; renderItems(); computeTotals();
  $('#dlg-invoice').showModal();
}
async function renderInvoices(pid){
  const invs=(await idbAll('invoices')).filter(i=>i.pid===pid);
  const tbody=$('#tbl-invoices');
  tbody.innerHTML=invs.map(inv=>{
    const desc=inv.items[0]?.name||'';
    return `<tr data-id="${inv.id}"><td>${inv.date}</td><td>${inv.number}</td><td>${desc}</td><td class="text-right">${inv.total.toFixed(2)}</td><td><button class="btn btn-icon" data-pdf="${inv.id}"><i class="ic fa-solid fa-file-pdf"></i></button><button class="btn btn-icon btn--danger" data-del="${inv.id}"><i class="ic fa-solid fa-xmark"></i></button></td></tr>`;
  }).join('');
}
async function renderCatalog(){
  const items=await idbAll('catalog');
  const tbody=$('#tbl-catalog');
  tbody.innerHTML=items.sort((a,b)=>a.name.localeCompare(b.name)).map(i=>`<tr data-code="${i.code}"><td>${i.code}</td><td>${i.name}</td><td>${i.price.toFixed(2)}</td><td>${i.tax}</td><td><button class="btn btn-icon btn--danger" data-del="${i.code}"><i class="ic fa-solid fa-xmark"></i></button></td></tr>`).join('');
}
async function addCatalog(){
  const code=$('#cat-code').value.trim();
  const name=$('#cat-name').value.trim();
  const price=parseFloat($('#cat-price').value)||0;
  const tax=parseFloat($('#cat-tax').value)||0;
  if(!code||!name){toast('C√≥digo y nombre requeridos');return;}
  await saveData('catalog',{code,name,price,tax});
  $('#cat-code').value=''; $('#cat-name').value=''; $('#cat-price').value=''; $('#cat-tax').value='';
  renderCatalog();
}
$('#tbl-catalog').addEventListener('click',async e=>{
  const c=e.target.dataset.del; if(c){await deleteData('catalog',c); renderCatalog();}
});
async function searchCatalog(term){
  const items=await idbAll('catalog');
  return items.find(i=>i.code===term || i.name.toLowerCase().includes(term.toLowerCase()));
}
async function addFromSearch(){
  const term=$('#it-search').value.trim();
  if(!term){return;}
  const item=await searchCatalog(term);
  const price=parseFloat($('#it-price').value)||item?.price||0;
  const qty=parseFloat($('#it-qty').value)||1;
  const obj={code:item?.code||'',name:item?item.name:term,price,qty,tax:item?.tax||0};
  pushItem(obj);
  $('#it-search').value=''; $('#it-price').value=''; $('#it-qty').value='1';
}
function pushItem(it){
  cart.push(it); renderItems(); computeTotals();
}
function renderItems(){
  const tbody=$('#tbl-items');
  tbody.innerHTML=cart.map((i,idx)=>`<tr data-idx="${idx}"><td>${i.code}</td><td>${i.name}</td><td>${i.qty}</td><td>${i.price.toFixed(2)}</td><td>${i.tax}</td><td>${(i.qty*i.price*(1+i.tax/100)).toFixed(2)}</td><td><button class="btn btn-icon btn--danger" data-del="${idx}"><i class="ic fa-solid fa-xmark"></i></button></td></tr>`).join('');
}
$('#tbl-items').addEventListener('click',e=>{const i=e.target.dataset.del; if(i!==undefined){cart.splice(i,1); renderItems(); computeTotals();}});
function computeTotals(){
  const sub=cart.reduce((s,i)=>s+i.qty*i.price,0);
  const tax=cart.reduce((s,i)=>s+i.qty*i.price*(i.tax||0)/100,0);
  const disc=parseFloat($('#inv-discount').value)||0;
  const insurePct=parseFloat($('#inv-insure').value)||0;
  const afterDisc=Math.max(0,sub+tax-disc);
  const insure=Math.max(0,afterDisc*insurePct/100);
  const total=Math.max(0,afterDisc-insure);
  $('#sum-sub').textContent=sub.toFixed(2);
  $('#sum-tax').textContent=tax.toFixed(2);
  $('#sum-disc').textContent=disc.toFixed(2);
  $('#sum-ins').textContent=insure.toFixed(2);
  $('#sum-total').textContent=total.toFixed(2);
  return {sub,tax,disc,insure,total};
}
$('#inv-discount').addEventListener('input',computeTotals);
$('#inv-insure').addEventListener('input',computeTotals);
$('#pay-method').addEventListener('change',()=>{
  const m=$('#pay-method').value; $('#pay-cash').classList.toggle('hidden',m!=='Mixto'); $('#pay-card').classList.toggle('hidden',m!=='Mixto');});
$('#it-search').addEventListener('keydown',async e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const term=$('#it-search').value.trim();
    const item=await searchCatalog(term);
    if(item && !$('#it-price').value){$('#it-search').value=item.name; $('#it-price').value=item.price; return;}
    addFromSearch();
  }
});
$('#it-add').addEventListener('click',addFromSearch);
async function saveInvoice(){
  if(!cart.length){toast('Agregue √≠tems');return;}
  const pid=window.__pid; const number=$('#inv-number').value; const date=$('#inv-date').value; const terms=$('#inv-terms').value; const ars=$('#inv-ars').value.trim();
  const totals=computeTotals();
  const insurePct=parseFloat($('#inv-insure').value)||0;
  const inv={pid,number,date,terms,ars,items:cart.slice(),discount:totals.disc,insurePct,sub:totals.sub,tax:totals.tax,insure:totals.insure,total:totals.total,pay:{method:$('#pay-method').value,cash:$('#pay-cash').value,card:$('#pay-card').value}};
  await saveData('invoices',inv);
  $('#dlg-invoice').close();
  renderInvoices(pid);
  toast('Factura guardada');
}
async function invoiceToPDF(inv){
  $('#pr-hospital').textContent=(await idbGet('config','hospital'))?.v||'';
  $('#pr-address').textContent=(await idbGet('config','hospital_address'))?.v||'';
  $('#pr-phone').textContent=(await idbGet('config','hospital_phone'))?.v||'';
  $('#pr-email').textContent=(await idbGet('config','hospital_email'))?.v||'';
  $('#pr-doctor').textContent=(await idbGet('config','doctor'))?.v||'';
  $('#pr-number').textContent=inv.number;
  $('#pr-date').textContent=inv.date;
  $('#pr-terms').textContent=inv.terms;
  $('#pr-ars').textContent=inv.ars;
  $('#pr-pay').textContent=inv.pay?.method||'';
  const p=await idbGet('patients',inv.pid);
  $('#pr-patient').textContent=p?.nombre||'';
  $('#pr-doc').textContent=p?.doc||'';
  $('#pr-addr').textContent=p?.dir||'';
  const tb=$('#pr-items tbody');
  tb.innerHTML=inv.items.map(i=>`<tr><td>${i.code}</td><td>${i.name}</td><td>${i.qty}</td><td>${i.price.toFixed(2)}</td><td>${i.tax}</td><td>${(i.qty*i.price*(1+i.tax/100)).toFixed(2)}</td></tr>`).join('');
  $('#pr-sub').textContent=inv.sub.toFixed(2);
  $('#pr-tax').textContent=inv.tax.toFixed(2);
  $('#pr-disc').textContent=inv.discount.toFixed(2);
  $('#pr-ins').textContent=inv.insure.toFixed(2);
  $('#pr-total').textContent=inv.total.toFixed(2);
  const cont=$('#invoice-print');
  cont.classList.remove('hidden');
  await new Promise(r=>requestAnimationFrame(r));
  const canvas=await html2canvas(cont,{scale:2});
  cont.classList.add('hidden');
  const img=canvas.toDataURL('image/png');
  const { jsPDF }=window.jspdf; const pdf=new jsPDF('p','mm','a4');
  const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=canvas.height*pdfW/canvas.width;
  pdf.addImage(img,'PNG',0,0,pdfW,pdfH);
  pdf.save(`Factura_${inv.number}.pdf`);
}
$('#inv-pdf').addEventListener('click',async()=>{const inv=await buildTempInvoice(); if(inv) await invoiceToPDF(inv);});
async function buildTempInvoice(){
  if(!cart.length){toast('Agregue √≠tems');return null;}
  const pid=window.__pid; const number=$('#inv-number').value; const date=$('#inv-date').value; const terms=$('#inv-terms').value; const ars=$('#inv-ars').value.trim();
  const totals=computeTotals();
  return {pid,number,date,terms,ars,items:cart.slice(),discount:totals.disc,insurePct:parseFloat($('#inv-insure').value)||0,sub:totals.sub,tax:totals.tax,insure:totals.insure,total:totals.total,pay:{method:$('#pay-method').value,cash:$('#pay-cash').value,card:$('#pay-card').value}};
}
$('#inv-save').addEventListener('click',saveInvoice);

$('#btn-open-catalog').addEventListener('click',()=>{renderCatalog(); $('#dlg-catalog').showModal();});
$('#cat-add').addEventListener('click',addCatalog);
$('#btn-invoices').addEventListener('click',()=>{renderInvoices(window.__pid); $('#dlg-invoices').showModal();});

$('#tbl-invoices').addEventListener('click',async e=>{
  const id=e.target.dataset.pdf||e.target.dataset.del;
  if(!id) return; const inv=await idbGet('invoices',+id); if(e.target.dataset.pdf){invoiceToPDF(inv);} else {await deleteData('invoices',+id); renderInvoices(window.__pid);}}
);
async function selectPatient(id){
  const all = await idbAll('patients');
  const p = all.find(x => x.id === id);
  if(!p) return;
  window.__pid = id;
  window.__hid = undefined;
  window.__pheight = p.talla || null;
  window.__pfecha = p.fecha || null;
  updateInfoCard(p);
  // antecedentes personales
  $('#ap-cig').value = p.ap?.cig || '';
  $('#ap-alc').value = p.ap?.alc || '';
  $('#ap-dro').value = p.ap?.dro || '';
  $('#ap-cafe').value = p.ap?.cafe || '';
  $('#ap-te').value = p.ap?.te || '';
  $('#ap-cron').value = p.ap?.cron || '';
  $('#ap-trans').value = p.ap?.trans || '';
  $('#ap-traum').value = p.ap?.traum || '';
  $('#ap-quir').value = p.ap?.quir || '';
  // antecedentes heredo-familiares
  $('#ah-padre').value = p.ah?.padre || '';
  $('#ah-madre').value = p.ah?.madre || '';
  $('#ah-hijos').value = p.ah?.hijos || '';
  $('#ah-hermanos').value = p.ah?.hermanos || '';
  // gineco-obstetricos
  $('#go-gesta').value = p.go?.gesta || '';
  $('#go-partos').value = p.go?.partos || '';
  $('#go-cesa').value = p.go?.cesa || '';
  $('#go-aborto').value = p.go?.aborto || '';
  $('#go-sono').value = p.go?.sono || '';
  $('#go-semana').value = calcSemana(p.go?.sono);
  // vitales
  $('#v-pa').value = p.v?.pa || '';
  $('#v-fc').value = p.v?.fc || '';
  $('#v-fr').value = p.v?.fr || '';
  $('#v-gli').value = p.v?.gli || '';
  $('#v-col').value = p.v?.col || '';
  $('#v-oxi').value = p.v?.oxi || '';
  $('#v-temp').value = p.v?.temp || '';
  $('#v-peso').value = p.v?.peso || '';
  $('#v-unit').value = p.v?.unit || 'kg';
  weightUnit = $('#v-unit').value;
  $('#v-imc').value = p.v?.imc || '';
  $('#v-imc-cat').value = p.v?.cat || '';
  updateIMC();
  updateVitalsLights();
// historias
renderHistories(id);
renderInvoices(id);
highlightSelectedPatient();
}
async function delPatient(){ if(!window.__pid){toast('Seleccione un paciente'); return;} await deleteData('patients', window.__pid); window.__pid=undefined; await listPatients($('#q-name').value,$('#f-date').value); toast('Eliminado'); }

async function newHistory(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const rec={
    pid: window.__pid,
    title:'Historia Cl√≠nica',
    input:'',
    out:'',
    t: Date.now(),
    ap:{},
    ah:{},
    vitals:{},
    antecedentes_personales:'',
    antecedentes_familiares:'',
    presion_arterial:'',
    frecuencia_cardiaca:'',
    frecuencia_respiratoria:'',
    temperatura:'',
    saturacion_oxigeno:''
  };
  rec.id=await saveData('histories',rec);
  window.__hid=rec.id;
  $('#h-actual').value='';
  autoResize($('#h-actual'));
  const out=$('#h-out');
  if(out){out.dataset.raw=''; out.textContent='';}
  ['#ap-cig','#ap-alc','#ap-dro','#ap-cafe','#ap-te','#ap-cron','#ap-trans','#ap-traum','#ap-quir',
   '#ah-padre','#ah-madre','#ah-hijos','#ah-hermanos',
   '#v-pa','#v-fc','#v-fr','#v-gli','#v-col','#v-oxi','#v-temp','#v-peso','#v-imc','#v-imc-cat']
    .forEach(sel=>{const el=$(sel); if(el) el.value='';});
  $('#v-unit').value='kg'; weightUnit='kg';
  updateIMC(); updateVitalsLights();
  await renderHistories(window.__pid);
  toast('Historia creada');
}

async function openPatientForm(edit=false){
  if(edit){
    if(!window.__pid){toast('Seleccione un paciente'); return;}
    const p=await idbGet('patients',window.__pid);
      if(!p){toast('Paciente no encontrado'); return;}
      window.__pid=p.id;
      $('#dlg-p-nombre').value=p?.nombre||'';
      $('#dlg-p-doc').value=p?.doc||'';
      $('#dlg-p-fecha').value=p?.fecha||'';
      $('#dlg-p-edad').value=p?.fecha? (Number.isFinite(calcAge(p.fecha))?calcAge(p.fecha):'') : '';
      $('#dlg-p-sexo').value=p?.sexo||'Masculino';
      $('#dlg-p-alergias').value=p?.alergias||'';
      $('#dlg-p-tel').value=p?.tel||'';
      $('#dlg-p-dir').value=p?.dir||'';
      $('#dlg-p-nac').value=p?.nacionalidad||'';
      $('#dlg-p-ocup').value=p?.ocup||'';
      $('#dlg-p-medfijos').value=p?.medfijos||'';
      $('#dlg-p-ars').value=p?.ars||'';
      $('#dlg-p-religion').value=p?.religion||'';
      $('#dlg-p-dxprev').value=p?.dxprev||'';
      $('#dlg-p-sangre').value=p?.sangre||'No sabe';
      updateInfoCard(p);
      $('#dlg-p-talla').value=p?.talla||'';
    }else{
      window.__pid=undefined;
      ['#dlg-p-nombre','#dlg-p-doc','#dlg-p-fecha','#dlg-p-edad','#dlg-p-alergias','#dlg-p-tel','#dlg-p-dir','#dlg-p-nac','#dlg-p-ocup','#dlg-p-medfijos','#dlg-p-ars','#dlg-p-religion','#dlg-p-dxprev','#dlg-p-talla'].forEach(s=>$(s).value='');
      $('#dlg-p-sexo').value='Masculino';
      $('#dlg-p-sangre').value='No sabe';
      updateInfoCard({});
    }
    $('#dlg-patient').showModal();
    enhanceCalendars();
  }

async function savePatientForm(e){
  e?.preventDefault();
  try {
    const data={ id:window.__pid?Number(window.__pid):undefined, nombre:$('#dlg-p-nombre').value.trim(), doc:$('#dlg-p-doc').value.trim(), fecha:$('#dlg-p-fecha').value||null, sexo:$('#dlg-p-sexo').value, alergias:$('#dlg-p-alergias').value.trim(), tel:$('#dlg-p-tel').value.trim(), dir:$('#dlg-p-dir').value.trim(), nacionalidad:$('#dlg-p-nac').value.trim(), ocup:$('#dlg-p-ocup').value.trim(), medfijos:$('#dlg-p-medfijos').value.trim(), ars:$('#dlg-p-ars').value.trim(), religion:$('#dlg-p-religion').value.trim(), dxprev:$('#dlg-p-dxprev').value.trim(), sangre:$('#dlg-p-sangre').value, talla:+$('#dlg-p-talla').value||null };
    if(!data.nombre){toast('El nombre es obligatorio'); return;}
    if(data.id===undefined || data.id===null || data.id==='' || Number.isNaN(data.id)){
      delete data.id;
    }else{
      data.id=Number(data.id);
      if(!Number.isInteger(data.id) || data.id<=0) delete data.id;
    }
    const prev=data.id? await idbGet('patients',data.id) : {};
    const rec={...prev,...data};
    delete rec.peso;
    if(!rec.id && rec.id!==0){ delete rec.id; }
    rec.id=await saveData('patients',rec);
    window.__pid=rec.id;
    window.__pheight = rec.talla || null;
    window.__pfecha = rec.fecha || null;
    await selectPatient(rec.id);
    await listPatients($('#q-name').value,$('#f-date').value);
    toast('Paciente guardado');
    $('#dlg-patient').close();
  } catch(err){
    console.error(err);
    toast(err.name+': '+err.message);
  }
}

/********* Histories *********/
async function renderHistories(pid){
  const list=await idbAll('histories');
  const rows=list.filter(h=>h.pid===pid).sort((a,b)=>b.t-a.t);
  const box=$('#history-list');
  box.innerHTML='';
  rows.forEach(h=>{
    const el=document.createElement('div');
    el.className='border border-gray-200 rounded-xl p-3 bg-gray-50 cursor-pointer hover:bg-white transition-all';
    const d=formatDateTime(h.t);
    el.innerHTML=`<i class="ic fa-solid fa-file-lines"></i> <b>${h.title}</b> ¬∑ <span class="text-gray-600 text-sm">${d}</span>`;
    const del=document.createElement('button');
    del.className='float-right text-gray-400 hover:text-red-500';
    del.innerHTML='<i class="ic fa-solid fa-trash"></i>';
    del.addEventListener('click',async e=>{
      e.stopPropagation();
      await deleteData('histories',h.id);
      if(window.__hid===h.id) window.__hid=undefined;
      toast('Historia eliminada');
      await renderHistories(pid);
    });
    el.appendChild(del);
    el.addEventListener('click',()=>{
      window.__hid=h.id;
      $('#h-actual').value=h.input||'';
      autoResize($('#h-actual'));
      const raw=h.out||'';
      $('#h-out').dataset.raw=raw;
      $('#h-out').innerHTML=mdToHtml(raw);
      $('#h-out').scrollTop=$('#h-out').scrollHeight;
      let apTxt='';
      if(h.ap || h.antecedentes_personales){
        const ap=h.ap||parseAP(h.antecedentes_personales||'');
        $('#ap-cig').value=ap.cig||'';
        $('#ap-alc').value=ap.alc||'';
        $('#ap-dro').value=ap.dro||'';
        $('#ap-cafe').value=ap.cafe||'';
        $('#ap-te').value=ap.te||'';
        $('#ap-cron').value=ap.cron||'';
        $('#ap-trans').value=ap.trans||'';
        $('#ap-traum').value=ap.traum||'';
        $('#ap-quir').value=ap.quir||'';
        apTxt=formatAP(ap);
        const apRaw=$('#antecedentes_personales'); if(apRaw) apRaw.value=apTxt;
      }
      let ahTxt='';
      if(h.ah || h.antecedentes_familiares){
        const ah=h.ah||parseAH(h.antecedentes_familiares||'');
        $('#ah-padre').value=ah.padre||'';
        $('#ah-madre').value=ah.madre||'';
        $('#ah-hijos').value=ah.hijos||'';
        $('#ah-hermanos').value=ah.hermanos||'';
        ahTxt=formatAH(ah);
        const ahRaw=$('#antecedentes_familiares'); if(ahRaw) ahRaw.value=ahTxt;
      }
      const paVal=h.vitals?.pa||h.presion_arterial||'';
      const fcVal=h.vitals?.fc||h.frecuencia_cardiaca||'';
      const frVal=h.vitals?.fr||h.frecuencia_respiratoria||'';
      const oxiVal=h.vitals?.oxi||h.saturacion_oxigeno||'';
      const tempVal=h.vitals?.temp||h.temperatura||'';
      $('#v-pa').value=paVal;
      $('#v-fc').value=fcVal;
      $('#v-fr').value=frVal;
      $('#v-gli').value=h.vitals?.gli||'';
      $('#v-col').value=h.vitals?.col||'';
      $('#v-oxi').value=oxiVal;
      $('#v-temp').value=tempVal;
      $('#v-unit').value=h.vitals?.unit||'kg';
      weightUnit=$('#v-unit').value;
      $('#v-peso').value=h.vitals?.peso||'';
      $('#v-imc').value=h.vitals?.imc||'';
      $('#v-imc-cat').value=h.vitals?.cat||'';
      updateIMC();
      updateVitalsLights();
      const paRaw=$('#presion_arterial'); if(paRaw) paRaw.value=paVal;
      const fcRaw=$('#frecuencia_cardiaca'); if(fcRaw) fcRaw.value=fcVal;
      const frRaw=$('#frecuencia_respiratoria'); if(frRaw) frRaw.value=frVal;
      const tempRaw=$('#temperatura'); if(tempRaw) tempRaw.value=tempVal;
      const oxiRaw=$('#saturacion_oxigeno'); if(oxiRaw) oxiRaw.value=oxiVal;
      $$('#history-list .selected').forEach(n=>n.classList.remove('ring-2','ring-brand-500','bg-brand-50','shadow-sm','selected'));
      el.classList.add('ring-2','ring-brand-500','bg-brand-50','shadow-sm','selected');
    });
    if(window.__hid===h.id){
      el.classList.add('ring-2','ring-brand-500','bg-brand-50','shadow-sm','selected');
    }
    box.appendChild(el);
  });
}
async function saveHistory(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const isNew=!window.__hid;
  const ap={
    cig:$('#ap-cig').value.trim(),
    alc:$('#ap-alc').value.trim(),
    dro:$('#ap-dro').value.trim(),
    cafe:$('#ap-cafe').value.trim(),
    te:$('#ap-te').value.trim(),
    cron:$('#ap-cron').value.trim(),
    trans:$('#ap-trans').value.trim(),
    traum:$('#ap-traum').value.trim(),
    quir:$('#ap-quir').value.trim()
  };
  const ah={
    padre:$('#ah-padre').value.trim(),
    madre:$('#ah-madre').value.trim(),
    hijos:$('#ah-hijos').value.trim(),
    hermanos:$('#ah-hermanos').value.trim()
  };
  const vitals={
    pa:$('#v-pa').value.trim(),
    fc:$('#v-fc').value.trim(),
    fr:$('#v-fr').value.trim(),
    gli:$('#v-gli').value.trim(),
    col:$('#v-col').value.trim(),
    oxi:$('#v-oxi').value.trim(),
    temp:$('#v-temp').value.trim(),
    peso:$('#v-peso').value.trim(),
    unit:$('#v-unit').value,
    imc:$('#v-imc').value,
    cat:$('#v-imc-cat').value
  };
  const apTxt=formatAP(ap);
  const ahTxt=formatAH(ah);
  const rec={
    id: window.__hid,
    pid: window.__pid,
    title: 'Historia Cl√≠nica',
    input: $('#h-actual').value.trim(),
    out: ($('#h-out').dataset.raw||'').trim(),
    t: Date.now(),
    ap, ah, vitals,
    antecedentes_personales: apTxt,
    antecedentes_familiares: ahTxt,
    presion_arterial: vitals.pa,
    frecuencia_cardiaca: vitals.fc,
    frecuencia_respiratoria: vitals.fr,
    temperatura: vitals.temp,
    saturacion_oxigeno: vitals.oxi
  };
  const apRaw=$('#antecedentes_personales'); if(apRaw) apRaw.value=apTxt;
  const ahRaw=$('#antecedentes_familiares'); if(ahRaw) ahRaw.value=ahTxt;
  const paRaw=$('#presion_arterial'); if(paRaw) paRaw.value=vitals.pa;
  const fcRaw=$('#frecuencia_cardiaca'); if(fcRaw) fcRaw.value=vitals.fc;
  const frRaw=$('#frecuencia_respiratoria'); if(frRaw) frRaw.value=vitals.fr;
  const tempRaw=$('#temperatura'); if(tempRaw) tempRaw.value=vitals.temp;
  const oxiRaw=$('#saturacion_oxigeno'); if(oxiRaw) oxiRaw.value=vitals.oxi;
  try{
    rec.id = await saveData('histories', rec);
  }catch(err){
    if(err && err.name === 'DataError' && isNew){
      try{
        rec.id = Date.now();
        await saveData('histories', rec);
      }catch(err2){
        console.error('saveHistory retry error:', err2);
        throw err2;
      }
    }else{
      console.error('saveHistory error:', err);
      throw err;
    }
  }
  window.__hid=rec.id;
  await saveAntecedentes();
  await saveVitals();
  toast(isNew?'Historia guardada':'Historia actualizada');
  await renderHistories(window.__pid);
}
async function delHistory(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  if(!window.__hid){toast('Seleccione una historia'); return;}
  await deleteData('histories', window.__hid);
  window.__hid=undefined;
  toast('Historia eliminada');
  await renderHistories(window.__pid);
}

/********* OpenAI *********/
async function openaiChat(messages){ const model=OPENAI_MODEL; const res=await fetch(`${API_BASE}/openai-chat`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({model,temperature:0.6,messages})}); if(!res.ok){ throw new Error(await res.text()); } const data=await res.json(); return data.choices?.[0]?.message?.content||''; }
async function openaiChatStream(messages,onDelta){ const model=OPENAI_MODEL; const res=await fetch(`${API_BASE}/openai-chat-stream`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({model,temperature:0.6,stream:true,messages})}); if(!res.ok){ throw new Error(await res.text()); } const reader=res.body.getReader(); const decoder=new TextDecoder(); let full=''; while(true){ const {value,done}=await reader.read(); if(done) break; const chunk=decoder.decode(value); const lines=chunk.split('\n'); for(const line of lines){ if(line.startsWith('data: ')){ const data=line.replace('data: ','').trim(); if(data==='[DONE]') return full; try{ const json=JSON.parse(data); const token=json.choices?.[0]?.delta?.content||''; if(token){ full+=token; onDelta && onDelta(token,full); } }catch(e){} } } } return full; }
function boldSections(text){
  const sections=[
    'Motivo de la consulta',
    'Historia de Enfermedad Actual',
    'Revisi√≥n por Sistemas',
    'Antecedentes Personales',
    'Antecedentes hereditarios familiares',
    'Diagn√≥sticos',
    'Diagn√≥sticos Diferenciales',
    'Plan Terap√©utico',
    'Cambios y Cuidados en el Estilo de Vida',
    'Plan de Educaci√≥n',
    'Evaluaci√≥n Adicional',
    'Referimientos y An√°lisis Complementarios',
    'Objetivos y Pron√≥stico',
    'Conclusiones'
  ];
  sections.forEach(s=>{
    const re=new RegExp(s,'gi');
    text=text.replace(re,m=>`**${m}**`);
  });
  return text;
}
function formatDateLong(ts){
  const d=new Date(ts);
  const meses=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  return `${d.getDate()} de ${meses[d.getMonth()]} ${d.getFullYear()}`;
}
function formatDateTime(ts){
  const d=new Date(ts);
  const hh=String(d.getHours()).padStart(2,'0');
  const mm=String(d.getMinutes()).padStart(2,'0');
  return `${formatDateLong(ts)} ${hh}:${mm}`;
}
function formatDateShort(ts){
  const d=new Date(ts);
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  return `${dd}/${mm}/${d.getFullYear()}`;
}

function extractDiag(h){
  // 1) Prefer explicit structured fields if present
  if (h.dx && Array.isArray(h.dx) && h.dx.length){
    return h.dx.join('; ');
  }
  if (h.cie || h.cie10 || h.diag || h.diagnostico){
    const v = h.cie || h.cie10 || h.diag || h.diagnostico;
    if (typeof v === 'string' && v.trim()) return v.trim();
    if (Array.isArray(v) && v.length) return v.join('; ');
  }

  // 2) Fallback: extract from the narrative (h.out) between "Diagn√≥sticos" and the next section
  let text = h.out || '';
  if (!text || !text.trim()) return '';

  // Normalize
  text = text.replace(/\r/g,'').replace(/\t/g,' ').replace(/\*{1,3}/g,''); // strip markdown **

  // Section headers that indicate the end of the Diagn√≥sticos block
  const stops = [
    'Diagn√≥sticos Diferenciales', 'Diferenciales', 'Plan Terap√©utico', 'Plan de Tratamiento',
    'Plan', 'Tratamiento', 'Cambios y Cuidados en el Estilo de Vida', 'Plan de Educaci√≥n',
    'Evaluaci√≥n Adicional', 'Referimientos', 'Objetivos y Pron√≥stico', 'Conclusiones',
    'Revisi√≥n por Sistemas', 'Historia de Enfermedad Actual', 'Antecedentes'
  ];
  const stopGroup = stops.map(s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|');
  const re = new RegExp(`Diagn[o√≥]sticos?(?:\s*\(CIE-?10\))?\s*[:\-]?\s*([\s\S]*?)(?=(?:${stopGroup})\\b|$)`, 'i');
  let m = text.match(re);
  let body = (m && m[1]) ? m[1] : '';

  if (!body.trim()){
    // Extra fallback: find a numbered list that looks like diagnoses near the end
    const reList = /(?:^|\n)\s*(?:\d+\.\s*.+?)(?:\n|$)/gi;
    const matches = text.match(reList);
    if (matches && matches.length){
      body = matches.join(' ');
    } else {
      // Last fallback: return first sentence mentioning CIE or DX keywords
      const sent = text.split(/(?<=\.)\s+/).find(s => /CIE|dx|diagn[o√≥]stic/i.test(s));
      body = sent || text.slice(0, 200);
    }
  }

  // Clean bullets/numbering and keep concise
  body = body.replace(/^\s*[-‚Ä¢]\s*/gm,'');   // bullets
  body = body.replace(/\n+/g,' ');            // newlines
  body = body.replace(/\s{2,}/g,' ').trim();  // extra spaces

  // If it has a numbered list, keep first 5
  const parts = body.split(/\s*\d+\.\s*/).filter(x => x && x.trim());
  if (parts.length > 1){
    body = parts.slice(0,5).map(x => x.replace(/\s*[;.,]+\s*$/,'').trim()).join('; ');
  }

  // Only append minimal vitals if no diagnosis text found
  if (!body){
    const vit = h.vitals || {};
    const vs = [];
    if (vit.pa) vs.push(`PA: ${vit.pa}`);
    if (vit.fc) vs.push(`FC: ${vit.fc}`);
    body = vs.join(' ');
  }
  return body;
}


function diagList(text){
  const items=text.split(/\d+\.\s*/).filter(x=>x.trim());
  if(!items.length) return text;
  return '<ol style="margin:0;padding-left:1.2em;text-align:justify;">'+items.map(x=>`<li>${x.trim().replace(/;?$/, ';')}</li>`).join('')+'</ol>';
}
function downloadCSV(rows,name){
  const blob=new Blob(['\ufeff'+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download=name;
  link.click();
  URL.revokeObjectURL(link.href);
}
function downloadXLSX(aoa,name){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  const colWidths=aoa[0].map((_,i)=>({wch:Math.max(...aoa.map(r=>String(r[i]??'').length))+2}));
  ws['!cols']=colWidths;
  const range=XLSX.utils.decode_range(ws['!ref']);
  const border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}};
  for(let R=range.s.r;R<=range.e.r;R++){
    for(let C=range.s.c;C<=range.e.c;C++){
      const addr=XLSX.utils.encode_cell({r:R,c:C});
      const cell=ws[addr];
      if(!cell) continue;
      cell.s=cell.s||{};
      cell.s.border=border;
      if(R===0){
        cell.s.font={bold:true};
        cell.s.alignment={horizontal:'center'};
        cell.s.fill={patternType:'solid',fgColor:{rgb:'FFD9D9D9'}};
      }
    }
  }
  ws['!autofilter']={ref:ws['!ref']};
  ws['!freeze']={xSplit:0,ySplit:1};
  XLSX.utils.book_append_sheet(wb,ws,'Informe');
  XLSX.writeFile(wb,name);
}
const PROMPT_INTERACT = `Lee la historia de enfermedad actual del paciente. Si falta informaci√≥n para una historia cl√≠nica completa, formula preguntas espec√≠ficas en vi√±etas cortas. Cuando consideres que ya tienes la informaci√≥n necesaria, responde con el mensaje: ‚úÖ Listo para generar historia cl√≠nica.`;
// PROMPT_HISTORY is loaded from prompt_history.js
const PROMPT_EXPLAIN = `Explica en t√©rminos sencillos y comprensibles para el paciente el siguiente texto cl√≠nico.`;
const PROMPT_IMAGE = `Analiza esta imagen y ofrece un diagn√≥stico basado √∫nicamente en lo que observas.`;
const PROMPT_RX = `Genera √∫nicamente una lista de los medicamentos indicados en espa√±ol. Utiliza el formato: 'acetaminofen 500 mg uso una tableta cada 4-6 horas v√≠a oral para cefalea por 5 d√≠as #30 pastillas'. No incluyas comentarios, notas ni c√≥digos.`;
const PROMPT_RX_EDIT = `Ajusta la siguiente receta seg√∫n las indicaciones dadas. Devuelve solo la lista final de medicamentos en espa√±ol.`;
const PROMPT_LAB = `Genera √∫nicamente una lista de pruebas de laboratorio en espa√±ol, una por l√≠nea y sin comentarios adicionales.`;
const PROMPT_LAB_EDIT = `Ajusta la siguiente lista de laboratorio seg√∫n las indicaciones dadas. Devuelve solo la lista final.`;
const PROMPT_IMG_IND = `Genera √∫nicamente una lista de estudios de imagen en espa√±ol (ej. tomograf√≠a, resonancia, ultrasonido, radiograf√≠a), una por l√≠nea y sin comentarios adicionales.`;
const PROMPT_IMG_IND_EDIT = `Ajusta la siguiente lista de estudios de imagen seg√∫n las indicaciones dadas. Devuelve solo la lista final.`;

let intakeMsgs=[], intakeTranscript='';
let imgMsgs=[];

function appendIntake(role,text){
  const line=document.createElement('div');
  line.className='chat-msg '+(role==='assistant'?'chat-msg--ai':'chat-msg--user');
  const bubble=document.createElement('div');
  bubble.className='chat-bubble';
  bubble.textContent=text;
  line.appendChild(bubble);
  $('#intake-box').append(line);
  $('#intake-box').scrollTop=$('#intake-box').scrollHeight;
}

async function intakeAsk(){
  try{
    const wrap=document.createElement('div');
    wrap.className='chat-msg chat-msg--ai';
    const holder=document.createElement('div');
    holder.className='chat-bubble';
    wrap.appendChild(holder);
    $('#intake-box').append(wrap);
    const full=await openaiChatStream(intakeMsgs,(tok,acc)=>{
      holder.textContent=acc;
      $('#intake-box').scrollTop=$('#intake-box').scrollHeight;
    });
    intakeMsgs.push({role:'assistant',content:full});
    intakeTranscript+=`IA: ${full}\n`;
    if(full.includes('‚úÖ')){
      $('#dlg-intake').close();
      aiGenerate(intakeTranscript);
    }
  }catch(e){ toast('OpenAI: '+e.message); }
}

async function startIntake(){
  if (!(await window.requireSubscription?.())) return;
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const motivo=$('#h-actual').value.trim();
  if(!motivo){toast('Escribe el motivo'); return;}
  $('#intake-box').innerHTML='';
  $('#intake-input').value='';
  autoResize($('#intake-input'));
  $('#dlg-intake').showModal();
  intakeMsgs=[{role:'system',content:'Eres una IA cl√≠nica rigurosa.'},{role:'user',content:`${PROMPT_INTERACT}\n\nTexto:\n${motivo}`}];
  intakeTranscript='';
  await intakeAsk();
}

$('#intake-send').addEventListener('click',async()=>{
  const val=$('#intake-input').value.trim();
  if(!val) return;
  $('#intake-input').value='';
  autoResize($('#intake-input'));
  intakeMsgs.push({role:'user',content:val});
  intakeTranscript+=`Paciente: ${val}\n`;
  appendIntake('user',val);
  await intakeAsk();
});

$('#intake-input').addEventListener('input',e=>autoResize(e.target));

$('#intake-copy').addEventListener('click',()=>{
  const last=[...$('#intake-box').querySelectorAll('.chat-msg--ai .chat-bubble')].pop();
  if(last){
    $('#intake-input').value=last.textContent;
    autoResize($('#intake-input'));
    $('#intake-input').focus();
  }
});
async function aiGenerate(extra=''){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const motivo=$('#h-actual').value.trim();
  if(!motivo && !extra){toast('Escribe el motivo'); return;}
  const btn=$('#h-gen');
  const prev=btn.innerHTML;
  btn.disabled=true; btn.innerHTML='‚åõ Generando...';
  $('#h-out').dataset.raw='';
  $('#h-out').textContent='';
  try{
    const p=await idbGet('patients', window.__pid);
    const fecha=formatDateLong(Date.now());
    const texto=extra? `${motivo}\n\n${extra}`:motivo;
    const content=`${PROMPT_HISTORY}\n${texto}\n\nFecha de atenci√≥n: ${fecha}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}`;
    let full=await openaiChatStream([{role:'system',content:'Eres una IA cl√≠nica.'},{role:'user',content}],(tok,acc)=>{
      const bold=boldSections(acc);
      $('#h-out').dataset.raw=acc;
      $('#h-out').innerHTML=mdToHtml(bold);
      $('#h-out').scrollTop=$('#h-out').scrollHeight;
    });
    full=boldSections(full.trim());
    $('#h-out').dataset.raw=full;
    $('#h-out').innerHTML=mdToHtml(full);
    await saveHistory();
  }catch(e){ toast('Error: '+e.message); }
  finally{
    btn.disabled=false; btn.innerHTML=prev;
  }
}
async function aiExplain(){
  const h=($('#h-out').dataset.raw||'').trim();
  if(!h){toast('Genera historia primero'); return;}
  const btn=$('#h-explain');
  const prev=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚åõ Generando...';
  $('#exp-box').dataset.raw='';
  $('#exp-box').innerHTML='';
  $('#dlg-explain').showModal();
  try{
    await openaiChatStream(
      [
        {role:'system',content:'Eres un m√©dico que explica de forma sencilla.'},
        {role:'user',content:`${PROMPT_EXPLAIN}\n\n${h}`}
      ],
      (tok,acc)=>{
        $('#exp-box').dataset.raw=acc;
        $('#exp-box').innerHTML=mdToHtml(acc);
        $('#exp-box').scrollTop=$('#exp-box').scrollHeight;
      }
    );
  }catch(e){ toast('OpenAI: '+e.message); }
  finally{ btn.disabled=false; btn.innerHTML=prev; }
}

let askMsgs=[], askContext='';

function appendAsk(role,text){
  const line=document.createElement('div');
  line.className='chat-msg '+(role==='assistant'?'chat-msg--ai':'chat-msg--user');
  const bubble=document.createElement('div');
  bubble.className='chat-bubble';
  bubble.textContent=text;
  line.appendChild(bubble);
  $('#ask-box').append(line);
  $('#ask-box').scrollTop=$('#ask-box').scrollHeight;
  return bubble;
}

async function startAskHistory(){
  if (!(await window.requireSubscription?.())) return;
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const p=await idbGet('patients',window.__pid);
  const hist=await idbAll('histories');
  const notes=hist.filter(h=>h.pid===window.__pid).map(h=>h.out||'').join('\n');
  askContext=`Datos del Paciente:\n${JSON.stringify(p,null,2)}`;
  if(notes) askContext+=`\nNotas previas:\n${notes}`;
  askMsgs=[];
  $('#ask-box').innerHTML='';
  appendAsk('assistant','¬°Bienvenido! Formule sus preguntas sobre el historial del paciente.');
  $('#ask-input').value='';
  autoResize($('#ask-input'));
  $('#dlg-ask').showModal();
}

async function askHistory(){
  const q=$('#ask-input').value.trim();
  if(!q) return;
  $('#ask-input').value='';
  autoResize($('#ask-input'));
  appendAsk('user',q);
  askMsgs.push({role:'user',content:`${askContext}\n\nPregunta: ${q}`});
  const bubble=appendAsk('assistant','');
  try{
    const full=await openaiChatStream([{role:'system',content:'Eres un asistente m√©dico que responde en espa√±ol con concisi√≥n.'}, ...askMsgs],(tok,acc)=>{ bubble.textContent=acc; $('#ask-box').scrollTop=$('#ask-box').scrollHeight; });
    askMsgs.push({role:'assistant',content:full});
  }catch(e){ bubble.textContent='[Error]'; toast('OpenAI: '+e.message); }
}

async function aiPrescription(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const btn=$('#h-rx');
  const prev=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚åõ Generando...';
  try{
    const p=await idbGet('patients', window.__pid);
    const sugerencias='';
    const historia=($('#h-out').dataset.raw||'').trim();
    const contexto=`Medications:\n${sugerencias}\n\nContinuous Medications:\n${p.medfijos||''}\n\nPatient Allergies:\n${p.alergias||''}\n\nHistoria:\n${historia}`;
    const content=`${PROMPT_RX}\n\n${contexto}`;
    const age=calcAge(p.fecha);
    $('#rx-header').innerHTML=`<b>Paciente:</b> ${p.nombre||''}<br><b>ID:</b> ${p.doc||''}<br><b>Edad:</b> ${age||''} <b>Sexo:</b> ${p.sexo||''}<br><b>Fecha:</b> ${formatDateTime(Date.now())}`;
    $('#rx-box').dataset.raw='';
    $('#rx-box').innerHTML='';
    $('#dlg-rx').showModal();
    await openaiChatStream([
      {role:'system',content:'Eres un asistente m√©dico.'},
      {role:'user',content}
    ],(tok,acc)=>{
      $('#rx-box').dataset.raw=acc;
      $('#rx-box').innerHTML=mdToHtml(acc);
      $('#rx-box').scrollTop=$('#rx-box').scrollHeight;
    });
  }catch(e){ toast('Error: '+e.message); }
  finally{ btn.disabled=false; btn.innerHTML=prev; }
}

async function aiModifyRx(){
  const instr=$('#rx-prompt').value.trim();
  if(!instr){toast('Describe cambios'); return;}
  const curr=$('#rx-box').dataset.raw||'';
  $('#rx-prompt').value='';
  const content=`${PROMPT_RX_EDIT}\n\nReceta actual:\n${curr}\n\nInstrucciones:\n${instr}`;
  $('#rx-box').dataset.raw='';
  $('#rx-box').innerHTML='';
  await openaiChatStream([
    {role:'system',content:'Eres un asistente m√©dico.'},
    {role:'user',content}
  ],(tok,acc)=>{
    $('#rx-box').dataset.raw=acc;
    $('#rx-box').innerHTML=mdToHtml(acc);
    $('#rx-box').scrollTop=$('#rx-box').scrollHeight;
  });
}

async function printRx(){
  const rx=$('#rx-box').dataset.raw||'';
  if(!rx){toast('Genera receta'); return;}
  const p=await idbGet('patients', window.__pid);
  const doctor=(await idbGet('config','doctor'))?.v||'';
  const hospital=(await idbGet('config','hospital'))?.v||'';
  const email=(await idbGet('config','hospital_email'))?.v||'';
  const address=(await idbGet('config','hospital_address'))?.v||'';
  const phone=(await idbGet('config','hospital_phone'))?.v||'';
  const fecha=formatDateTime(Date.now());
  const rxHtml=mdToHtml(rx);
  const content=`<div style="font-family:sans-serif;padding:40px;">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:3rem">‚öïÔ∏è</div>
      <h1 style="margin:0;font-size:1.5rem">${hospital}</h1>
      <div>${address}<br>${email}${phone? '<br>Tel: '+phone:''}</div>
    </div>
    <div style="margin-bottom:20px"><strong>Paciente:</strong> ${p.nombre||''}<br><strong>ID:</strong> ${p.doc||''}<br><strong>Fecha:</strong> ${fecha}</div>
    <div style="white-space:pre-wrap">${rxHtml}</div>
    <div style="margin-top:40px;text-align:right;">${doctor}</div>
  </div>`;
  const container=document.createElement('div');
  container.style.position='fixed';
  container.style.left='-10000px';
  container.style.top='0';
  container.innerHTML=content;
  document.body.appendChild(container);
  const canvas=await html2canvas(container,{scale:2});
  const imgData=canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const pdfW=pdf.internal.pageSize.getWidth();
  const pdfH=canvas.height*pdfW/canvas.width;
  pdf.addImage(imgData,'PNG',0,0,pdfW,pdfH);
  const fname=`Receta_${(p.nombre||'paciente').replace(/\s+/g,'')}.pdf`;
  pdf.save(fname);
  document.body.removeChild(container);
  }

async function aiLab(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const btn=$('#h-lab');
  const prev=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚åõ Generando...';
  try{
    const p=await idbGet('patients', window.__pid);
    const historia=($('#h-out').dataset.raw||'').trim();
    const content=`${PROMPT_LAB}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}\n\nHistoria:\n${historia}`;
    const age=calcAge(p.fecha);
    $('#lab-header').innerHTML=`<b>Paciente:</b> ${p.nombre||''}<br><b>ID:</b> ${p.doc||''}<br><b>Edad:</b> ${age||''} <b>Sexo:</b> ${p.sexo||''}<br><b>Fecha:</b> ${formatDateTime(Date.now())}`;
    $('#lab-box').dataset.raw='';
    $('#lab-box').innerHTML='';
    $('#dlg-lab').showModal();
    await openaiChatStream([
      {role:'system',content:'Eres un asistente m√©dico.'},
      {role:'user',content}
    ],(tok,acc)=>{
      $('#lab-box').dataset.raw=acc;
      $('#lab-box').innerHTML=mdToHtml(acc);
      $('#lab-box').scrollTop=$('#lab-box').scrollHeight;
    });
  }catch(e){ toast('Error: '+e.message); }
  finally{ btn.disabled=false; btn.innerHTML=prev; }
}

async function aiModifyLab(){
  const instr=$('#lab-prompt').value.trim();
  if(!instr){toast('Describe cambios'); return;}
  const curr=$('#lab-box').dataset.raw||'';
  $('#lab-prompt').value='';
  const p=await idbGet('patients', window.__pid);
  const content=`${PROMPT_LAB_EDIT}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}\n\nLaboratorio actual:\n${curr}\n\nInstrucciones:\n${instr}`;
  $('#lab-box').dataset.raw='';
  $('#lab-box').innerHTML='';
  await openaiChatStream([
    {role:'system',content:'Eres un asistente m√©dico.'},
    {role:'user',content}
  ],(tok,acc)=>{
    $('#lab-box').dataset.raw=acc;
    $('#lab-box').innerHTML=mdToHtml(acc);
    $('#lab-box').scrollTop=$('#lab-box').scrollHeight;
  });
}

async function printLab(){
  const labs=$('#lab-box').dataset.raw||'';
  if(!labs){toast('Genera laboratorio'); return;}
  const p=await idbGet('patients', window.__pid);
  const doctor=(await idbGet('config','doctor'))?.v||'';
  const hospital=(await idbGet('config','hospital'))?.v||'';
  const email=(await idbGet('config','hospital_email'))?.v||'';
  const address=(await idbGet('config','hospital_address'))?.v||'';
  const phone=(await idbGet('config','hospital_phone'))?.v||'';
  const fecha=formatDateTime(Date.now());
  const labHtml=mdToHtml(labs);
  const content=`<div style="font-family:sans-serif;padding:20px;width:794px;">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:3rem">‚öïÔ∏è</div>
      <h1 style="margin:0;font-size:1.5rem">${hospital}</h1>
      <div>${address}<br>${email}${phone? '<br>Tel: '+phone:''}</div>
    </div>
    <div style="margin-bottom:20px"><strong>Paciente:</strong> ${p.nombre||''}<br><strong>ID:</strong> ${p.doc||''}<br><strong>Fecha:</strong> ${fecha}</div>
    <div style="white-space:pre-wrap">${labHtml}</div>
    <div style="margin-top:40px;text-align:right;">${doctor}</div>
  </div>`;
  const container=document.createElement('div');
  container.style.position='fixed';
  container.style.left='-10000px';
  container.style.top='0';
  container.innerHTML=content;
  document.body.appendChild(container);
  const canvas=await html2canvas(container,{scale:2});
  const imgData=canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const pdfW=pdf.internal.pageSize.getWidth();
  const pdfH=pdf.internal.pageSize.getHeight();
  const margin=10;
  const maxW=pdfW-margin*2;
  const maxH=pdfH-margin*2;
  const ratio=Math.min(maxW/canvas.width, maxH/canvas.height);
  const imgW=canvas.width*ratio;
  const imgH=canvas.height*ratio;
  pdf.addImage(imgData,'PNG',margin,margin,imgW,imgH);
  const fname=`Laboratorio_${(p.nombre||'paciente').replace(/\s+/g,'')}.pdf`;
  pdf.save(fname);
  document.body.removeChild(container);
}

async function aiImageInd(){
  if(!window.__pid){toast('Seleccione un paciente'); return;}
  const btn=$('#h-imgind');
  const prev=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚åõ Generando...';
  try{
    const p=await idbGet('patients', window.__pid);
    const historia=($('#h-out').dataset.raw||'').trim();
    const content=`${PROMPT_IMG_IND}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}\n\nHistoria:\n${historia}`;
    const age=calcAge(p.fecha);
    $('#imgind-header').innerHTML=`<b>Paciente:</b> ${p.nombre||''}<br><b>ID:</b> ${p.doc||''}<br><b>Edad:</b> ${age||''} <b>Sexo:</b> ${p.sexo||''}<br><b>Fecha:</b> ${formatDateTime(Date.now())}`;
    $('#imgind-box').dataset.raw='';
    $('#imgind-box').innerHTML='';
    $('#dlg-imgind').showModal();
    await openaiChatStream([
      {role:'system',content:'Eres un asistente m√©dico.'},
      {role:'user',content}
    ],(tok,acc)=>{
      $('#imgind-box').dataset.raw=acc;
      $('#imgind-box').innerHTML=mdToHtml(acc);
      $('#imgind-box').scrollTop=$('#imgind-box').scrollHeight;
    });
  }catch(e){ toast('Error: '+e.message); }
  finally{ btn.disabled=false; btn.innerHTML=prev; }
}

async function aiModifyImageInd(){
  const instr=$('#imgind-prompt').value.trim();
  if(!instr){toast('Describe cambios'); return;}
  const curr=$('#imgind-box').dataset.raw||'';
  $('#imgind-prompt').value='';
  const p=await idbGet('patients', window.__pid);
  const content=`${PROMPT_IMG_IND_EDIT}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}\n\nIm√°genes actuales:\n${curr}\n\nInstrucciones:\n${instr}`;
  $('#imgind-box').dataset.raw='';
  $('#imgind-box').innerHTML='';
  await openaiChatStream([
    {role:'system',content:'Eres un asistente m√©dico.'},
    {role:'user',content}
  ],(tok,acc)=>{
    $('#imgind-box').dataset.raw=acc;
    $('#imgind-box').innerHTML=mdToHtml(acc);
    $('#imgind-box').scrollTop=$('#imgind-box').scrollHeight;
  });
}

async function printImageInd(){
  const imgs=$('#imgind-box').dataset.raw||'';
  if(!imgs){toast('Genera indicaciones'); return;}
  const p=await idbGet('patients', window.__pid);
  const doctor=(await idbGet('config','doctor'))?.v||'';
  const hospital=(await idbGet('config','hospital'))?.v||'';
  const email=(await idbGet('config','hospital_email'))?.v||'';
  const address=(await idbGet('config','hospital_address'))?.v||'';
  const phone=(await idbGet('config','hospital_phone'))?.v||'';
  const fecha=formatDateTime(Date.now());
  const imgHtml=mdToHtml(imgs);
  const content=`<div style="font-family:sans-serif;padding:20px;width:794px;">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:3rem">‚öïÔ∏è</div>
      <h1 style="margin:0;font-size:1.5rem">${hospital}</h1>
      <div>${address}<br>${email}${phone? '<br>Tel: '+phone:''}</div>
    </div>
    <div style="margin-bottom:20px"><strong>Paciente:</strong> ${p.nombre||''}<br><strong>ID:</strong> ${p.doc||''}<br><strong>Fecha:</strong> ${fecha}</div>
    <div style="white-space:pre-wrap">${imgHtml}</div>
    <div style="margin-top:40px;text-align:right;">${doctor}</div>
  </div>`;
  const container=document.createElement('div');
  container.style.position='fixed';
  container.style.left='-10000px';
  container.style.top='0';
  container.innerHTML=content;
  document.body.appendChild(container);
  const canvas=await html2canvas(container,{scale:2});
  const imgData=canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const pdfW=pdf.internal.pageSize.getWidth();
  const pdfH=pdf.internal.pageSize.getHeight();
  const margin=10;
  const maxW=pdfW-margin*2;
  const maxH=pdfH-margin*2;
  const ratio=Math.min(maxW/canvas.width, maxH/canvas.height);
  const imgW=canvas.width*ratio;
  const imgH=canvas.height*ratio;
  pdf.addImage(imgData,'PNG',margin,margin,imgW,imgH);
  const fname=`Imagenes_${(p.nombre||'paciente').replace(/\s+/g,'')}.pdf`;
  pdf.save(fname);
  document.body.removeChild(container);
}

function appendImg(role,text){
  const line=document.createElement('div');
  line.className='chat-msg '+(role==='assistant'?'chat-msg--ai':'chat-msg--user');
  const bubble=document.createElement('div');
  bubble.className='chat-bubble';
  bubble.textContent=text;
  line.appendChild(bubble);
  $('#img-box').append(line);
  $('#img-box').scrollTop=$('#img-box').scrollHeight;
  return bubble;
}

async function aiImage(){
  const inp=document.createElement('input');
  inp.type='file';
  inp.accept='image/*';
  inp.onchange=async e=>{
    const f=e.target.files[0];
    if(!f) return;
    const reader=new FileReader();
    reader.onload=async()=>{
      const b64=reader.result.split(',')[1];
      const p=await idbGet('patients', window.__pid);
      imgMsgs=[
        {role:'system',content:'Eres un asistente m√©dico experto. Debes responder con un diagn√≥stico breve basado solo en la imagen proporcionada. No hagas preguntas ni solicites informaci√≥n adicional.'},
        {role:'user',content:[{type:'text',text:`${PROMPT_IMAGE}\n\nDatos del Paciente:\n${JSON.stringify(p,null,2)}`},{type:'image_url',image_url:{url:`data:image/jpeg;base64,${b64}`}}]}
      ];
      $('#img-box').innerHTML='';
      $('#img-input').value='';
      autoResize($('#img-input'));
      $('#dlg-img').showModal();
      const bubble=appendImg('assistant','');
      try{
        const full=await openaiChatStream(imgMsgs,(tok,acc)=>{ bubble.textContent=acc; $('#img-box').scrollTop=$('#img-box').scrollHeight; });
        imgMsgs.push({role:'assistant',content:full});
      }catch(err){ bubble.textContent='[Error]'; toast('OpenAI: '+err.message); }
    };
    reader.readAsDataURL(f);
  };
  inp.click();
}

async function imgSend(){
  const val=$('#img-input').value.trim();
  if(!val) return;
  appendImg('user',val);
  imgMsgs.push({role:'user',content:val});
  $('#img-input').value='';
  autoResize($('#img-input'));
  const bubble=appendImg('assistant','');
  try{
    const full=await openaiChatStream(imgMsgs,(tok,acc)=>{ bubble.textContent=acc; $('#img-box').scrollTop=$('#img-box').scrollHeight; });
    imgMsgs.push({role:'assistant',content:full});
  }catch(err){ bubble.textContent='[Error]'; toast('OpenAI: '+err.message); }
}




/********* Export Word (HTML doc) *********/
function exportWord(){
  const name = $('#info-nombre').textContent || 'paciente';
  const html = `<html>
<head><meta charset='utf-8'></head>
<body>
  ${mdToHtml($('#h-out').dataset.raw || '')}

</body>
</html>`;
  const blob = new Blob([html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${name}_historia.doc`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 100);
}

/********* Bindings *********/
function bind(){
  populateRegisterOptions();
  on('#open-register','click',()=>{
    $('#dlg-register').showModal();
    enhanceCalendars();
  });
  on('#r-specialty','change',e=>{ $('#r-spec-other-wrap').classList.toggle('hidden',e.target.value!=='Otro'); });
  on('#r-save','click',e=>{e.preventDefault(); doRegister();});
  on('#login','click',doLogin);
  on('#login-google','click',loginGoogle);
  on('#login-phone','click',openPhone);
  on('#phone-send','click',sendPhoneCode);
  on('#phone-verify','click',verifyPhoneCode);
  on('#open-recover','click',()=>$('#dlg-recover').showModal());
  on('#rec-send','click',e=>{e.preventDefault(); doRecover();});
  on('#btn-config','click',()=>$('#dlg-config').showModal());
  on('#cfg-export','click',exportDB);
  on('#cfg-import','click',()=>$('#cfg-file').click());
  on('#cfg-cloud','click',downloadCloudDB);
  on('#cfg-file','change',importDB);
  on('#btn-logout','click',async()=>{
    try{ await signOut(window.firebaseAuth); }catch(e){ console.error('SignOut error',e); }
    await clearAllStores();
    resetAppUI();
    localStorage.setItem('healthia_uid','');
    window.__user=null;
    showLogin();
  });
  on('#btn-user','click',async()=>{await loadProfile(); $('#dlg-profile').showModal();});
  on('#prof-save','click',e=>{e.preventDefault(); saveProfile();});
  // left
  on('#q-search','click',searchPatients);
  on('#q-name','input',searchPatients);
  on('#p-all','click',()=>{ $('#q-name').value=''; $('#f-date').value=''; listPatients(); });
  on('#p-appts','click',()=>listPatients($('#q-name').value.trim(),$('#f-date').value,true));
  on('#p-new','click',()=>openPatientForm(false));
  on('#p-edit','click',()=>openPatientForm(true));
  on('#p-del','click',delPatient);
  on('#f-apply','click',searchPatients);
  on('#h-new','click',newHistory);
  on('#medfijos-save','click',saveFixedMed);
  on('#act-appointments','click',openAppointments);
  on('#act-reminders','click',openReminders);
  on('#appt-form','submit',addAppointment);
  on('#rem-form','submit',addReminder);
  on('#act-billing','click',openBilling);
  on('#act-daily','click',openDaily);
  on('#daily-gen','click',generateDaily);
  on('#dlg-daily [value=cancel]','click',()=>$('#dlg-daily').close());
  on('#dlg-invoices [value=cancel]','click',()=>$('#dlg-invoices').close());
  ['#v-pa','#v-fc','#v-fr','#v-gli','#v-col','#v-oxi','#v-temp'].forEach(sel=>on(sel,'input',()=>{updateVitalsLights(); saveVitals();}));
  on('#v-peso','input',()=>{updateIMC(); updateVitalsLights(); saveVitals();});
  on('#v-unit','change',e=>{
    const u=e.target.value;
    const val=parseFloat($('#v-peso').value);
    if(!isNaN(val)){
      if(weightUnit==='kg'&&u==='lb') $('#v-peso').value=(val*2.20462).toFixed(1);
      if(weightUnit==='lb'&&u==='kg') $('#v-peso').value=(val/2.20462).toFixed(1);
    }
    weightUnit=u;
    updateIMC();
    updateVitalsLights();
    saveVitals();
  });
  on('#dlg-p-talla','input',()=>{window.__pheight=+$('#dlg-p-talla').value||null; updateIMC(); updateVitalsLights();});
  on('#h-actual','input',e=>{autoResize(e.target);});
  // history actions
  on('#h-save','click',saveHistory);
  on('#h-export','click',exportWord);
  on('#dlg-p-form','submit',savePatientForm);
  ['#dlg-p-nombre','#dlg-p-doc','#dlg-p-fecha','#dlg-p-edad','#dlg-p-sexo','#dlg-p-alergias','#dlg-p-tel','#dlg-p-dir','#dlg-p-nac','#dlg-p-ocup','#dlg-p-medfijos','#dlg-p-ars','#dlg-p-religion','#dlg-p-dxprev','#dlg-p-sangre','#dlg-p-talla'].forEach(sel=>on(sel,'input',()=>updateInfoCard({
      nombre: $('#dlg-p-nombre').value.trim(),
      doc: $('#dlg-p-doc').value.trim(),
      fecha: $('#dlg-p-fecha').value,
      edad: $('#dlg-p-edad').value.trim(),
      sexo: $('#dlg-p-sexo').value,
      alergias: $('#dlg-p-alergias').value.trim(),
      tel: $('#dlg-p-tel').value.trim(),
      dir: $('#dlg-p-dir').value.trim(),
      nacionalidad: $('#dlg-p-nac').value.trim(),
      ocup: $('#dlg-p-ocup').value.trim(),
      medfijos: $('#dlg-p-medfijos').value.trim(),
      ars: $('#dlg-p-ars').value.trim(),
      religion: $('#dlg-p-religion').value.trim(),
      dxprev: $('#dlg-p-dxprev').value.trim(),
      sangre: $('#dlg-p-sangre').value,
      talla: $('#dlg-p-talla').value
    })));
  on('#add-ars','click',()=>addLookup('ars'));
  on('#add-religion','click',()=>addLookup('religion'));
  on('#add-ocup','click',()=>addLookup('ocup'));
  on('#add-nac','click',()=>addLookup('nac'));
  ['#ap-cig','#ap-alc','#ap-dro','#ap-cafe','#ap-te','#ap-cron','#ap-trans','#ap-traum','#ap-quir','#ah-padre','#ah-madre','#ah-hijos','#ah-hermanos','#go-gesta','#go-partos','#go-cesa','#go-aborto','#go-sono'].forEach(sel=>on(sel,'input',()=>{ if(sel==='#go-sono') $('#go-semana').value=calcSemana($('#go-sono').value); saveAntecedentes(); }));
  $$('.collapse-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const body=$('#'+btn.dataset.target);
      const icon=btn.querySelector('i');
      body.classList.toggle('hidden');
      icon.classList.toggle('fa-minus');
      icon.classList.toggle('fa-plus');
    });
  });
  on('#h-gen','click',startIntake);
  on('#h-explain','click',aiExplain);
  on('#h-ask','click',startAskHistory);
  on('#h-image','click',aiImage);
  on('#h-rx','click',aiPrescription);
  on('#rx-ai','click',aiModifyRx);
  on('#rx-print','click',printRx);
  on('#h-lab','click',aiLab);
  on('#lab-ai','click',aiModifyLab);
  on('#lab-print','click',printLab);
  on('#h-imgind','click',aiImageInd);
  on('#imgind-ai','click',aiModifyImageInd);
  on('#imgind-print','click',printImageInd);
  autoResize($('#h-actual'));
  on('#img-send','click',imgSend);
  on('#img-input','input',e=>autoResize(e.target));
  on('#ask-send','click',askHistory);
  on('#ask-input','input',e=>autoResize(e.target));
}

function resetAppUI(){
  try{
    document.querySelectorAll('input, select, textarea').forEach(el=>{
      if(el.tagName==='INPUT' && (el.type==='checkbox' || el.type==='radio')) el.checked=false;
      else el.value='';
    });
    const tbl=document.querySelector('#tbl-patients');
    if(tbl) tbl.innerHTML='';
  }catch(e){ console.error('resetAppUI error',e); }
}

/********* View switches *********/
function showLogin(){ $('#view-auth').classList.remove('hidden'); $('#view-app').classList.add('hidden'); $('#top-username').textContent='Invitado'; $('#topbar').classList.remove('hidden'); $('#top-controls').classList.add('hidden'); }
async function showApp(){ $('#cfg-model').textContent=OPENAI_MODEL_NAME; $('#view-auth').classList.add('hidden'); $('#view-app').classList.remove('hidden'); $('#topbar').classList.remove('hidden'); $('#top-controls').classList.remove('hidden'); await syncFromFirestore(); await loadReminders(); await loadAppointments(); await listPatients(); }

/********* Boot *********/
(async function(){
  const intro=showIntro();
  try{
    if(!window.indexedDB) throw new Error('IndexedDB no disponible');
    await idbOpen();
    await Promise.all(['ars','religion','ocup','nac'].map(loadLookups));
    bind();
    enhanceCalendars();
    await showAuthTip();
  }catch(err){
    console.error('Boot error',err);
    toast('Error iniciando');
  }
  await intro;
  try{
    const r=JSON.parse(localStorage.getItem('remember')||'null');
    if(r){
      $('#auth-user').value=r.u;
      $('#auth-pass').value=atob(r.p);
      $('#remember').checked=true;
    }
  }catch{}
  showLogin();
  if($('#f-date')._flatpickr) $('#f-date')._flatpickr.setDate(today());
})();
</script>
<!-- ==== Widget: EG por USG (v3: fechas en espa√±ol) ==== -->
<style>
  
  .ega-dialog{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .ega-card{background:#0f172a;color:#e5e7eb;border:1px solid #23304c;border-radius:16px;max-width:680px;width:calc(100% - 32px);padding:16px}
  .ega-row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  .ega-col{flex:1 1 180px}
  .ega-card label{display:block;font-size:12px;color:#93a3b8;margin-bottom:6px}
  .ega-card input,.ega-card select,.ega-card button{width:100%;padding:10px;border-radius:10px;border:1px solid #26324d;background:#0b1426;color:#e5e7eb;outline:none}
  .ega-card input:focus{border-color:#4463ff}
  .ega-btn{background:#1f48ff;border-color:#4463ff;cursor:pointer;font-weight:600}
  .ega-btn.secondary{background:#18233b;border-color:#253153}
  .ega-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .ega-stat{background:#0b1426;border:1px dashed #23304c;border-radius:12px;padding:12px}
  .ega-muted{color:#93a3b8;font-size:12px}
  .ega-right{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .small{font-size:12px;color:#93a3b8;margin-top:4px}
</style><div class="ega-dialog" id="ega-dlg" aria-modal="true" role="dialog">
  <div class="ega-card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 style="margin:0;font-size:18px">Edad gestacional por USG</h3>
      <button type="button" class="ega-btn secondary" id="ega-close" style="width:auto;padding:8px 12px">Cerrar</button>
    </div>
    <p class="ega-muted">Muestra fechas como <em>11 de noviembre 2024</em> y formato ISO.</p>
    <div class="ega-row">
      <div class="ega-col">
        <label>Fecha del USG</label>
        <input type="date" id="ega-usg-date" max="9999-12-31" autocomplete="off">
      </div>
      <div class="ega-col">
        <label>EG en el USG (semanas)</label>
        <input type="number" id="ega-usg-w" min="0" max="45" placeholder="p.ej. 12" inputmode="numeric" autocomplete="off">
      </div>
      <div class="ega-col">
        <label>EG en el USG (d√≠as, 0-6) <span class="ega-muted">(opcional)</span></label>
        <input type="number" id="ega-usg-d" min="0" max="6" placeholder="0" inputmode="numeric" autocomplete="off">
      </div>
    </div>
    <div class="ega-right">
      <button class="ega-btn secondary" id="ega-clear" type="button" style="width:auto">Limpiar</button>
      <button class="ega-btn" id="ega-calc" type="button" style="width:auto" title="Opcional">Calcular</button>
      <button class="ega-btn" id="ega-fill" type="button" style="width:auto" title="Agregar a Historia">Agregar a Historia</button>
    </div>
    <div class="ega-row">
      <div class="ega-grid" style="width:100%">
        <div class="ega-stat">
          <div class="ega-muted">EG hoy</div>
          <div id="ega-out-eg">‚Äî</div>
          <div class="ega-muted" id="ega-out-eg-days">‚Äî</div>
        </div>
        <div class="ega-stat">
          <div class="ega-muted">FUR estimada</div>
          <div id="ega-out-fur-es">‚Äî</div>
          <div class="small" id="ega-out-fur-iso">‚Äî</div>
        </div>
        <div class="ega-stat">
          <div class="ega-muted">FPP (EDD, Naegele)</div>
          <div id="ega-out-fpp-es">‚Äî</div>
          <div class="small" id="ega-out-fpp-iso">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  function parseISO(x){ const d=new Date(x); return isNaN(d)?null:new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function fmtISO(d){ if(!d) return '‚Äî'; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return y+'-'+m+'-'+dd; }
  function fmtES(d){ if(!d) return '‚Äî'; return d.getDate()+' de '+MONTHS[d.getMonth()]+' '+d.getFullYear(); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function diffDays(a,b){ const ms=86400000; const da=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const db=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((da-db)/ms); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function compute(){
    const dUSG=parseISO($('ega-usg-date').value);
    const wRaw=$('ega-usg-w').value.trim();
    const dRaw=$('ega-usg-d').value.trim();
    if(!dUSG || wRaw==='') return {error:true};
    let w=parseInt(wRaw,10); if(isNaN(w)) return {error:true};
    let d=(dRaw==='')?0:parseInt(dRaw,10); if(isNaN(d)) d=0;
    w=clamp(w,0,45); d=clamp(d,0,6);
    const daysAtUSG=w*7+d;
    const fur=addDays(dUSG, -daysAtUSG);
    const fpp=addDays(fur, 280);
    const today=new Date();
    const egDays=Math.max(0, diffDays(today, fur));
    const egW=Math.floor(egDays/7), egD=egDays%7;
    return {fur,fpp,egDays,egW,egD,dUSG};
  }
  function updateUI(){
    const o=compute();
    $('ega-out-eg').textContent = o.error ? '‚Äî' : (o.egW+' semanas + '+o.egD+' d√≠as');
    $('ega-out-eg-days').textContent = o.error ? '‚Äî' : '('+o.egDays+' d√≠as)';
    $('ega-out-fur-es').textContent = o.error ? '‚Äî' : fmtES(o.fur);
    $('ega-out-fur-iso').textContent = o.error ? '‚Äî' : fmtISO(o.fur);
    $('ega-out-fpp-es').textContent = o.error ? '‚Äî' : fmtES(o.fpp);
    $('ega-out-fpp-iso').textContent = o.error ? '‚Äî' : fmtISO(o.fpp);
  }
  function fillToForm(){
    const o=compute();
    if(o.error){ alert('Completa fecha y EG del USG.'); return; }
    const txt = `USG (${fmtISO(o.dUSG)}): EG ${o.egW}s+${o.egD}d; FUR ${fmtISO(o.fur)}; FPP ${fmtISO(o.fpp)}`;
    const h=document.getElementById('h-actual');
    if(h){ h.value = (h.value? h.value+'\n':'') + txt; }
    $('ega-dlg').style.display='none';
  }
  ['ega-usg-date','ega-usg-w','ega-usg-d'].forEach(id=>{
    $(id).addEventListener('input', updateUI);
    $(id).addEventListener('change', updateUI);
  });
  document.getElementById('fab-ega') && document.getElementById('fab-ega').addEventListener('click',()=>{$('ega-dlg').style.display='flex';});
  document.getElementById('ega-close') && document.getElementById('ega-close').addEventListener('click',()=>{$('ega-dlg').style.display='none';});
  document.getElementById('ega-calc') && document.getElementById('ega-calc').addEventListener('click', updateUI);
  document.getElementById('ega-clear') && document.getElementById('ega-clear').addEventListener('click',()=>{
    ['ega-usg-date','ega-usg-w','ega-usg-d'].forEach(id=>{ $(id).value=''; });
    ['ega-out-eg','ega-out-eg-days','ega-out-fur-es','ega-out-fur-iso','ega-out-fpp-es','ega-out-fpp-iso'].forEach(id=>{ $(id).textContent='‚Äî'; });
  });
  document.getElementById('ega-fill') && document.getElementById('ega-fill').addEventListener('click', fillToForm);
})();
</script>
<!-- ==== /Widget: EG por USG (v3) ==== -->
<!-- Firestore v9: expone objetos a window -->
<script type="module">
  import { getApp, initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDocs, deleteDoc, addDoc
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  // Usa la app ya creada; si no existe, inicializa con window.firebaseConfig (debe estar definido en la p√°gina)
  let app;
  try { app = getApp(); }
  catch (e) {
    if (!window.firebaseConfig) {
      console.error("[Firebase] No hay app ni window.firebaseConfig. Define firebaseConfig antes.");
      throw e;
    }
    app = initializeApp(window.firebaseConfig);
  }

  const db = getFirestore(app);
  const auth = getAuth(app);

  // Exponer a window (para otros scripts que no son m√≥dulos)
  window.firestore = db;
  window.firebaseAuth = auth;
  window.collection = collection;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;
  window.addDoc = addDoc;
  window.onAuthStateChanged = onAuthStateChanged;

  console.log("[Firestore] listo; auth & db expuestos en window");
</script>

<!-- Per-user Firestore: /users/{uid}/... + ensure user doc + sync -->
<script>
(function(){
  async function ensureUserDoc(){
    try{
      const auth = window.firebaseAuth, db = window.firestore;
      if (!auth || !auth.currentUser || !db) return;
      const { uid, email = "" } = auth.currentUser;
      await setDoc(doc(db, "users", uid), { uid, email, updatedAt: new Date().toISOString() }, { merge: true });
      console.log("[users]", "asegurado /users/"+uid);
    }catch(e){ console.warn("ensureUserDoc error", e); }
  }

  const _idbPut   = window.idbPut   || (async (_s,v)=>v.id??Date.now());
  const _idbDel   = window.idbDelete|| (async (_s,_id)=>{});
  const _idbClear = window.idbClear || (async (_s)=>{});

  async function clearAllStores(){
    const STORES = ["patients","histories","appointments","reminders","config","invoices","catalog","lookups"];
    for (const s of STORES){
      try { await _idbClear(s); } catch(e){ console.warn("[idbClear]", s, e); }
    }
  }

  function getLastUid(){
    try { return localStorage.getItem("healthia_uid") || ""; } catch { return ""; }
  }
  function setLastUid(uid){
    try { localStorage.setItem("healthia_uid", uid || ""); } catch{}
  }

  window.saveData = async function(store, val){
    const id = await _idbPut(store, val);
    const docId = val.id ?? id;
    val.id = docId;

    const auth = window.firebaseAuth, db = window.firestore;
    if (db && auth && auth.currentUser){
      try{
        const uid = auth.currentUser.uid;
        await setDoc(doc(db, "users", uid, store, String(docId)), val);
        console.log("[save]", `/users/${uid}/${store}/${docId}`);
      }catch(e){ console.error("[save error]", store, e); }
    }
    return id;
  };

  window.deleteData = async function(store, id){
    await _idbDel(store, id);
    const auth = window.firebaseAuth, db = window.firestore;
    if (db && auth && auth.currentUser){
      try{
        const uid = auth.currentUser.uid;
        await deleteDoc(doc(db, "users", uid, store, String(id)));
        console.log("[delete]", `/users/${uid}/${store}/${id}`);
      }catch(e){ console.error("[delete error]", store, e); }
    }
  };

  window.syncFromFirestore = async function(){
    const auth = window.firebaseAuth, db = window.firestore;
    if (!db || !auth || !auth.currentUser) return;
    const uid = auth.currentUser.uid;
    const stores = ["patients","histories","appointments","reminders","config","invoices","catalog","lookups"];
    for (const s of stores){
      try{
        const snap = await getDocs(collection(db, "users", uid, s));
        await _idbClear(s);
        for (const d of snap.docs) await _idbPut(s, d.data());
        console.log("[sync]", s, "docs:", snap.size);
      }catch(e){ console.error("[sync error]", s, e); }
    }
  };

  const origLogin = window.doLogin;
  if (typeof origLogin === "function"){
    window.doLogin = async function(...args){
      const res = await origLogin.apply(this, args);
      await ensureUserDoc();
      try{ await window.syncFromFirestore(); }catch(_){ }
      return res;
    };
  }
  const origRegister = window.doRegister;
  if (typeof origRegister === "function"){
    window.doRegister = async function(...args){
      const res = await origRegister.apply(this, args);
      await ensureUserDoc();
      try{ await window.syncFromFirestore(); }catch(_){ }
      return res;
    };
  }

  if (window.onAuthStateChanged && window.firebaseAuth){
    window.onAuthStateChanged(window.firebaseAuth, async (user)=>{
      const prev = getLastUid();
      const cur  = user?.uid || '';

      if (prev && prev !== cur){
        await clearAllStores();
        resetAppUI();
      }
      setLastUid(cur);
      if (user) { await showApp(); } else { showLogin(); }
    });
  }

  window.clearAllStores = clearAllStores;
  window.ensureUserDoc = ensureUserDoc;
})();
</script>
<script id="lms-cdc-json" type="application/json">{
  "cdc_0_3": {
    "wfa": {
      "male": [
        {
          "age_mo": 0,
          "L": 1.815151075,
          "M": 3.530203168,
          "S": 0.152385273
        },
        {
          "age_mo": 0.5,
          "L": 1.547523128,
          "M": 4.003106424,
          "S": 0.146025021
        },
        {
          "age_mo": 1.5,
          "L": 1.068795548,
          "M": 4.879525083,
          "S": 0.136478767
        },
        {
          "age_mo": 2.5,
          "L": 0.695973505,
          "M": 5.672888765,
          "S": 0.129677511
        },
        {
          "age_mo": 3.5,
          "L": 0.41981509,
          "M": 6.391391982,
          "S": 0.124717085
        },
        {
          "age_mo": 4.5,
          "L": 0.219866801,
          "M": 7.041836432,
          "S": 0.121040119
        },
        {
          "age_mo": 5.5,
          "L": 0.077505598,
          "M": 7.630425182,
          "S": 0.1182712
        },
        {
          "age_mo": 6.5,
          "L": -0.02190761,
          "M": 8.162951035,
          "S": 0.116153695
        },
        {
          "age_mo": 7.5,
          "L": -0.0894409,
          "M": 8.644832479,
          "S": 0.114510349
        },
        {
          "age_mo": 8.5,
          "L": -0.1334091,
          "M": 9.081119817,
          "S": 0.113217163
        },
        {
          "age_mo": 9.5,
          "L": -0.1600954,
          "M": 9.476500305,
          "S": 0.11218624
        },
        {
          "age_mo": 10.5,
          "L": -0.17429685,
          "M": 9.835307701,
          "S": 0.111354536
        },
        {
          "age_mo": 11.5,
          "L": -0.1797189,
          "M": 10.16153567,
          "S": 0.110676413
        },
        {
          "age_mo": 12.5,
          "L": -0.179254,
          "M": 10.45885399,
          "S": 0.110118635
        },
        {
          "age_mo": 13.5,
          "L": -0.17518447,
          "M": 10.7306256,
          "S": 0.109656941
        },
        {
          "age_mo": 14.5,
          "L": -0.16932268,
          "M": 10.97992482,
          "S": 0.109273653
        },
        {
          "age_mo": 15.5,
          "L": -0.1631139,
          "M": 11.20955529,
          "S": 0.10895596
        },
        {
          "age_mo": 16.5,
          "L": -0.15770999,
          "M": 11.4220677,
          "S": 0.108694678
        },
        {
          "age_mo": 17.5,
          "L": -0.15402279,
          "M": 11.61977698,
          "S": 0.108483324
        },
        {
          "age_mo": 18.5,
          "L": -0.15276214,
          "M": 11.80477902,
          "S": 0.108317416
        },
        {
          "age_mo": 19.5,
          "L": -0.15446658,
          "M": 11.9789663,
          "S": 0.108193944
        },
        {
          "age_mo": 20.5,
          "L": -0.15952202,
          "M": 12.14404334,
          "S": 0.108110954
        },
        {
          "age_mo": 21.5,
          "L": -0.16817926,
          "M": 12.30154103,
          "S": 0.108067236
        },
        {
          "age_mo": 22.5,
          "L": -0.1805668,
          "M": 12.45283028,
          "S": 0.108062078
        },
        {
          "age_mo": 23.5,
          "L": -0.19670196,
          "M": 12.59913494,
          "S": 0.108095077
        },
        {
          "age_mo": 24.5,
          "L": -0.21650121,
          "M": 12.74154396,
          "S": 0.108166005
        },
        {
          "age_mo": 25.5,
          "L": -0.23979048,
          "M": 12.88102276,
          "S": 0.108274705
        },
        {
          "age_mo": 26.5,
          "L": -0.26631585,
          "M": 13.01842382,
          "S": 0.108421024
        },
        {
          "age_mo": 27.5,
          "L": -0.29575496,
          "M": 13.1544966,
          "S": 0.108604769
        },
        {
          "age_mo": 28.5,
          "L": -0.32772936,
          "M": 13.28989667,
          "S": 0.108825681
        },
        {
          "age_mo": 29.5,
          "L": -0.36181746,
          "M": 13.42519408,
          "S": 0.109083423
        },
        {
          "age_mo": 30.5,
          "L": -0.39756808,
          "M": 13.56088113,
          "S": 0.109377581
        },
        {
          "age_mo": 31.5,
          "L": -0.43452025,
          "M": 13.69737858,
          "S": 0.109707646
        },
        {
          "age_mo": 32.5,
          "L": -0.47218875,
          "M": 13.83504622,
          "S": 0.110073084
        },
        {
          "age_mo": 33.5,
          "L": -0.51012309,
          "M": 13.97418199,
          "S": 0.110473238
        },
        {
          "age_mo": 34.5,
          "L": -0.54788557,
          "M": 14.1150324,
          "S": 0.1109074
        },
        {
          "age_mo": 35.5,
          "L": -0.5850701,
          "M": 14.25779618,
          "S": 0.111374787
        },
        {
          "age_mo": 36,
          "L": -0.60333785,
          "M": 14.32994444,
          "S": 0.111620652
        }
      ],
      "female": [
        {
          "age_mo": 0,
          "L": 1.509187507,
          "M": 3.39918645,
          "S": 0.142106724
        },
        {
          "age_mo": 0.5,
          "L": 1.357944315,
          "M": 3.79752846,
          "S": 0.138075916
        },
        {
          "age_mo": 1.5,
          "L": 1.105537708,
          "M": 4.544776513,
          "S": 0.131733888
        },
        {
          "age_mo": 2.5,
          "L": 0.902596648,
          "M": 5.230584214,
          "S": 0.126892697
        },
        {
          "age_mo": 3.5,
          "L": 0.734121414,
          "M": 5.859960798,
          "S": 0.123025182
        },
        {
          "age_mo": 4.5,
          "L": 0.590235275,
          "M": 6.437587751,
          "S": 0.119840911
        },
        {
          "age_mo": 5.5,
          "L": 0.464391566,
          "M": 6.967850457,
          "S": 0.117166868
        },
        {
          "age_mo": 6.5,
          "L": 0.352164071,
          "M": 7.454854109,
          "S": 0.11489384
        },
        {
          "age_mo": 7.5,
          "L": 0.250497889,
          "M": 7.902436186,
          "S": 0.112949644
        },
        {
          "age_mo": 8.5,
          "L": 0.15724751,
          "M": 8.314178377,
          "S": 0.11128469
        },
        {
          "age_mo": 9.5,
          "L": 0.070885725,
          "M": 8.693418423,
          "S": 0.109863709
        },
        {
          "age_mo": 10.5,
          "L": -0.00968493,
          "M": 9.043261854,
          "S": 0.10866078
        },
        {
          "age_mo": 11.5,
          "L": -0.085258,
          "M": 9.366593571,
          "S": 0.10765621
        },
        {
          "age_mo": 12.5,
          "L": -0.15640945,
          "M": 9.666089185,
          "S": 0.106834517
        },
        {
          "age_mo": 13.5,
          "L": -0.22355869,
          "M": 9.944226063,
          "S": 0.106183085
        },
        {
          "age_mo": 14.5,
          "L": -0.28701346,
          "M": 10.20329397,
          "S": 0.105691242
        },
        {
          "age_mo": 15.5,
          "L": -0.34699919,
          "M": 10.4454058,
          "S": 0.105349631
        },
        {
          "age_mo": 16.5,
          "L": -0.40368918,
          "M": 10.67250698,
          "S": 0.105149754
        },
        {
          "age_mo": 17.5,
          "L": -0.45721877,
          "M": 10.88638558,
          "S": 0.105083666
        },
        {
          "age_mo": 18.5,
          "L": -0.50770077,
          "M": 11.08868151,
          "S": 0.105143752
        },
        {
          "age_mo": 19.5,
          "L": -0.55523599,
          "M": 11.28089537,
          "S": 0.105322575
        },
        {
          "age_mo": 20.5,
          "L": -0.59992113,
          "M": 11.46439708,
          "S": 0.10561278
        },
        {
          "age_mo": 21.5,
          "L": -0.64185418,
          "M": 11.64043402,
          "S": 0.106007025
        },
        {
          "age_mo": 22.5,
          "L": -0.6811381,
          "M": 11.81013895,
          "S": 0.106497957
        },
        {
          "age_mo": 23.5,
          "L": -0.71788283,
          "M": 11.97453748,
          "S": 0.107078197
        },
        {
          "age_mo": 24.5,
          "L": -0.75220617,
          "M": 12.13455528,
          "S": 0.107740346
        },
        {
          "age_mo": 25.5,
          "L": -0.78423359,
          "M": 12.2910249,
          "S": 0.108477009
        },
        {
          "age_mo": 26.5,
          "L": -0.81409743,
          "M": 12.44469237,
          "S": 0.109280822
        },
        {
          "age_mo": 27.5,
          "L": -0.8419355,
          "M": 12.59622335,
          "S": 0.110144488
        },
        {
          "age_mo": 28.5,
          "L": -0.86788939,
          "M": 12.74620911,
          "S": 0.111060814
        },
        {
          "age_mo": 29.5,
          "L": -0.89210264,
          "M": 12.89517218,
          "S": 0.112022758
        },
        {
          "age_mo": 30.5,
          "L": -0.91471881,
          "M": 13.04357164,
          "S": 0.113023466
        },
        {
          "age_mo": 31.5,
          "L": -0.93587966,
          "M": 13.19180827,
          "S": 0.114056316
        },
        {
          "age_mo": 32.5,
          "L": -0.95572344,
          "M": 13.34022934,
          "S": 0.115114952
        },
        {
          "age_mo": 33.5,
          "L": -0.97438101,
          "M": 13.48913357,
          "S": 0.116193337
        },
        {
          "age_mo": 34.5,
          "L": -0.99198075,
          "M": 13.63877446,
          "S": 0.11728575
        },
        {
          "age_mo": 35.5,
          "L": -1.00864074,
          "M": 13.78936547,
          "S": 0.118386847
        },
        {
          "age_mo": 36,
          "L": -1.01665314,
          "M": 13.86507382,
          "S": 0.118939087
        }
      ]
    },
    "hfa": {
      "male": [
        {
          "age_mo": 0,
          "L": 1.267004226,
          "M": 49.98888408,
          "S": 0.053112191
        },
        {
          "age_mo": 0.5,
          "L": 0.511237696,
          "M": 52.6959753,
          "S": 0.048692684
        },
        {
          "age_mo": 1.5,
          "L": -0.45224446,
          "M": 56.62842855,
          "S": 0.04411683
        },
        {
          "age_mo": 2.5,
          "L": -0.990594599,
          "M": 59.60895343,
          "S": 0.041795583
        },
        {
          "age_mo": 3.5,
          "L": -1.285837689,
          "M": 62.07700027,
          "S": 0.040454126
        },
        {
          "age_mo": 4.5,
          "L": -1.43031238,
          "M": 64.2168641,
          "S": 0.039633879
        },
        {
          "age_mo": 5.5,
          "L": -1.47657547,
          "M": 66.1253149,
          "S": 0.039123813
        },
        {
          "age_mo": 6.5,
          "L": -1.456837849,
          "M": 67.8601799,
          "S": 0.038811994
        },
        {
          "age_mo": 7.5,
          "L": -1.391898768,
          "M": 69.45908458,
          "S": 0.038633209
        },
        {
          "age_mo": 8.5,
          "L": -1.29571459,
          "M": 70.94803912,
          "S": 0.038546833
        },
        {
          "age_mo": 9.5,
          "L": -1.177919048,
          "M": 72.34586111,
          "S": 0.038526262
        },
        {
          "age_mo": 10.5,
          "L": -1.045326049,
          "M": 73.6666541,
          "S": 0.038553387
        },
        {
          "age_mo": 11.5,
          "L": -0.902800887,
          "M": 74.92129717,
          "S": 0.038615501
        },
        {
          "age_mo": 12.5,
          "L": -0.753908107,
          "M": 76.11837536,
          "S": 0.038703461
        },
        {
          "age_mo": 13.5,
          "L": -0.601263523,
          "M": 77.26479911,
          "S": 0.038810557
        },
        {
          "age_mo": 14.5,
          "L": -0.446805039,
          "M": 78.36622309,
          "S": 0.038931784
        },
        {
          "age_mo": 15.5,
          "L": -0.291974772,
          "M": 79.4273405,
          "S": 0.039063356
        },
        {
          "age_mo": 16.5,
          "L": -0.13784767,
          "M": 80.45209492,
          "S": 0.039202382
        },
        {
          "age_mo": 17.5,
          "L": 0.014776155,
          "M": 81.44383603,
          "S": 0.039346629
        },
        {
          "age_mo": 18.5,
          "L": 0.165304169,
          "M": 82.40543643,
          "S": 0.039494365
        },
        {
          "age_mo": 19.5,
          "L": 0.313301809,
          "M": 83.33938063,
          "S": 0.039644238
        },
        {
          "age_mo": 20.5,
          "L": 0.458455471,
          "M": 84.24783394,
          "S": 0.039795189
        },
        {
          "age_mo": 21.5,
          "L": 0.600544631,
          "M": 85.13269658,
          "S": 0.039946388
        },
        {
          "age_mo": 22.5,
          "L": 0.739438953,
          "M": 85.9956488,
          "S": 0.040097181
        },
        {
          "age_mo": 23.5,
          "L": 0.875000447,
          "M": 86.8381751,
          "S": 0.04024706
        },
        {
          "age_mo": 24.5,
          "L": 1.00720807,
          "M": 87.66160934,
          "S": 0.040395626
        },
        {
          "age_mo": 25.5,
          "L": 0.837251351,
          "M": 88.45247282,
          "S": 0.040577525
        },
        {
          "age_mo": 26.5,
          "L": 0.681492975,
          "M": 89.22326434,
          "S": 0.040723122
        },
        {
          "age_mo": 27.5,
          "L": 0.538779654,
          "M": 89.97549228,
          "S": 0.040833194
        },
        {
          "age_mo": 28.5,
          "L": 0.407697153,
          "M": 90.71040853,
          "S": 0.040909059
        },
        {
          "age_mo": 29.5,
          "L": 0.286762453,
          "M": 91.42907762,
          "S": 0.040952433
        },
        {
          "age_mo": 30.5,
          "L": 0.174489485,
          "M": 92.13242379,
          "S": 0.04096533
        },
        {
          "age_mo": 31.5,
          "L": 0.069444521,
          "M": 92.82127167,
          "S": 0.040949976
        },
        {
          "age_mo": 32.5,
          "L": -0.029720564,
          "M": 93.49637946,
          "S": 0.040908737
        },
        {
          "age_mo": 33.5,
          "L": -0.124251789,
          "M": 94.15846546,
          "S": 0.040844062
        },
        {
          "age_mo": 34.5,
          "L": -0.215288396,
          "M": 94.80822923,
          "S": 0.040758431
        },
        {
          "age_mo": 35.5,
          "L": -0.30385434,
          "M": 95.44636981,
          "S": 0.040654312
        }
      ],
      "female": [
        {
          "age_mo": 0,
          "L": -1.295960857,
          "M": 49.28639612,
          "S": 0.05008556
        },
        {
          "age_mo": 0.5,
          "L": -0.809249882,
          "M": 51.68358057,
          "S": 0.046818545
        },
        {
          "age_mo": 1.5,
          "L": -0.050782985,
          "M": 55.28612813,
          "S": 0.0434439
        },
        {
          "age_mo": 2.5,
          "L": 0.476851407,
          "M": 58.09381906,
          "S": 0.041716103
        },
        {
          "age_mo": 3.5,
          "L": 0.843299612,
          "M": 60.45980763,
          "S": 0.040705173
        },
        {
          "age_mo": 4.5,
          "L": 1.097562257,
          "M": 62.53669656,
          "S": 0.040079765
        },
        {
          "age_mo": 5.5,
          "L": 1.272509641,
          "M": 64.40632762,
          "S": 0.039686845
        },
        {
          "age_mo": 6.5,
          "L": 1.390428859,
          "M": 66.11841553,
          "S": 0.039444555
        },
        {
          "age_mo": 7.5,
          "L": 1.466733925,
          "M": 67.70574419,
          "S": 0.039304738
        },
        {
          "age_mo": 8.5,
          "L": 1.512301976,
          "M": 69.19123614,
          "S": 0.03923711
        },
        {
          "age_mo": 9.5,
          "L": 1.534950767,
          "M": 70.59163924,
          "S": 0.039221665
        },
        {
          "age_mo": 10.5,
          "L": 1.540390875,
          "M": 71.91961673,
          "S": 0.039244672
        },
        {
          "age_mo": 11.5,
          "L": 1.532852892,
          "M": 73.1850104,
          "S": 0.03929642
        },
        {
          "age_mo": 12.5,
          "L": 1.51550947,
          "M": 74.39564379,
          "S": 0.039369875
        },
        {
          "age_mo": 13.5,
          "L": 1.490765028,
          "M": 75.5578544,
          "S": 0.039459832
        },
        {
          "age_mo": 14.5,
          "L": 1.460458255,
          "M": 76.67685871,
          "S": 0.039562382
        },
        {
          "age_mo": 15.5,
          "L": 1.426006009,
          "M": 77.75700986,
          "S": 0.039674542
        },
        {
          "age_mo": 16.5,
          "L": 1.388507095,
          "M": 78.80198406,
          "S": 0.03979401
        },
        {
          "age_mo": 17.5,
          "L": 1.348818127,
          "M": 79.81491852,
          "S": 0.039918994
        },
        {
          "age_mo": 18.5,
          "L": 1.307609654,
          "M": 80.79851532,
          "S": 0.040048084
        },
        {
          "age_mo": 19.5,
          "L": 1.265408149,
          "M": 81.75512092,
          "S": 0.040180162
        },
        {
          "age_mo": 20.5,
          "L": 1.222627732,
          "M": 82.6867881,
          "S": 0.04031434
        },
        {
          "age_mo": 21.5,
          "L": 1.179594365,
          "M": 83.59532461,
          "S": 0.040449904
        },
        {
          "age_mo": 22.5,
          "L": 1.136564448,
          "M": 84.48233206,
          "S": 0.040586283
        },
        {
          "age_mo": 23.5,
          "L": 1.093731947,
          "M": 85.34923624,
          "S": 0.040723015
        },
        {
          "age_mo": 24.5,
          "L": 1.051272912,
          "M": 86.1973169,
          "S": 0.040859727
        },
        {
          "age_mo": 25.5,
          "L": 1.041951175,
          "M": 87.09026318,
          "S": 0.041142161
        },
        {
          "age_mo": 26.5,
          "L": 1.012592236,
          "M": 87.95714182,
          "S": 0.041349399
        },
        {
          "age_mo": 27.5,
          "L": 0.970541909,
          "M": 88.7960184,
          "S": 0.041500428
        },
        {
          "age_mo": 28.5,
          "L": 0.921129988,
          "M": 89.6055115,
          "S": 0.041610508
        },
        {
          "age_mo": 29.5,
          "L": 0.868221392,
          "M": 90.38476689,
          "S": 0.041691761
        },
        {
          "age_mo": 30.5,
          "L": 0.81454413,
          "M": 91.13341722,
          "S": 0.04175368
        },
        {
          "age_mo": 31.5,
          "L": 0.761957977,
          "M": 91.8515436,
          "S": 0.041803562
        },
        {
          "age_mo": 32.5,
          "L": 0.711660228,
          "M": 92.5396352,
          "S": 0.041846882
        },
        {
          "age_mo": 33.5,
          "L": 0.664323379,
          "M": 93.19854429,
          "S": 0.041887626
        },
        {
          "age_mo": 34.5,
          "L": 0.620285102,
          "M": 93.82945392,
          "S": 0.041928568
        },
        {
          "age_mo": 35.5,
          "L": 0.57955631,
          "M": 94.43382278,
          "S": 0.041971514
        }
      ]
    }
  },
  "cdc_2_20": {
    "wfa": {
      "male": [
        {
          "age_mo": 0,
          "L": 1.815151075,
          "M": 3.530203168,
          "S": 0.152385273
        },
        {
          "age_mo": 0.5,
          "L": 1.547523128,
          "M": 4.003106424,
          "S": 0.146025021
        },
        {
          "age_mo": 1.5,
          "L": 1.068795548,
          "M": 4.879525083,
          "S": 0.136478767
        },
        {
          "age_mo": 2.5,
          "L": 0.695973505,
          "M": 5.672888765,
          "S": 0.129677511
        },
        {
          "age_mo": 3.5,
          "L": 0.41981509,
          "M": 6.391391982,
          "S": 0.124717085
        },
        {
          "age_mo": 4.5,
          "L": 0.219866801,
          "M": 7.041836432,
          "S": 0.121040119
        },
        {
          "age_mo": 5.5,
          "L": 0.077505598,
          "M": 7.630425182,
          "S": 0.1182712
        },
        {
          "age_mo": 6.5,
          "L": -0.02190761,
          "M": 8.162951035,
          "S": 0.116153695
        },
        {
          "age_mo": 7.5,
          "L": -0.0894409,
          "M": 8.644832479,
          "S": 0.114510349
        },
        {
          "age_mo": 8.5,
          "L": -0.1334091,
          "M": 9.081119817,
          "S": 0.113217163
        },
        {
          "age_mo": 9.5,
          "L": -0.1600954,
          "M": 9.476500305,
          "S": 0.11218624
        },
        {
          "age_mo": 10.5,
          "L": -0.17429685,
          "M": 9.835307701,
          "S": 0.111354536
        },
        {
          "age_mo": 11.5,
          "L": -0.1797189,
          "M": 10.16153567,
          "S": 0.110676413
        },
        {
          "age_mo": 12.5,
          "L": -0.179254,
          "M": 10.45885399,
          "S": 0.110118635
        },
        {
          "age_mo": 13.5,
          "L": -0.17518447,
          "M": 10.7306256,
          "S": 0.109656941
        },
        {
          "age_mo": 14.5,
          "L": -0.16932268,
          "M": 10.97992482,
          "S": 0.109273653
        },
        {
          "age_mo": 15.5,
          "L": -0.1631139,
          "M": 11.20955529,
          "S": 0.10895596
        },
        {
          "age_mo": 16.5,
          "L": -0.15770999,
          "M": 11.4220677,
          "S": 0.108694678
        },
        {
          "age_mo": 17.5,
          "L": -0.15402279,
          "M": 11.61977698,
          "S": 0.108483324
        },
        {
          "age_mo": 18.5,
          "L": -0.15276214,
          "M": 11.80477902,
          "S": 0.108317416
        },
        {
          "age_mo": 19.5,
          "L": -0.15446658,
          "M": 11.9789663,
          "S": 0.108193944
        },
        {
          "age_mo": 20.5,
          "L": -0.15952202,
          "M": 12.14404334,
          "S": 0.108110954
        },
        {
          "age_mo": 21.5,
          "L": -0.16817926,
          "M": 12.30154103,
          "S": 0.108067236
        },
        {
          "age_mo": 22.5,
          "L": -0.1805668,
          "M": 12.45283028,
          "S": 0.108062078
        },
        {
          "age_mo": 23.5,
          "L": -0.19670196,
          "M": 12.59913494,
          "S": 0.108095077
        },
        {
          "age_mo": 24.5,
          "L": -0.21650121,
          "M": 12.74154396,
          "S": 0.108166005
        },
        {
          "age_mo": 25.5,
          "L": -0.23979048,
          "M": 12.88102276,
          "S": 0.108274705
        },
        {
          "age_mo": 26.5,
          "L": -0.26631585,
          "M": 13.01842382,
          "S": 0.108421024
        },
        {
          "age_mo": 27.5,
          "L": -0.29575496,
          "M": 13.1544966,
          "S": 0.108604769
        },
        {
          "age_mo": 28.5,
          "L": -0.32772936,
          "M": 13.28989667,
          "S": 0.108825681
        },
        {
          "age_mo": 29.5,
          "L": -0.36181746,
          "M": 13.42519408,
          "S": 0.109083423
        },
        {
          "age_mo": 30.5,
          "L": -0.39756808,
          "M": 13.56088113,
          "S": 0.109377581
        },
        {
          "age_mo": 31.5,
          "L": -0.43452025,
          "M": 13.69737858,
          "S": 0.109707646
        },
        {
          "age_mo": 32.5,
          "L": -0.47218875,
          "M": 13.83504622,
          "S": 0.110073084
        },
        {
          "age_mo": 33.5,
          "L": -0.51012309,
          "M": 13.97418199,
          "S": 0.110473238
        },
        {
          "age_mo": 34.5,
          "L": -0.54788557,
          "M": 14.1150324,
          "S": 0.1109074
        },
        {
          "age_mo": 35.5,
          "L": -0.5850701,
          "M": 14.25779618,
          "S": 0.111374787
        },
        {
          "age_mo": 36,
          "L": -0.60333785,
          "M": 14.32994444,
          "S": 0.111620652
        }
      ],
      "female": [
        {
          "age_mo": 0,
          "L": 1.509187507,
          "M": 3.39918645,
          "S": 0.142106724
        },
        {
          "age_mo": 0.5,
          "L": 1.357944315,
          "M": 3.79752846,
          "S": 0.138075916
        },
        {
          "age_mo": 1.5,
          "L": 1.105537708,
          "M": 4.544776513,
          "S": 0.131733888
        },
        {
          "age_mo": 2.5,
          "L": 0.902596648,
          "M": 5.230584214,
          "S": 0.126892697
        },
        {
          "age_mo": 3.5,
          "L": 0.734121414,
          "M": 5.859960798,
          "S": 0.123025182
        },
        {
          "age_mo": 4.5,
          "L": 0.590235275,
          "M": 6.437587751,
          "S": 0.119840911
        },
        {
          "age_mo": 5.5,
          "L": 0.464391566,
          "M": 6.967850457,
          "S": 0.117166868
        },
        {
          "age_mo": 6.5,
          "L": 0.352164071,
          "M": 7.454854109,
          "S": 0.11489384
        },
        {
          "age_mo": 7.5,
          "L": 0.250497889,
          "M": 7.902436186,
          "S": 0.112949644
        },
        {
          "age_mo": 8.5,
          "L": 0.15724751,
          "M": 8.314178377,
          "S": 0.11128469
        },
        {
          "age_mo": 9.5,
          "L": 0.070885725,
          "M": 8.693418423,
          "S": 0.109863709
        },
        {
          "age_mo": 10.5,
          "L": -0.00968493,
          "M": 9.043261854,
          "S": 0.10866078
        },
        {
          "age_mo": 11.5,
          "L": -0.085258,
          "M": 9.366593571,
          "S": 0.10765621
        },
        {
          "age_mo": 12.5,
          "L": -0.15640945,
          "M": 9.666089185,
          "S": 0.106834517
        },
        {
          "age_mo": 13.5,
          "L": -0.22355869,
          "M": 9.944226063,
          "S": 0.106183085
        },
        {
          "age_mo": 14.5,
          "L": -0.28701346,
          "M": 10.20329397,
          "S": 0.105691242
        },
        {
          "age_mo": 15.5,
          "L": -0.34699919,
          "M": 10.4454058,
          "S": 0.105349631
        },
        {
          "age_mo": 16.5,
          "L": -0.40368918,
          "M": 10.67250698,
          "S": 0.105149754
        },
        {
          "age_mo": 17.5,
          "L": -0.45721877,
          "M": 10.88638558,
          "S": 0.105083666
        },
        {
          "age_mo": 18.5,
          "L": -0.50770077,
          "M": 11.08868151,
          "S": 0.105143752
        },
        {
          "age_mo": 19.5,
          "L": -0.55523599,
          "M": 11.28089537,
          "S": 0.105322575
        },
        {
          "age_mo": 20.5,
          "L": -0.59992113,
          "M": 11.46439708,
          "S": 0.10561278
        },
        {
          "age_mo": 21.5,
          "L": -0.64185418,
          "M": 11.64043402,
          "S": 0.106007025
        },
        {
          "age_mo": 22.5,
          "L": -0.6811381,
          "M": 11.81013895,
          "S": 0.106497957
        },
        {
          "age_mo": 23.5,
          "L": -0.71788283,
          "M": 11.97453748,
          "S": 0.107078197
        },
        {
          "age_mo": 24.5,
          "L": -0.75220617,
          "M": 12.13455528,
          "S": 0.107740346
        },
        {
          "age_mo": 25.5,
          "L": -0.78423359,
          "M": 12.2910249,
          "S": 0.108477009
        },
        {
          "age_mo": 26.5,
          "L": -0.81409743,
          "M": 12.44469237,
          "S": 0.109280822
        },
        {
          "age_mo": 27.5,
          "L": -0.8419355,
          "M": 12.59622335,
          "S": 0.110144488
        },
        {
          "age_mo": 28.5,
          "L": -0.86788939,
          "M": 12.74620911,
          "S": 0.111060814
        },
        {
          "age_mo": 29.5,
          "L": -0.89210264,
          "M": 12.89517218,
          "S": 0.112022758
        },
        {
          "age_mo": 30.5,
          "L": -0.91471881,
          "M": 13.04357164,
          "S": 0.113023466
        },
        {
          "age_mo": 31.5,
          "L": -0.93587966,
          "M": 13.19180827,
          "S": 0.114056316
        },
        {
          "age_mo": 32.5,
          "L": -0.95572344,
          "M": 13.34022934,
          "S": 0.115114952
        },
        {
          "age_mo": 33.5,
          "L": -0.97438101,
          "M": 13.48913357,
          "S": 0.116193337
        },
        {
          "age_mo": 34.5,
          "L": -0.99198075,
          "M": 13.63877446,
          "S": 0.11728575
        },
        {
          "age_mo": 35.5,
          "L": -1.00864074,
          "M": 13.78936547,
          "S": 0.118386847
        },
        {
          "age_mo": 36,
          "L": -1.01665314,
          "M": 13.86507382,
          "S": 0.118939087
        }
      ]
    },
    "bfa": {
      "male": [
        {
          "age_mo": 95,
          "L": -1,
          "M": 16.6,
          "S": 0.1
        },
        {
          "age_mo": 96,
          "L": -1,
          "M": 16.7,
          "S": 0.1
        },
        {
          "age_mo": 97,
          "L": -1,
          "M": 16.8,
          "S": 0.1
        }
      ],
      "female": [
        {
          "age_mo": 95,
          "L": -1,
          "M": 16.1,
          "S": 0.1
        },
        {
          "age_mo": 96,
          "L": -1,
          "M": 16.2,
          "S": 0.1
        },
        {
          "age_mo": 97,
          "L": -1,
          "M": 16.3,
          "S": 0.1
        }
      ]
    }
  }
}</script>
<!-- ==== Pediatric Nutrition Auto-Diagnosis (Embedded LMS + robust parsing) ==== -->
<script>
(function(){
  const $ = (s) => document.querySelector(s);
  let LMS = null;
  function loadLMSInline(){
    try {
      const el = document.getElementById('lms-cdc-json');
      if (el) { LMS = JSON.parse(el.textContent); console.log('LMS inline loaded'); }
    } catch(e){ console.warn('LMS parse error', e); }
  }
  function parseNum(v){ const x=parseFloat(String(v||'').toString().replace(',','.')); return isNaN(x)?NaN:x; }
  function textNum(sel){ const t = (document.querySelector(sel)?.textContent||''); return parseNum(t); }
  function parseDateSmart(s){
    if (!s) return null;
    const iso = /^(\d{4})-(\d{1,2})-(\d{1,2})$/; let m = s.trim().match(iso);
    if (m){ const y=+m[1], mo=+m[2]-1, d=+m[3]; const dt=new Date(y,mo,d); if(!isNaN(dt)) return dt; }
    const dmY = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/; m = s.trim().match(dmY);
    if (m){ let d=+m[1], mo=+m[2]-1, y=+m[3]; if (y<100) y+=2000; const dt=new Date(y,mo,d); if(!isNaN(dt)) return dt; }
    const dt=new Date(s); if (!isNaN(dt)) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    return null;
  }
  function getDOB(){
    let s = document.querySelector('#dlg-p-fecha')?.value || '';
    if (!s) s = document.querySelector('#info-fecha')?.textContent || '';
    return parseDateSmart(s);
  }
  function ageMonths(){
    const dob=getDOB();
    if (dob){
      const today=new Date();
      let months=(today.getFullYear()-dob.getFullYear())*12 + (today.getMonth()-dob.getMonth());
      if (today.getDate() < dob.getDate()) months -= 1;
      const lastMonthDate=new Date(today.getFullYear(), today.getMonth(), dob.getDate());
      const daysInMonth=new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
      const frac=Math.max(0, Math.min(0.99, (today-lastMonthDate)/(1000*60*60*24*daysInMonth)));
      return months + frac;
    }
    const years = parseNum(document.querySelector('#dlg-p-edad')?.value || document.querySelector('#info-edad')?.textContent);
    if (isFinite(years)) return years*12;
    return NaN;
  }
  function sexMF(){
    const s=(document.querySelector('#dlg-p-sexo')?.value || document.querySelector('#info-sexo')?.textContent || '').toLowerCase().trim();
    if (s.startsWith('m')) return 'male'; if (s.startsWith('f')) return 'female'; return 'male';
  }
  function weightKg(){
    let w=parseNum(document.querySelector('#v-peso')?.value);
    const unit=(document.querySelector('#v-unit')?.value||'kg').toLowerCase();
    if (!isFinite(w) || w<=0) w = textNum('#info-peso');
    if (!isFinite(w) || w<=0) return NaN;
    return unit==='lb' ? w*0.45359237 : w;
  }
  function heightCm(){
    let h=parseNum(document.querySelector('#dlg-p-talla')?.value);
    if (!isFinite(h) || h<=0) h = textNum('#info-altura');
    if (!isFinite(h) || h<=0) return NaN;
    return h<3 ? h*100 : h;
  }
  function zFromLMS(x,L,M,S){
    if (!isFinite(x)||!isFinite(L)||!isFinite(M)||!isFinite(S)||M<=0||S<=0) return NaN;
    if (Math.abs(L) < 1e-8) return Math.log(x/M)/S;
    return (Math.pow(x/M, L) - 1) / (L*S);
  }
  function erf(x){ const sign=Math.sign(x); const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
    const t=1/(1+p*Math.abs(x)); const y=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x); return sign*y; }
  function cdfNorm(z){ return 0.5*(1+erf(z/Math.SQRT2)); }
  function interpByAge(arr, age){
    if (!arr || !arr.length) return null;
    let i=0; while (i < arr.length && arr[i].age_mo < age) i++;
    if (i===0) return arr[0]; if (i>=arr.length) return arr[arr.length-1];
    const a0=arr[i-1], a1=arr[i]; const t=(age-a0.age_mo)/(a1.age_mo-a0.age_mo||1);
    return {age_mo:age, L:a0.L+(a1.L-a0.L)*t, M:a0.M+(a1.M-a0.M)*t, S:a0.S+(a1.S-a0.S)*t};
  }
  function clsCDC_BFA(p){ if (!isFinite(p)) return '‚Äî';
    if (p<5) return 'Bajo peso (IMC < p5)'; if (p<85) return 'Adecuado (IMC p5‚Äìp84)';
    if (p<95) return 'Sobrepeso (IMC p85‚Äìp94)'; return 'Obesidad (IMC ‚â• p95)'; }
  function clsWHO_WFA(z){ if (!isFinite(z)) return '‚Äî';
    if (z<-3) return 'Bajo peso severo'; if (z<-2) return 'Bajo peso'; if (z>+2) return 'Peso elevado'; return 'Peso adecuado'; }
  function clsWHO_HFA(z){ if (!isFinite(z)) return '‚Äî';
    if (z<-3) return 'Talla muy baja'; if (z<-2) return 'Talla baja'; return 'Talla adecuada'; }
  function computePedsDiagnosis(){
    if (!LMS) return null;
    const ageMo=ageMonths(); if (!isFinite(ageMo)) return null;
    const sex=sexMF(); const w=weightKg(); const h=heightCm();
    let main=''; const notes=[];
    if (ageMo>=24 && ageMo<=240 && isFinite(w) && isFinite(h)){
      const bmi = w/Math.pow(h/100,2);
      const arr = LMS?.cdc_2_20?.bfa?.[sex];
      if (arr && arr.length){
        const l=interpByAge(arr, ageMo); const z=zFromLMS(bmi,l.L,l.M,l.S); const p=cdfNorm(z)*100;
        main = `${clsCDC_BFA(p)}. IMC/edad p${p.toFixed(1)} (z=${z.toFixed(2)}).`; notes.push(`IMC: ${bmi.toFixed(2)} kg/m¬≤`);
      }
    } else {
      const bucket = (ageMo<=36) ? 'cdc_0_3' : 'cdc_2_20';
      if (isFinite(w) && LMS?.[bucket]?.wfa?.[sex]){
        const l=interpByAge(LMS[bucket].wfa[sex], ageMo); const z=zFromLMS(w,l.L,l.M,l.S); const p=cdfNorm(z)*100;
        const cls=clsWHO_WFA(z); if (!main) main=`${cls} (peso/edad).`; notes.push(`Peso/edad p${p.toFixed(1)} (z=${z.toFixed(2)})`);
      }
      if (isFinite(h) && LMS?.[bucket]?.hfa?.[sex]){
        const l=interpByAge(LMS[bucket].hfa[sex], ageMo); const z=zFromLMS(h,l.L,l.M,l.S); const p=cdfNorm(z)*100;
        const cls=clsWHO_HFA(z); if (!main) main=`${cls} (talla/edad).`; notes.push(`Talla/edad p${p.toFixed(1)} (z=${z.toFixed(2)})`);
      }
    }
    if (!main) return null;
    return main + (notes.length ? ' ' + notes.join('. ') + '.' : '');
  }
  function isUnder18(){ const m=ageMonths(); return isFinite(m) && m<216; }
  function autosize(el){ if (!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
  function ensureTextarea(){
    const cat=document.querySelector('#v-imc-cat'); if (!cat) return null;
    if (cat.tagName==='TEXTAREA') return cat;
    const ta=document.createElement('textarea'); [...cat.attributes].forEach(a=>ta.setAttribute(a.name,a.value));
    ta.id=cat.id; ta.className=cat.className+' min-h-[72px]'; ta.readOnly=true; ta.value=cat.value||''; cat.replaceWith(ta); return ta;
  }
  function updateEstadoNutricional(){
    const el=ensureTextarea() || document.querySelector('#v-imc-cat'); if (!el) return;
    if (isUnder18()){ const dx=computePedsDiagnosis(); el.value = dx ? dx : 'Curva de crecimiento: datos incompletos.'; el.title=el.value; autosize(el); }
    else { autosize(el); }
  }
  function wire(){
    ['v-peso','v-unit','dlg-p-talla','dlg-p-fecha','dlg-p-edad','dlg-p-sexo'].forEach(id=>{
      const n=document.getElementById(id); if (n) ['input','change','blur'].forEach(ev=> n.addEventListener(ev, updateEstadoNutricional));
    });
    updateEstadoNutricional();
  }
  document.addEventListener('DOMContentLoaded', ()=>{ loadLMSInline(); wire(); });
})();
</script>
<!-- ==== /Pediatric Nutrition Auto-Diagnosis ==== -->


<!-- Modal wiring -->
<script id="ega-wire">
document.addEventListener('DOMContentLoaded', function(){
  var openBtn  = document.getElementById('ega-open');
  var dlg      = document.getElementById('ega-dlg');
  var closeBtn = document.getElementById('ega-close');

  if (openBtn && dlg) {
    openBtn.addEventListener('click', function(e){
      e.preventDefault();
      dlg.style.display = 'flex';
    });
  }

  if (closeBtn && dlg) {
    closeBtn.addEventListener('click', function(e){
      e.preventDefault();
      dlg.style.display = 'none';
    });
  }

  if (dlg) {
    dlg.addEventListener('click', function(e){
      if (e.target === dlg) { dlg.style.display = 'none'; }
    });
  }
});
</script>

<!-- 1) API del frontend: DEBE ir antes si el m√≥dulo lo usa -->
<script src="./js/api.js"></script>


<!-- 2) Tu m√≥dulo (puede usar __API__ definido por api.js) -->
<script>
/* Mapeo de nombre comercial */
function brandName(model) {
  const m = String(model||'').toLowerCase();
  // GPT-5 familia
  if (m.startsWith('gpt-5-nano')) return 'healthia-5-nano';
  if (m.startsWith('gpt-5-mini')) return 'healthia-5-mini';
  if (m.startsWith('gpt-5'))      return 'healthia-5-pro ecr';
  // GPT-4.1 familia
  if (m.startsWith('gpt-4.1-nano')) return 'healthia-4.1-nano';
  if (m.startsWith('gpt-4.1-mini')) return 'healthia-4.1-mini';
  if (m.startsWith('gpt-4.1'))      return 'healthia-4.1-pro';
  // Razonadores "o*"
  if (m.startsWith('o1') || m.startsWith('o3') || m.startsWith('o4')) return 'healthia-reasoner';
  return 'healthia';
}

async function loadOpenAIConfigAndPaint() {
  try {
    const base = await window.__API__.resolveApiBase();           // usa tu autodetector
    const cfg  = await fetch(`${base}/cfg`).then(r => r.json());  // backend lee Firestore
    const model = (cfg.model || 'gpt-4.1').trim();
    window.OPENAI_MODEL = model;                     // <- ahora api.js usar√° esto
    window.OPENAI_TEMPERATURE = cfg.temperature;    // opcional: √∫salo donde quieras

    // Actualiza el r√≥tulo en el UI (cambia el selector a tu HTML real)
    const el = document.querySelector('#model-label');
    if (el) el.textContent = `Modelo: ${brandName(model)}`;
  } catch (e) {
    console.warn('No pude cargar /api/cfg', e);
  }
}

document.addEventListener('DOMContentLoaded', loadOpenAIConfigAndPaint);
</script>

<script>
 (function() {
  const SUBSCRIBE_FALLBACK = '/subscribe';

  function getSubscribeUrl(){
    return (window.APP_CFG && window.APP_CFG.subscribe_url) || SUBSCRIBE_FALLBACK;
  }

  async function readPlanState() {
    const auth = window.firebaseAuth;
    const user = auth?.currentUser;
    const planTxt = document.getElementById('plan-state');
    const btn = document.getElementById('btn-toggle-sub');

    if (!user) {
      if (planTxt) planTxt.textContent = 'Inactivo';
      if (btn) {
        btn.style.display = 'inline-flex';
        btn.dataset.active = '0';
        btn.textContent = 'Comprar suscripci√≥n';
        btn.onclick = () => {
          if (window.triggerSubscription) {
            window.triggerSubscription();
          } else {
            window.location.href = getSubscribeUrl();
          }
        };
        btn.className = 'px-3 py-1.5 rounded-lg text-white bg-green-600 hover:bg-green-700 active:scale-[0.98] transition';
      }
      return;
    }

    let subActive = false;
    try {
      await user.getIdToken(true);
      const token = await user.getIdToken();
      const r = await fetch('/api/billing/status', { headers: { 'Authorization': `Bearer ${token}` } });
      if (r.ok) {
        const d = await r.json();
        subActive = !!d.subActive;
      } else {
        console.warn('status error', await r.text());
      }
    } catch (e) {
      console.error('readPlanState:', e);
    }

    if (planTxt) planTxt.textContent = subActive ? 'Activo' : 'Inactivo';
    if (btn) {
      btn.style.display = 'inline-flex';
      btn.dataset.active = subActive ? '1' : '0';
      if (subActive) {
        btn.textContent = 'Cancelar suscripci√≥n';
        btn.onclick = onCancel;
        btn.className = 'px-3 py-1.5 rounded-lg text-white bg-red-600 hover:bg-red-700 active:scale-[0.98] transition';
      } else {
        btn.textContent = 'Comprar suscripci√≥n';
        btn.onclick = () => {
          if (window.triggerSubscription) {
            window.triggerSubscription();
          } else {
            window.location.href = getSubscribeUrl();
          }
        };
        btn.className = 'px-3 py-1.5 rounded-lg text-white bg-green-600 hover:bg-green-700 active:scale-[0.98] transition';
      }
    }
  }

  async function onCancel() {
    const auth = window.firebaseAuth;
    const user = auth?.currentUser;
    if (!user) return alert('Inicia sesi√≥n');

    if (!confirm('¬øSeguro que deseas cancelar tu suscripci√≥n?')) return;

    const btn = document.getElementById('btn-toggle-sub');
    try {
      btn && (btn.disabled = true);
      const token = await user.getIdToken(true);
      const r = await fetch('/api/billing/cancel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ reason: 'user_cancel' })
      });
      if (!r.ok) throw new Error(await r.text());
      alert('Suscripci√≥n cancelada.');
    } catch (e) {
      console.error(e);
      alert('No se pudo cancelar: ' + (e?.message || e));
    } finally {
      if (btn) btn.disabled = false;
      readPlanState();
    }
  }

  function wire() {
    const auth = window.firebaseAuth;
    if (auth) {
      auth.onAuthStateChanged(() => readPlanState());
      readPlanState();
    }
  }

  document.addEventListener('DOMContentLoaded', wire);
 })();
</script>

<!-- Floating action buttons -->
<button id="h-float-gen" class="requires-subscription hidden fixed bottom-20 right-4 w-12 h-12 rounded-full bg-brand-600 text-white shadow-lg flex items-center justify-center text-xl hover:bg-brand-700 active:scale-95"><i class="fa-solid fa-notes-medical"></i></button>
<button id="h-float-ask" class="requires-subscription hidden fixed bottom-4 right-4 w-12 h-12 rounded-full bg-brand-600 text-white shadow-lg flex items-center justify-center text-xl hover:bg-brand-700 active:scale-95"><i class="fa-solid fa-circle-question"></i></button>

<div id="global-banner" class="hidden text-center text-white bg-yellow-500 py-2"></div>
<div id="maintenance-overlay" class="hidden fixed inset-0 z-[9999] grid place-items-center bg-black/60">
  <div class="bg-white p-6 rounded-xl shadow-soft max-w-md text-center">
    <h2 class="text-xl font-bold mb-2">üîß Mantenimiento</h2>
    <p id="maintenance-text" class="text-gray-700">Estamos trabajando, volvemos en breve.</p>
  </div>
</div>
</script>
<script type="module" src="/firebase-init.js"></script>
<script defer src="/subscription_gating.js?v=20250825-2"></script>





<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("dialog form").forEach(form => {
    form.addEventListener("close", () => {
      console.log("Dialog cerrado correctamente");
    });
    form.addEventListener("submit", (ev) => {
      if (ev.submitter?.value === "cancel") {
        ev.preventDefault(); // evita error
        form.closest("dialog").close("cancel");
      }
    });
  });
});
</script>
</body>
</html>



<!-- ===== FINAL FIX PATCH: de-duplicate resetAppUI, enforce remember behavior, and hard-clear on user switch ===== -->
<script>
(function(){
  function $(sel){ return document.querySelector(sel); }

  function getLastUid(){ try { return localStorage.getItem("healthia_uid") || ""; } catch { return ""; } }
  function setLastUid(uid){ try { localStorage.setItem("healthia_uid", uid || ""); } catch {} }

  async function _clearAllStores(){ try { if (window.clearAllStores) await window.clearAllStores(); } catch(e){ console.warn("[_clearAllStores]", e); } }

  // --- Single source of truth: resetAppUI ---
  window.resetAppUI = function(){
    try{
      // ids de estado global
      window.__pid = undefined;
      window.__hid = undefined;
      window.__pheight = null;
      window.__pfecha = null;

      // limpiar spans de la tarjeta del paciente
      [
        '#info-nombre','#info-edad','#info-sexo','#info-doc','#info-fecha','#info-nac',
        '#info-alergias','#info-tel','#info-dir','#info-ocup','#info-medfijos',
        '#info-ars','#info-religion','#info-sangre','#info-altura','#info-dxprev'
      ].forEach(s => { const el = document.querySelector(s); if (el) el.textContent = ''; });

      // limpiar avatar
      const av = document.querySelector('#info-avatar'); if (av) av.innerHTML = '';

      // limpiar historia actual (entrada/salida)
      const inTxt = document.querySelector('#h-actual'); if (inTxt) inTxt.value = '';
      const outBox = document.querySelector('#h-out'); if (outBox){ outBox.dataset.raw=''; outBox.innerHTML=''; outBox.textContent=''; }

      // limpiar inputs auxiliares de IA
      const ask = document.querySelector('#ask-input'); if (ask) ask.value='';
      const imgInput = document.querySelector('#img-input'); if (imgInput) imgInput.value='';

      // limpiar antecedentes e inputs (todos los campos conocidos)
      [
        '#ap-cig','#ap-alc','#ap-dro','#ap-cafe','#ap-te','#ap-cron','#ap-trans','#ap-traum','#ap-quir',
        '#ah-padre','#ah-madre','#ah-hijos','#ah-hermanos',
        '#go-gesta','#go-partos','#go-cesa','#go-aborto','#go-sono','#go-semana',
        '#v-pa','#v-fc','#v-fr','#v-gli','#v-col','#v-oxi','#v-temp','#v-peso','#v-imc','#v-imc-cat',
        '#antecedentes_personales','#antecedentes_familiares',
        '#presion_arterial','#frecuencia_cardiaca','#frecuencia_respiratoria','#temperatura','#saturacion_oxigeno'
      ].forEach(s => { const el = document.querySelector(s); if (el) el.value = ''; });
      const unit = document.querySelector('#v-unit'); if (unit) unit.value = 'kg';

      // recalcular IMC/semana y apagar sem√°foros
      try { window.weightUnit = 'kg'; window.updateIMC?.(); window.updateVitalsLights?.(); } catch {}

      // listas y tablas
      const tbody = document.querySelector('#tbl-patients'); if (tbody) tbody.innerHTML = '';
      const hlist = document.querySelector('#history-list'); if (hlist) hlist.innerHTML = '';
      const inv = document.querySelector('#invoice-list'); if (inv) inv.innerHTML = '';
      const ap = document.querySelector('#appointments-list'); if (ap) ap.innerHTML = '';

      // limpiar selecciones recordadas
      try {
        localStorage.removeItem('lastPatientId');
        localStorage.removeItem('lastHistoryId');
      } catch {}
    }catch(e){ console.error('[resetAppUI final]', e); }
  };

  // --- Hacer que "Recordar" funcione de verdad (guardar o borrar) ---
  (function patchLoginRemember(){
    const prev = window.doLogin;
    if (typeof prev === 'function'){
      window.doLogin = async function(...args){
        const res = await prev.apply(this, args);
        try {
          const remember = document.querySelector('#remember')?.checked;
          const u = document.querySelector('#auth-user')?.value?.trim();
          const p = document.querySelector('#auth-pass')?.value || '';
          if (remember && u && p){
            localStorage.setItem('remember', JSON.stringify({ u, p: btoa(p) }));
          } else {
            localStorage.removeItem('remember');
          }
        } catch(e){ console.warn('[remember patch]', e); }
        return res;
      };
    }

    // Salvaguarda si doLogin se redefine despu√©s: forzar limpieza al clic en "Entrar"
    document.addEventListener('click', function(e){
      if (e.target && e.target.id === 'login'){
        setTimeout(()=>{
          try{
            const remember = document.querySelector('#remember')?.checked;
            if (!remember) localStorage.removeItem('remember');
          }catch{}
        }, 0);
      }
    }, true);
  })();

  // --- Garantizar limpieza al cambiar de usuario ---
  if (window.onAuthStateChanged && window.firebaseAuth){
    window.onAuthStateChanged(window.firebaseAuth, async (user)=>{
      const prev = getLastUid();
      const cur  = user?.uid || '';
      if (prev && prev !== cur){
        await _clearAllStores();
        window.resetAppUI();
      }
      setLastUid(cur);
      if (user) {
        try{ await window.syncFromFirestore?.(); }catch{}
        await window.showApp?.();
      } else {
        window.showLogin?.();
      }
    });
  }

  // Limpieza adicional en recarga
  window.addEventListener('beforeunload', ()=>{ try{ window.resetAppUI(); }catch{} });
})();
</script>

